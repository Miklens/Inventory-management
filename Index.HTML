<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIKLENS Digital Requisition System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .portal-hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all;
        }

        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all;
        }

        .status-badge {
            @apply inline-block px-3 py-1 rounded-full text-xs font-bold;
        }

        .status-pending {
            @apply bg-yellow-100 text-yellow-800;
        }

        .status-approved {
            @apply bg-green-100 text-green-800;
        }

        .status-rejected {
            @apply bg-red-100 text-red-800;
        }

        .status-issued {
            @apply bg-blue-100 text-blue-800;
        }

        .status-completed {
            @apply bg-purple-100 text-purple-800;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Login Screen -->
    <div id="loginScreen"
        class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-gray-800">MIKLENS</h1>
                <p class="text-gray-500 mt-2">Digital Requisition System</p>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-5">
                <!-- Web App URL Field -->
                <div id="urlField">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        System URL <span class="text-xs text-gray-500">(one-time setup)</span>
                    </label>
                    <input type="url" id="scriptUrlInput"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                        placeholder="https://script.google.com/macros/s/.../exec">
                    <p class="text-xs text-gray-500 mt-1">Paste your Google Apps Script Web App URL</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="loginEmail" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="your.email@company.com">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" class="w-full btn-primary">
                    LOGIN
                </button>

                <p id="loginError" class="text-red-500 text-sm text-center hidden">Invalid credentials</p>
            </form>

            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Developer: Pavan.R | v1.0</p>
            </div>
        </div>
    </div>

    <!-- Main App Container (Hidden initially) -->
    <div id="appContainer" class="portal-hidden">

        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">MIKLENS Digital Requisition</h1>
                    <p class="text-sm text-gray-500" id="userWelcome">Welcome, User</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="refreshCurrentView()" id="refreshBtn"
                        class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-bold transition-all">
                        <svg id="refreshIcon" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <span>SYNC</span>
                    </button>
                    <span id="userRole"
                        class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold"></span>
                    <button type="button" onclick="openSettings(event)" id="settingsBtn"
                        class="text-gray-600 hover:text-gray-800" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800 font-semibold">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex gap-4" id="navTabs">
                    <!-- Dynamically populated based on role -->
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="contentArea">
                <!-- Dynamically loaded content -->
            </div>
        </main>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg m-4">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">‚öôÔ∏è</div>
                <h2 class="text-2xl font-bold text-gray-800">System Configuration</h2>
                <p class="text-gray-600 mt-2">Enter your Google Apps Script Web App URL</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Web App URL <span class="text-red-500">*</span>
                    </label>
                    <input type="url" id="configScriptUrl"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="https://script.google.com/macros/s/.../exec">
                    <p class="text-xs text-gray-500 mt-2">
                        üí° Get this URL by deploying the Google Apps Script as a Web App
                    </p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800 font-semibold mb-2">üìã Quick Guide:</p>
                    <ol class="text-xs text-blue-700 space-y-1 ml-4 list-decimal">
                        <li>Open your Google Sheet</li>
                        <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                        <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                        <li>Select <strong>Web app</strong></li>
                        <li>Click <strong>Deploy</strong></li>
                        <li>Copy the URL and paste it above</li>
                    </ol>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="testConfigUrl()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all">
                        üß™ Test Connection
                    </button>
                    <button type="button" onclick="saveConfig()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all">
                        üíæ Save & Continue
                    </button>
                </div>

                <p id="configError" class="text-red-500 text-sm text-center hidden mt-4"></p>
                <p id="configSuccess" class="text-green-500 text-sm text-center hidden mt-4"></p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" onclick="closeSettings()"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 portal-hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‚öôÔ∏è Settings</h2>
                <button type="button" id="settingsCloseBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Google Apps Script Web App URL</label>
                    <input type="text" id="settingsUrlInput"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="https://script.google.com/macros/s/.../exec">
                </div>

                <div class="text-xs text-gray-500 bg-blue-50 p-3 rounded-lg">
                    <p class="font-semibold mb-1">üí° When to update:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>After creating a new deployment</li>
                        <li>When switching to a different Google Sheet</li>
                        <li>If you get connection errors</li>
                    </ul>
                </div>

                <div class="flex gap-3">
                    <button type="button" id="settingsCancelBtn"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all">
                        Cancel
                    </button>
                    <button type="button" id="settingsSaveBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all">
                        üíæ Save & Close
                    </button>
                </div>

                <p id="settingsError" class="text-red-500 text-sm text-center hidden"></p>
                <p id="settingsSuccess" class="text-green-500 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Request Details Modal / Side Panel -->
    <div id="detailsModal"
        class="portal-modal portal-hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-end"
        style="display:none">
        <div class="bg-white h-full shadow-2xl w-full max-w-2xl transform transition-transform duration-300 translate-x-full flex flex-col"
            id="detailsPanel">
            <!-- Header -->
            <div class="flex justify-between items-center p-6 border-b bg-white z-10 flex-shrink-0">
                <div>
                    <h2 class="text-xl font-black text-gray-800" id="detailsTitle">Request Details</h2>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-0.5"
                        id="detailsSubtitle">Loading information...</p>
                </div>
                <button onclick="closeDetails()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div id="detailsContent" class="p-6 space-y-8 overflow-y-auto flex-1 custom-scrollbar">

                <!-- 1. Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <p class="text-[10px] font-black text-blue-400 uppercase mb-1">Target Quantity</p>
                        <p class="text-2xl font-black text-blue-900" id="detailsQty">0.000</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Current Station</p>
                        <p class="text-xs font-black text-gray-800 uppercase" id="detailsStation">N/A</p>
                    </div>
                </div>

                <!-- 2. Recipe Section -->
                <div id="detailsRecipeSection">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest">üìã Material Checklist
                        </h3>
                        <span id="detailsRecipeStatus"
                            class="text-[8px] font-black bg-gray-100 text-gray-500 px-2 py-0.5 rounded uppercase">Pending</span>
                    </div>
                    <div id="detailsRecipeContainer" class="space-y-2">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- 3. Corrections / Adjustments -->
                <div id="detailsCorrectionsSection" class="hidden">
                    <h3 class="font-black text-xs text-orange-400 uppercase tracking-widest mb-4">‚ö†Ô∏è Proposed Changes
                    </h3>
                    <div id="detailsCorrectionsContainer"
                        class="space-y-2 bg-orange-50 p-4 rounded-2xl border border-orange-100">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- 4. Audit Trail -->
                <div>
                    <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest mb-4">üìú Global Audit Log</h3>
                    <div id="detailsHistory" class="space-y-4">
                        <!-- Timeline items -->
                    </div>
                </div>

                <!-- 5. Interactions -->
                <div id="additionalRequestArea" class="bg-gray-50 p-6 rounded-2xl border border-gray-100 space-y-4">
                    <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest">üìù Communications</h3>

                    <div id="additionalMaterialInput" class="hidden">
                        <p class="text-[10px] font-black text-gray-500 mb-2 uppercase tracking-tight">Request Extra
                            Items</p>
                        <div class="flex flex-col gap-2">
                            <select id="addMaterialCategory"
                                class="w-full px-4 py-2 border rounded-xl text-[10px] font-black uppercase tracking-tight outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="RAW">üî¨ Raw Material / Chemical</option>
                                <option value="PACKING">üì¶ Packing Material</option>
                                <option value="LABEL">üè∑Ô∏è Label / Printing</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="text" id="addMaterialName" placeholder="Item Name"
                                    class="flex-1 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="number" id="addMaterialQty" placeholder="Qty"
                                    class="w-16 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="submitAddMaterial()"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-xs hover:bg-blue-700 transition-all shadow-md">Add</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <p class="text-[10px] font-black text-gray-500 mb-2 uppercase tracking-tight">Post
                            Instruction/Note</p>
                        <div class="flex gap-2">
                            <input type="text" id="threadNoteInput" placeholder="Message..."
                                class="flex-1 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="submitThreadNote()"
                                class="bg-gray-800 text-white px-4 py-2 rounded-xl font-black text-xs">Post</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions (Sticky at bottom) -->
            <div id="detailsActionsArea" class="p-6 border-t bg-white flex gap-3 flex-shrink-0">
                <!-- Filled dynamically by actor role and status -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let currentUser = null;
        let refreshTimer = null;
        let cachedFormData = null; // To cache products/materials
        let localCorrections = {}; // STORE UNSAVED CORRECTIONS
        let currentRequest = null; // TRACK CURRENT REQ FOR UI REFRESHES
        let SCRIPT_URL = ''; // Will be set from config

        // ==========================================
        // CONFIGURATION MANAGEMENT
        // ==========================================
        function loadConfig() {
            // Prefer requisition-specific URL; fallback to Main Inventory backend URL so one config works for both
            SCRIPT_URL = localStorage.getItem('DIGITAL_REQ_SCRIPT_URL') ||
                localStorage.getItem('GAS_URL') ||
                localStorage.getItem('inventoryCloudUrl') ||
                '';

            // Hide URL field if already configured
            const urlField = document.getElementById('urlField');
            if (SCRIPT_URL && urlField) {
                urlField.style.display = 'none';
            }
        }

        // ==========================================
        // LOGIN SYSTEM
        // ==========================================
        async function handleLogin(event) {
            event.preventDefault();

            // Check if URL needs to be saved (first time)
            const urlInput = document.getElementById('scriptUrlInput');
            if (urlInput && urlInput.value.trim()) {
                const newUrl = urlInput.value.trim();

                // Validate URL
                if (!newUrl.includes('script.google.com') || !newUrl.includes('/exec')) {
                    document.getElementById('loginError').textContent = 'Invalid Google Apps Script URL';
                    document.getElementById('loginError').classList.remove('hidden');
                    return;
                }

                // Save URL
                localStorage.setItem('DIGITAL_REQ_SCRIPT_URL', newUrl);
                SCRIPT_URL = newUrl;

                // Hide URL field for future logins
                urlInput.parentElement.style.display = 'none';
            }

            // Use saved URL if no new URL provided (include Main Inventory URL as fallback)
            if (!SCRIPT_URL) {
                SCRIPT_URL = localStorage.getItem('DIGITAL_REQ_SCRIPT_URL') ||
                    localStorage.getItem('GAS_URL') ||
                    localStorage.getItem('inventoryCloudUrl') || '';
                if (!SCRIPT_URL) {
                    document.getElementById('loginError').textContent = 'Please enter System URL';
                    document.getElementById('loginError').classList.remove('hidden');
                    return;
                }
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showToast('Logging in...', 'info');

            try {
                const response = await fetch(`${SCRIPT_URL}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();

                if (data.result === 'success') {
                    currentUser = data.user;
                    currentUser.role = normalizeRole(currentUser.role); // NORMALIZE GLOBALLY
                    localStorage.setItem('miklens_user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    document.getElementById('loginError').textContent = data.error || 'Invalid credentials';
                    document.getElementById('loginError').classList.remove('hidden');
                    showToast('Login failed', 'error');
                }
            } catch (error) {
                console.error(error);
                document.getElementById('loginError').textContent = 'Connection error. Check System URL.';
                document.getElementById('loginError').classList.remove('hidden');
                showToast('Connection error', 'error');
            }
        }

        function showApp() {
            // Hide login screen
            document.getElementById('loginScreen').classList.add('portal-hidden');
            document.getElementById('loginScreen').style.display = 'none';

            // Show app
            document.getElementById('appContainer').classList.remove('portal-hidden');
            document.getElementById('appContainer').style.display = 'block';

            // Clear any error messages
            document.getElementById('loginError').classList.add('hidden');

            // Set user info
            document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.name}`;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();

            initializePortal(currentUser.role);

            // Preload form data in background so Product Name dropdown is ready when user opens New Request
            loadFormDropdowns();
        }

        function logout() {
            localStorage.removeItem('miklens_user');
            currentUser = null;

            // Show login screen
            document.getElementById('loginScreen').classList.remove('portal-hidden');
            document.getElementById('loginScreen').style.display = 'block';

            // Hide app
            document.getElementById('appContainer').classList.add('portal-hidden');
            document.getElementById('appContainer').style.display = 'none';

            // Reset form
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        // ==========================================
        // SETTINGS MODAL
        // ==========================================
        function openSettings(e) {
            if (e) e.stopPropagation();
            const modal = document.getElementById('settingsModal');
            const urlInput = document.getElementById('settingsUrlInput');
            if (!modal) return;

            urlInput.value = SCRIPT_URL || '';
            document.getElementById('settingsError').classList.add('hidden');
            document.getElementById('settingsSuccess').classList.add('hidden');
            modal.classList.remove('portal-hidden');
            modal.style.display = 'flex';
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.add('portal-hidden');
                modal.style.display = 'none';
            }
        }

        async function testSettingsUrl() {
            const urlInput = document.getElementById('settingsUrlInput');
            const errorMsg = document.getElementById('settingsError');
            const successMsg = document.getElementById('settingsSuccess');
            const url = urlInput.value.trim();

            // Reset messages
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');

            if (!url) {
                errorMsg.textContent = 'Please enter a URL';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                errorMsg.textContent = 'Invalid Google Apps Script URL';
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(url + '?action=test_connection', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json().catch(() => ({}));
                const success = response.ok && (data.result === 'success' || data.status === 'Online');

                if (success) {
                    successMsg.textContent = '‚úÖ Connection successful!';
                    successMsg.classList.remove('hidden');
                } else {
                    errorMsg.textContent = (data && data.error) ? data.error : (response.ok ? 'Backend returned an error.' : 'Connection failed - check URL');
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Connection test failed';
                errorMsg.classList.remove('hidden');
            }
        }

        function saveSettingsUrl() {
            const urlInput = document.getElementById('settingsUrlInput');
            const errorMsg = document.getElementById('settingsError');
            const url = urlInput.value.trim();

            // Reset messages
            errorMsg.classList.add('hidden');

            if (!url) {
                errorMsg.textContent = 'Please enter a URL';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                errorMsg.textContent = 'Invalid Google Apps Script URL';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Save URL
            localStorage.setItem('DIGITAL_REQ_SCRIPT_URL', url);
            SCRIPT_URL = url;

            // Show success toast and close immediately
            showToast('Web App URL updated successfully!', 'success');
            closeSettings();
        }


        // ==========================================
        // PORTAL INITIALIZATION
        // ==========================================
        function initializePortal(rawRole) {
            const role = normalizeRole(rawRole); // Ensure "Store" works as "Store Incharge"
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';

            const portals = {
                'Store Incharge': [
                    { id: 'pending-issue', label: 'Pending Issue', icon: 'üì¶' },
                    { id: 'wip-management', label: 'WIP Monitor', icon: '‚öôÔ∏è' },
                    { id: 'issued-items', label: 'Issued Items', icon: '‚úÖ' }
                ],
                'Operator': [
                    { id: 'pending-record', label: 'Pending Recording', icon: 'üíæ' },
                    { id: 'wip-management', label: 'WIP Action', icon: 'üè≠' },
                    { id: 'dispatch-queue', label: 'Dispatch Queue', icon: 'üö¢' },
                    { id: 'master_archive', label: 'Master Archive', icon: 'üìÅ' }
                ],
                // Add to Employee if they are also producers?
                'Employee': [
                    { id: 'my-requests', label: 'My Requests', icon: 'üìã' },
                    { id: 'wip-management', label: 'Production Tasks', icon: 'üè≠' },
                    { id: 'new-request', label: 'New Request', icon: '‚ûï' },
                    { id: 'request-new-formula', label: 'Request New Formula', icon: 'üß™' }
                ],
                'Manager': [
                    { id: 'pending-approvals', label: 'Pending Approvals', icon: '‚è≥' },
                    { id: 'formula-requests', label: 'Formula Requests', icon: 'üß™' },
                    { id: 'wip-management', label: 'WIP Monitor', icon: '‚öôÔ∏è' },
                    { id: 'admin-control', label: 'System Control', icon: 'üõ†Ô∏è' },
                    { id: 'all-requests', label: 'Master Archive', icon: 'üìÅ' }
                ],
                'Admin': [
                    { id: 'pending-approvals', label: 'Pending Approvals', icon: '‚è≥' },
                    { id: 'formula-requests', label: 'Formula Requests', icon: 'üß™' },
                    { id: 'wip-management', label: 'WIP Monitor', icon: '‚öôÔ∏è' },
                    { id: 'admin-control', label: 'System Control', icon: 'üõ†Ô∏è' },
                    { id: 'all-requests', label: 'Master Archive', icon: 'üìÅ' }
                ]
            };

            const tabs = portals[role] || [];
            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = `px-6 py-4 text-sm font-semibold border-b-2 transition-colors ${index === 0 ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}`;
                button.innerHTML = `${tab.icon} ${tab.label}`;
                button.onclick = (e) => loadView(tab.id, role, e);
                navTabs.appendChild(button);
            });

            // Load first view
            if (tabs.length > 0) {
                loadView(tabs[0].id, role);
            }
        }

        // ROLE NORMALIZATION HELPER
        function normalizeRole(role) {
            if (!role) return role;
            const r = role.toLowerCase().trim();
            if (r === 'store' || r === 'storekeeper' || r === 'store incharge') return 'Store Incharge';
            return role;
        }

        // ==========================================
        // VIEW LOADING
        // ==========================================
        function loadView(viewId, role, clickEvent) {
            const contentArea = document.getElementById('contentArea');

            // Update active tab only if there's a click event
            if (clickEvent && clickEvent.target) {
                document.querySelectorAll('#navTabs button').forEach(btn => {
                    btn.className = btn.className.replace('border-blue-600 text-blue-600', 'border-transparent text-gray-600');
                });
                clickEvent.target.className += ' border-blue-600 text-blue-600';
            }

            // Load view content
            switch (viewId) {
                case 'my-requests':
                    renderMyRequests();
                    break;
                case 'new-request':
                    renderNewRequestForm();
                    break;
                case 'pending-approvals':
                    renderPendingApprovals();
                    break;
                case 'all-requests':
                    renderManagerHistory();
                    break;
                case 'pending-issue':
                    renderPendingIssue();
                    break;
                case 'pending-record':
                    renderPendingRecord();
                    break;
                case 'wip-management':
                    renderWIPManagement();
                    break;
                case 'dispatch-queue':
                    renderDispatchQueue();
                    break;
                case 'dispatch':
                    renderDispatchView();
                    break;
                case 'issued-items':
                    renderIssuedItems();
                    break;
                case 'master_archive':
                    renderMasterArchive();
                    break;
                case 'admin-control':
                    renderAdminControl();
                    break;
                case 'request-new-formula':
                    renderRequestNewFormula();
                    break;
                case 'formula-requests':
                    renderFormulaRequests();
                    break;
                default:
                    contentArea.innerHTML = `<div class="p-8 text-center"><p class="text-gray-500">View "${viewId}" pending implementation.</p></div>`;
            }
        }

        // ==========================================
        // EMPLOYEE VIEWS
        // ==========================================
        function renderMyRequests() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">My Requests</h2>
                        <button onclick="loadView('new-request')" class="btn-primary">
                            ‚ûï New Request
                        </button>
                    </div>
                    
                    <div class="space-y-4" id="requestsList">
                        <div class="text-center py-12 text-gray-400">
                            Loading requests...
                        </div>
                    </div>
                </div>
            `;

            loadMyRequests();
        }

        async function loadMyRequests() {
            if (!currentUser || !currentUser.email) return;

            // Wait briefly for DOM to settle if called immediately after render
            await new Promise(r => setTimeout(r, 50));
            const listContainer = document.getElementById('requestsList');
            if (!listContainer) return;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_my_requests&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();

                if (data.requests && data.requests.length > 0) {
                    listContainer.innerHTML = data.requests.map(req => {
                        const isApproved = ['APPROVED', 'APPROVE_REQUEST', 'ISSUED', 'RECORDED', 'PRODUCED', 'DISPATCHED'].includes(req.status);
                        const isCorrection = req.status === 'CORRECTION_REQUIRED';
                        const isRejected = ['REJECTED', 'REJECTED_BY_MANAGER', 'REJECT_REQUEST'].includes(req.status);

                        const statusStyle = isApproved ? 'bg-green-100 text-green-700' :
                            isRejected ? 'bg-red-100 text-red-700' :
                                isCorrection ? 'bg-orange-100 text-orange-700' :
                                    'bg-yellow-100 text-yellow-700';

                        return `
                            <div onclick="viewRequestDetails('${req.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group">
                                <div class="flex justify-between items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[8px] font-black bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded uppercase">${req.id}</span>
                                            <span class="text-[8px] font-black bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded uppercase">${req.type}</span>
                                            <span class="${statusStyle} text-[8px] font-black px-1.5 py-0.5 rounded uppercase">${isApproved ? 'APPROVED' : (isRejected ? 'REJECTED' : (isCorrection ? 'CORRECTION' : req.status))}</span>
                                        </div>
                                        <h3 class="font-black text-gray-900 truncate leading-tight text-base group-hover:text-blue-600 transition-colors">${req.productName}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-[8px] font-black uppercase text-gray-400">At Station:</span>
                                            <span class="text-[8px] font-black px-1.5 py-0.5 rounded border ${getStageColor(isApproved && req.currentStage.includes('MANAGER APPROVAL') ? 'Awaiting Employee Confirmation' : req.currentStage)} uppercase tracking-tighter">${isApproved && req.currentStage.includes('MANAGER APPROVAL') ? 'Awaiting Employee Confirmation' : req.currentStage}</span>
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end">
                                        <p class="text-lg font-black text-gray-800 leading-none">${req.quantity}</p>
                                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mt-1">${req.unit || 'Units'}</p>
                                        <div class="mt-2 text-blue-500 font-black text-[9px] uppercase tracking-tighter">View Details ‚Üí</div>
                                    </div>
                                </div>
                                
                                ${req.currentStage.toUpperCase() === 'WIP' ? `
                                <div class="mt-3 pt-3 border-t flex gap-2 overflow-x-auto no-scrollbar" onclick="event.stopPropagation()">
                                    <button onclick="triggerWIPAction('${req.id}', 'PAUSE')" class="flex-1 min-w-[60px] bg-orange-50 text-orange-600 font-black py-2 rounded-lg uppercase text-[9px] border border-orange-100 hover:bg-orange-100 transition-all">‚è∏Ô∏è Pause</button>
                                    <button onclick="triggerWIPAction('${req.id}', 'COMPLETE')" class="flex-1 min-w-[60px] bg-green-50 text-green-600 font-black py-2 rounded-lg uppercase text-[9px] border border-green-100 hover:bg-green-100 transition-all">‚úÖ Complete</button>
                                    <button onclick="triggerWIPAction('${req.id}', 'CANCEL')" class="flex-1 min-w-[60px] bg-red-50 text-red-600 font-black py-2 rounded-lg uppercase text-[9px] border border-red-100 hover:bg-red-100 transition-all">‚ùå Cancel</button>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
                else {
                    listContainer.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <p class="text-lg mb-4">No requests yet</p>
                            <button onclick="loadView('new-request')" class="btn-primary">Create Your First Request</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
                showToast('Failed to load requests', 'error');
            }
        }

        function renderNewRequestForm() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">New Request</h2>
                    
                    <!-- Request Type Selection -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Request Type</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="selectRequestType('production')" id="btn-type-production"
                                    class="p-6 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                                <div class="text-4xl mb-2">üè≠</div>
                                <div class="font-bold text-gray-800">Production</div>
                                <div class="text-xs text-gray-600 mt-1">For manufacturing products</div>
                            </button>
                            <button onclick="selectRequestType('research')" id="btn-type-research"
                                    class="p-6 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors">
                                <div class="text-4xl mb-2">üî¨</div>
                                <div class="font-bold text-gray-800">Research</div>
                                <div class="text-xs text-gray-600 mt-1">For R&D and trials</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Production Form -->
                    <div id="productionForm" class="bg-white rounded-lg shadow p-6">
                        <form onsubmit="submitProductionRequest(event)" class="space-y-6">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-bold text-gray-700">Product Name</label>
                                    <button type="button" onclick="loadFormDropdowns()" class="text-xs text-blue-600 hover:text-blue-800 font-semibold">Retry load</button>
                                </div>
                                <select id="productSelect" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select product...</option>
                                    <!-- Populated from formulas sheet -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Quantity to Produce</label>
                                <div class="flex gap-4">
                                    <input type="number" id="prodQuantity" required step="0.01" 
                                           class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="1000">
                                    <input type="text" id="prodUnit" readonly 
                                           class="w-24 px-4 py-3 border rounded-lg bg-gray-100"
                                           placeholder="L">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Purpose / Batch ID</label>
                                <input type="text" id="prodPurpose" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Batch-B-205">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Target Date</label>
                                <input type="date" id="prodTargetDate" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Removed manual manager selection -->
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Remarks (Optional)</label>
                                <textarea id="prodRemarks" rows="3"
                                          class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="Any special instructions..."></textarea>
                            </div>
                            
                            <div class="flex gap-4">
                                <button type="button" onclick="loadView('my-requests')" class="btn-secondary flex-1">
                                    Cancel
                                </button>
                                <button type="submit" class="btn-primary flex-1">
                                    Submit for Approval
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Research Form (MULTI-ITEM ENHANCED) -->
                    <div id="researchForm" class="bg-white rounded-lg shadow p-6 hidden">
                        <form onsubmit="submitResearchRequest(event)" class="space-y-6">
                            
                            <!-- Category Selector Tabs -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-3">Select Material Categories</label>
                                <div class="grid grid-cols-3 gap-3" id="categoryTabs">
                                    <button type="button" onclick="toggleCategory('raw')" id="tab-raw"
                                        class="category-tab p-4 border-2 border-gray-300 rounded-lg hover:border-blue-400 transition-colors text-center">
                                        <div class="text-2xl mb-1">üß™</div>
                                        <div class="text-xs font-bold text-gray-700">Raw Materials</div>
                                    </button>
                                    <button type="button" onclick="toggleCategory('packing')" id="tab-packing"
                                        class="category-tab p-4 border-2 border-gray-300 rounded-lg hover:border-blue-400 transition-colors text-center">
                                        <div class="text-2xl mb-1">üì¶</div>
                                        <div class="text-xs font-bold text-gray-700">Packing Materials</div>
                                    </button>
                                    <button type="button" onclick="toggleCategory('labels')" id="tab-labels"
                                        class="category-tab p-4 border-2 border-gray-300 rounded-lg hover:border-blue-400 transition-colors text-center">
                                        <div class="text-2xl mb-1">üè∑Ô∏è</div>
                                        <div class="text-xs font-bold text-gray-700">Labels</div>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">üí° Select one or more categories to add items from</p>
                            </div>

                            <!-- Multi-Item Entry Section -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-sm font-bold text-gray-700">Items Required</label>
                                    <span class="text-xs text-gray-500" id="itemCount">0 items</span>
                                </div>

                                <!-- Item Rows Container -->
                                <div id="itemRowsContainer" class="space-y-3">
                                    <!-- Dynamic rows will be inserted here -->
                                </div>

                                <!-- Add More Items Button -->
                                <button type="button" onclick="addItemRow()" 
                                    class="mt-3 w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-400 hover:text-blue-600 font-semibold text-sm transition-colors">
                                    ‚ûï Add More Items
                                </button>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Trial / Project Name</label>
                                <input type="text" id="resPurpose" required
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Herbicide Trial A">
                            </div>
                            
                            <!-- Removed manual manager selection -->
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Remarks (Optional)</label>
                                <textarea id="resRemarks" rows="3"
                                          class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="Purpose of R&D use..."></textarea>
                            </div>
                            
                            <div class="flex gap-4">
                                <button type="button" onclick="loadView('my-requests')" class="btn-secondary flex-1">
                                    Cancel
                                </button>
                                <button type="submit" class="btn-primary flex-1">
                                    Submit Research Request
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            loadFormDropdowns();
        }

        // ==========================================
        // EMPLOYEE FORM HELPERS
        // ==========================================
        function selectRequestType(type) {
            if (type === 'production') {
                document.getElementById('productionForm').classList.remove('hidden');
                document.getElementById('researchForm').classList.add('hidden');

                // Update button styles
                document.getElementById('btn-type-production').className = 'p-6 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors';
                document.getElementById('btn-type-research').className = 'p-6 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors';
            } else {
                document.getElementById('productionForm').classList.add('hidden');
                document.getElementById('researchForm').classList.remove('hidden');

                // Update button styles
                document.getElementById('btn-type-production').className = 'p-6 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors';
                document.getElementById('btn-type-research').className = 'p-6 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors';

                // Initialize research form with default rows
                setTimeout(() => initializeResearchForm(), 100);
            }
        }

        const FORM_DATA_CACHE_KEY = 'MIKLENS_REQ_FORM_DATA';
        const FORM_DATA_CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

        function getFormDataFromStorage() {
            try {
                const raw = localStorage.getItem(FORM_DATA_CACHE_KEY);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                if (!obj || !obj.data || !obj.ts) return null;
                if (Date.now() - obj.ts > FORM_DATA_CACHE_TTL_MS) return null;
                return obj.data;
            } catch (e) { return null; }
        }

        function setFormDataInStorage(data) {
            try {
                localStorage.setItem(FORM_DATA_CACHE_KEY, JSON.stringify({ data: data, ts: Date.now() }));
            } catch (e) {}
        }

        async function loadFormDropdowns() {
            const productSelect = document.getElementById('productSelect');
            const materialSelect = document.getElementById('materialSelect');

            if (productSelect) {
                productSelect.innerHTML = '<option value="">Loading products...</option>';
                productSelect.disabled = true;
            }
            if (materialSelect) {
                materialSelect.innerHTML = '<option value="">Loading materials...</option>';
                materialSelect.disabled = true;
            }

            // Optional: show last-known data while fetching. Server response overwrites (single source of truth).
            const stored = getFormDataFromStorage();
            if (stored && (stored.products?.length || stored.materials?.length)) {
                if (productSelect) productSelect.disabled = false;
                if (materialSelect) materialSelect.disabled = false;
                populateDropdowns(stored);
            }

            const FETCH_TIMEOUT_MS = 20000;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

            function applyFormData(data) {
                if (!data || data.result !== 'success') return false;
                const payload = data.data ? {
                    result: 'success',
                    products: data.data.products || [],
                    materials: data.data.materials || [],
                    rawMaterials: data.data.rawMaterials || [],
                    packingMaterials: data.data.packingMaterials || [],
                    labels: data.data.labels || []
                } : data;
                if (!payload.products && !payload.materials) return false;
                cachedFormData = payload;
                setFormDataInStorage(payload);
                if (productSelect) productSelect.disabled = false;
                if (materialSelect) materialSelect.disabled = false;
                populateDropdowns(payload);
                return true;
            }

            try {
                // 1) Same call as old requisition app ‚Äì get_lists (Data sheet + FormCache). Fast and reliable.
                const response = await fetch(`${SCRIPT_URL}?action=get_lists&_t=${Date.now()}`, {
                    signal: controller.signal,
                    redirect: 'follow'
                });
                clearTimeout(timeoutId);
                const data = await response.json().catch(() => ({}));
                if (applyFormData(data)) return;

                // 2) Fallback: get_form_data (builds from Database if FormCache empty)
                const fallbackResp = await fetch(`${SCRIPT_URL}?action=get_form_data&_t=${Date.now()}`, {
                    redirect: 'follow'
                });
                const fallbackData = await fallbackResp.json().catch(() => ({}));
                if (applyFormData(fallbackData)) return;

                if (productSelect) {
                    productSelect.disabled = false;
                    productSelect.innerHTML = '<option value="">Select product...</option><option value="">No data ‚Äì run seedFormCacheFromDatabase in Apps Script once</option>';
                }
                if (materialSelect) materialSelect.disabled = false;
                showToast('No products from server. Run seedFormCacheFromDatabase in Apps Script once.', 'warning');
            } catch (error) {
                clearTimeout(timeoutId);
                const isTimeout = error && error.name === 'AbortError';
                if (productSelect) {
                    productSelect.disabled = false;
                    productSelect.innerHTML = '<option value="">Select product...</option><option value="">' + (isTimeout ? 'Timed out. Click Retry load.' : 'Load failed. Check Web App URL.') + '</option>';
                }
                if (materialSelect) {
                    materialSelect.disabled = false;
                    materialSelect.innerHTML = '<option value="">Select material...</option>';
                }
                showToast(isTimeout ? 'Timed out. Click Retry load.' : 'Load failed. Check Web App URL in Settings.', 'error');
                console.error('Form data fetch failed:', error);
            }
        }

        // Helper to handle the actual DOM manipulation
        function populateDropdowns(data) {
            // 1. Populate product dropdown (Production)
            const productSelect = document.getElementById('productSelect');
            if (productSelect && data.products && data.products.length > 0) {
                productSelect.innerHTML = '<option value="">Select product...</option>';
                data.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    option.dataset.unit = product.unit || 'L';
                    productSelect.appendChild(option);
                });

                productSelect.onchange = function () {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.unit) {
                        document.getElementById('prodUnit').value = selectedOption.dataset.unit;
                    }
                };
                console.log(`‚úÖ Populated ${data.products.length} products`);
            }

            // 2. Populate material dropdown (Research)
            const materialSelect = document.getElementById('materialSelect');
            if (materialSelect && data.materials && data.materials.length > 0) {
                materialSelect.innerHTML = '<option value="">Select material...</option>';
                data.materials.forEach(mat => {
                    const option = document.createElement('option');
                    option.value = mat.name;
                    option.textContent = `[${mat.category.charAt(0).toUpperCase()}] ${mat.name}`;
                    option.dataset.unit = mat.unit || 'Kg';
                    materialSelect.appendChild(option);
                });

                materialSelect.onchange = function () {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.unit) {
                        document.getElementById('resUnit').value = selectedOption.dataset.unit;
                    }
                };
                console.log(`‚úÖ Populated ${data.materials.length} materials`);
            }
        }

        async function submitProductionRequest(event) {
            event.preventDefault();
            const btn = event.submitter || event.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></span>Submitting...'; }

            const requestData = {
                action: 'create_request',
                type: 'production',
                requesterEmail: currentUser.email,
                requesterName: currentUser.name,
                productName: document.getElementById('productSelect').value,
                quantity: document.getElementById('prodQuantity').value,
                unit: document.getElementById('prodUnit').value,
                purpose: document.getElementById('prodPurpose').value,
                targetDate: document.getElementById('prodTargetDate').value,
                remarks: document.getElementById('prodRemarks').value
            };

            showToast('Submitting request...', 'info');

            try {
                const response = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(requestData));
                const data = await response.json();

                if (data.result === 'success') {
                    showToast('Request submitted successfully!', 'success');
                    loadView('my-requests', 'Employee');
                } else {
                    showToast('Failed to submit request: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('Connection error. Please try again.', 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = 'Submit Request'; }
            }
        }

        // ==========================================
        // MULTI-ITEM FORM MANAGEMENT
        // ==========================================

        let selectedCategories = new Set();
        let itemRowCounter = 0;

        function toggleCategory(category) {
            const tab = document.getElementById(`tab-${category}`);

            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
                tab.classList.remove('border-blue-500', 'bg-blue-50');
                tab.classList.add('border-gray-300');
            } else {
                selectedCategories.add(category);
                tab.classList.remove('border-gray-300');
                tab.classList.add('border-blue-500', 'bg-blue-50');
            }


            // Refresh all existing dropdowns to show items from currently selected categories
            const rows = document.querySelectorAll('.item-row');
            const categoriesToShow = Array.from(selectedCategories);

            if (categoriesToShow.length === 0) {
                // Clear all rows if no categories selected
                document.getElementById('itemRowsContainer').innerHTML = '';
                updateItemCount();
            } else {
                // Update all dropdowns to match new category selection
                rows.forEach(row => {
                    const select = row.querySelector('.item-select');
                    if (select) {
                        const currentValue = select.value;
                        populateItemDropdown(select, categoriesToShow);
                        // Try to restore selection if still valid
                        if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                            select.value = currentValue;
                        }
                    }
                });
            }
        }

        function addItemRow(category = null) {
            const container = document.getElementById('itemRowsContainer');
            if (!container) return;

            const rowId = `item-row-${++itemRowCounter}`;

            // Determine which categories to show in dropdown
            const categoriesToShow = category ? [category] : Array.from(selectedCategories);
            if (categoriesToShow.length === 0 && !category) {
                showToast('Please select at least one category first', 'warning');
                return;
            }

            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'item-row flex gap-2 items-start p-3 bg-gray-50 rounded-lg border border-gray-200';
            row.innerHTML = `
                <div class="flex-1 grid grid-cols-12 gap-2">
                    <div class="col-span-5">
                        <select class="item-select w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                                onchange="updateItemUnit(this, '${rowId}')">
                            <option value="">Select item...</option>
                        </select>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="item-quantity w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                               placeholder="Qty" step="0.01" min="0">
                    </div>
                    <div class="col-span-3">
                        <input type="text" class="item-unit w-full px-3 py-2 border rounded-lg text-sm bg-gray-100" 
                               placeholder="Unit" readonly>
                    </div>
                    <div class="col-span-1 flex items-center">
                        <button type="button" onclick="removeItemRow('${rowId}')" 
                                class="text-red-500 hover:text-red-700 font-bold text-lg px-2">
                            ‚úï
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(row);

            // Populate the dropdown with materials from selected/specified categories
            populateItemDropdown(row.querySelector('.item-select'), categoriesToShow);
            updateItemCount();
        }

        function populateItemDropdown(selectElement, categories) {
            if (!cachedFormData || !cachedFormData.materials) return;

            selectElement.innerHTML = '<option value="">Select item...</option>';

            cachedFormData.materials.forEach(mat => {
                // Map category names
                const matCategory = mat.category.toLowerCase();
                const matchesCategory = categories.some(cat => {
                    if (cat === 'raw' && (matCategory.includes('raw') || matCategory.includes('chemical'))) return true;
                    if (cat === 'packing' && matCategory.includes('packing')) return true;
                    if (cat === 'labels' && matCategory.includes('label')) return true;
                    return false;
                });

                if (matchesCategory) {
                    const option = document.createElement('option');
                    option.value = mat.name;
                    option.textContent = `${mat.name}`;
                    option.dataset.unit = mat.unit || 'Kg';
                    option.dataset.category = mat.category;
                    selectElement.appendChild(option);
                }
            });
        }

        function updateItemUnit(selectElement, rowId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const row = document.getElementById(rowId);
            if (row && selectedOption.dataset.unit) {
                row.querySelector('.item-unit').value = selectedOption.dataset.unit;
            }
        }

        function removeItemRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateItemCount();
            }
        }

        function updateItemCount() {
            const container = document.getElementById('itemRowsContainer');
            const countDisplay = document.getElementById('itemCount');
            if (container && countDisplay) {
                const rows = container.querySelectorAll('.item-row');
                countDisplay.textContent = `${rows.length} items`;
            }
        }

        function collectItemsData() {
            const rows = document.querySelectorAll('.item-row');
            const items = [];

            rows.forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = row.querySelector('.item-quantity').value;
                const unit = row.querySelector('.item-unit').value;

                if (select.value && quantity && parseFloat(quantity) > 0) {
                    const selectedOption = select.options[select.selectedIndex];
                    items.push({
                        name: select.value,
                        category: selectedOption.dataset.category || 'Raw Materials',
                        quantity: parseFloat(quantity),
                        unit: unit || 'Kg'
                    });
                }
            });

            return items;
        }

        // Initialize form with default rows when Research is selected
        function initializeResearchForm() {
            // Auto-select all categories by default
            selectedCategories = new Set(['raw', 'packing', 'labels']);
            ['raw', 'packing', 'labels'].forEach(cat => {
                const tab = document.getElementById(`tab-${cat}`);
                if (tab) {
                    tab.classList.remove('border-gray-300');
                    tab.classList.add('border-blue-500', 'bg-blue-50');
                }
            });

            // Add 5 default rows
            const container = document.getElementById('itemRowsContainer');
            if (container) {
                container.innerHTML = ''; // Clear any existing
                for (let i = 0; i < 5; i++) {
                    addItemRow('raw'); // Default to raw materials
                }
            }
        }

        async function submitResearchRequest(event) {
            event.preventDefault();
            const btn = event.submitter || event.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></span>Submitting...'; }

            // Collect all items
            const items = collectItemsData();

            // Validation: must have at least one item
            if (items.length === 0) {
                showToast('Please add at least one item with quantity', 'error');
                if (btn) { btn.disabled = false; btn.innerText = 'Submit Request'; }
                return;
            }

            const requestData = {
                action: 'create_request',
                type: 'research',
                requesterEmail: currentUser.email,
                requesterName: currentUser.name,
                items: JSON.stringify(items), // Send as JSON string
                purpose: document.getElementById('resPurpose').value,
                remarks: document.getElementById('resRemarks').value
            };

            showToast('Submitting research request...', 'info');

            try {
                const response = await fetch(`${SCRIPT_URL}?` + new URLSearchParams(requestData));
                const data = await response.json();
                if (data.result === 'success') {
                    showToast(`Research request submitted with ${items.length} items!`, 'success');
                    loadView('my-requests', 'Employee');
                } else {
                    showToast('Failed: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('Connection error', 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = 'Submit Request'; }
            }
        }

        // ==========================================
        // UI HELPERS & COLOR CODING
        // ==========================================
        function getStageColor(stage = '') {
            const s = stage.toUpperCase();
            if (s.includes('COMPLETED')) return 'bg-green-100 text-green-700 border-green-200';
            if (s.includes('/ WIP')) return 'bg-indigo-100 text-indigo-700 border-indigo-200';
            if (s.includes('MANAGER')) return 'bg-purple-100 text-purple-700 border-purple-200';
            if (s.includes('EMPLOYEE')) return 'bg-blue-100 text-blue-700 border-blue-200';
            if (s.includes('MATERIAL') || s.includes('ISSUE')) return 'bg-orange-100 text-orange-700 border-orange-200';
            if (s.includes('MANUFACTURING') || s.includes('WIP')) return 'bg-indigo-100 text-indigo-700 border-indigo-200';
            if (s.includes('DISPATCH')) return 'bg-pink-100 text-pink-700 border-pink-200';
            if (s.includes('RECORDING')) return 'bg-green-100 text-green-700 border-green-200';
            return 'bg-gray-100 text-gray-500 border-gray-200';
        }

        function getStatusStyle(status = '') {
            const s = status.toUpperCase();
            if (s === 'APPROVED' || s === 'PRODUCED') return 'bg-green-100 text-green-700';
            if (s.includes('REJECTED')) return 'bg-red-100 text-red-700';
            if (s.includes('CORRECTION')) return 'bg-orange-100 text-orange-700';
            return 'bg-blue-100 text-blue-700';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };

            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg fade-in`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ==========================================
        // OPERATOR PORTAL VIEWS
        // ==========================================
        // ==========================================
        // OPERATOR PORTAL VIEWS (Obsolete - Auto-Managed)
        // ==========================================
        // Functions removed for Phase 7 Automation


        function renderDispatchQueue() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üö¢ Dispatch Queue</h2>
                    <div class="space-y-4" id="dispatchList">
                        <div class="text-center py-12 text-gray-400">Loading ready items...</div>
                    </div>
                </div>
            `;
            loadStageRequests('DISPATCH', 'dispatchList');
        }

        function renderPendingIssue() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üì¶ Pending Material Issue</h2>
                    <div class="space-y-4" id="issueList">
                        <div class="text-center py-12 text-gray-400">Loading requisitions...</div>
                    </div>
                </div>
            `;
            loadStageRequests('PENDING_ISSUE', 'issueList');
        }

        function renderWIPManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Production in Progress (WIP)</h2>
                    <p class="text-sm text-gray-500 mb-4">Items issued to floor. Valid reasons required for all actions.</p>
                    <div class="space-y-4" id="wipList">
                        <div class="text-center py-12 text-gray-400">Loading WIP batches...</div>
                    </div>
                </div>
            `;
            loadStageRequests('WIP', 'wipList');
        }

        function renderIssuedItems() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚úÖ Issued Items History</h2>
                    <div class="space-y-4" id="issuedHistoryList">
                        <div class="text-center py-12 text-gray-400">Loading history...</div>
                    </div>
                </div>
            `;
            loadStageRequests('ISSUED_HISTORY', 'issuedHistoryList');
        }

        // Pagination State
        let stagePagination = {};

        async function loadStageRequests(stage, containerId, append = false) {
            const LIMIT = 20;
            if (!append) {
                stagePagination[stage] = 1;
            }
            const page = stagePagination[stage] || 1;

            const container = document.getElementById(containerId);
            if (!container) return;

            // If not appending, show loading only if first load
            if (!append) {
                // container.innerHTML = ... (managed below)
            } else {
                // Show small spinner at bottom?
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_requests_by_stage&stage=${stage}&page=${page}&limit=${LIMIT}`);
                const data = await response.json();

                // Remove existing "Load More" button if any
                const existingBtn = document.getElementById(`btn-load-more-${stage}`);
                if (existingBtn) existingBtn.remove();

                if (data.requests && data.requests.length > 0) {
                    const html = data.requests.map(req => {
                        return `
                            <div onclick="viewRequestDetails('${req.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group fade-in mb-3">
                                <div class="flex justify-between items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[8px] font-black bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded uppercase">${req.type}</span>
                                            <span class="text-[8px] font-black bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${req.id}</span>
                                            <span class="text-[8px] font-black bg-gray-50 text-gray-400 px-1.5 py-0.5 rounded border uppercase">${req.status}</span>
                                        </div>
                                        <h3 class="font-black text-gray-800 truncate text-base group-hover:text-blue-600 transition-colors leading-tight">${req.productName}</h3>
                                        <div class="flex items-center gap-3 mt-1.5">
                                            <p class="text-[9px] text-gray-400 font-black uppercase">Staff: <span class="text-gray-600">${req.requesterName}</span></p>
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end">
                                        <p class="text-lg font-black text-blue-700 leading-none">${req.quantity}</p>
                                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mt-1">${req.unit || 'Units'}</p>
                                        <div class="mt-2 text-blue-500 font-black text-[9px] uppercase tracking-tighter">Open Process ‚Üí</div>
                                    </div>
                                </div>
                                
                                ${stage === 'WIP' ? `
                                <div class="mt-3 pt-3 border-t">
                                    <div class="bg-blue-50 text-blue-800 text-[10px] font-bold px-3 py-2 rounded flex items-center gap-2">
                                        <span class="animate-pulse">‚öôÔ∏è</span>
                                        Production in Progress (Auto-Tracking)
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');

                    if (!append) {
                        container.innerHTML = html;
                    } else {
                        container.insertAdjacentHTML('beforeend', html);
                    }

                    // Check if we need a Load More button
                    if (data.requests.length === LIMIT) {
                        const btnId = `btn-load-more-${stage}`;
                        const btnHtml = `
                            <div id="${btnId}" class="text-center pt-4 pb-2">
                                <button onclick="stagePagination['${stage}']++; loadStageRequests('${stage}', '${containerId}', true)" 
                                        class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-colors">
                                    Load More
                                </button>
                            </div>
                         `;
                        container.insertAdjacentHTML('beforeend', btnHtml);
                    }

                } else {
                    if (!append) {
                        container.innerHTML = `<div class="text-center py-12 bg-gray-50 rounded italic text-gray-500">No items currently in ${stage.replace('_', ' ')} queue</div>`;
                    } else {
                        // End of list, maybe show a "No more items" message?
                        // For now, just nothing.
                    }
                }
            } catch (err) {
                console.error(`‚ùå loadStageRequests ERROR [Stage: ${stage}]:`, err);
                if (!append) showToast(`Failed to load ${stage} data. Check internet or settings.`, 'error');
            }
        }

        async function handleStageAction(id, action) {
            showToast('Processing...', 'info');
            try {
                // SUPPORT FOR INDUSTRIAL SYNC (Phase 14)
                let extraParams = '';
                if (action === 'PARTIAL_ISSUE') {
                    const partialQty = prompt('Enter the ACTUAL quantity physically issued (Partial):');
                    if (!partialQty || isNaN(partialQty) || parseFloat(partialQty) <= 0) {
                        showToast('Invalid quantity. Action cancelled.', 'warning');
                        return;
                    }
                    extraParams = `&partialQty=${partialQty}`;
                }

                // SECURITY UPDATE: Pass email for role verification
                const url = `${SCRIPT_URL}?action=update_request_stage&id=${id}&stageAction=${action}&user=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}${extraParams}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.result === 'success') {
                    if (action === 'ISSUE' || action === 'PARTIAL_ISSUE') {
                        if (data.newStatus === 'COMPLETED') {
                            showToast('‚úÖ Auto-Process Complete! Items issued & consumed. Request finished.', 'success');
                        } else {
                            showToast('‚úÖ Items Issued. Status: ' + (data.newStatus || 'PARTIALLY_ISSUED'), 'success');
                        }
                    } else {
                        showToast('Action successful!', 'success');
                    }
                    closeDetails(); // Close the detail panel
                    initializePortal(currentUser.role); // Refresh current portal
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Network error', 'error');
            }
        }

        async function confirmFormula(id) {
            showToast('Confirming...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=confirm_formula&id=${id}&user=${encodeURIComponent(currentUser.name)}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('Formula Confirmed!', 'success');
                    closeDetails();
                    refreshCurrentView();
                } else {
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Sync failed', 'error');
            }
        }

        async function triggerWIPAction(reqId, action) {
            const labels = { 'PAUSE': 'pause', 'COMPLETE': 'complete', 'CANCEL': 'cancel' };
            const verb = labels[action] || action.toLowerCase();

            // 1. Confirm Action (Exact wording requested by user)
            if (!confirm('Are you sure about this action?')) return;

            // 2. Mandatory Reason
            let reason = prompt(`Please provide a reason for ${verb.toUpperCase()} (Required):`);
            if (!reason || reason.trim() === '') {
                showToast('Action cancelled: Reason is mandatory.', 'warning');
                return;
            }

            // 3. Actual Yield & Ingredient usage (Industrial Sync Phase 14)
            let actualYield = '';
            let consumptionMap = null;
            if (action === 'COMPLETE') {
                actualYield = prompt('Enter ACTUAL produced quantity (Yield):');
                if (!actualYield || isNaN(actualYield) || parseFloat(actualYield) <= 0) {
                    showToast('Action cancelled: Actual yield is required.', 'warning');
                    return;
                }

                // Collect per-ingredient actual usage (from inputs in renderIngredients)
                consumptionMap = {};
                document.querySelectorAll('.actual-usage-input').forEach(input => {
                    const key = input.getAttribute('data-item-key');
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) consumptionMap[key] = val;
                });
                console.log('[IndustrialSync] Consumption Map:', consumptionMap);
            }

            showToast(`Processing ${verb}...`, 'info');
            try {
                // SECURITY UPDATE: Pass email for role verification
                // Call NEW backend handler: handleWIPActionRequisition (action=wip_action_req)
                let url = `${SCRIPT_URL}?action=wip_action_req&id=${reqId}&wipAction=${action}&user=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}&reason=${encodeURIComponent(reason)}`;
                if (actualYield) url += `&actualYield=${actualYield}`;
                if (consumptionMap && Object.keys(consumptionMap).length > 0) {
                    url += `&consumptionMap=${encodeURIComponent(JSON.stringify(consumptionMap))}`;
                }

                const res = await fetch(url);
                const data = await res.json();

                if (data.result === 'success') {
                    showToast(`‚úÖ Production ${action.toLowerCase()}ed!`, 'success');
                    initializePortal(currentUser.role); // Refresh view
                } else {
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Network error', 'error');
            }
        }

        function completeWIP(id, role) {
            triggerWIPAction(id, 'COMPLETE');
        }

        function renderIngredients(req) {
            const container = document.getElementById('detailsRecipeContainer');
            if (!container) return;

            const isApproved = ['APPROVED', 'APPROVE_REQUEST', 'ISSUED', 'RECORDED', 'PRODUCED', 'DISPATCHED'].includes(req.status);
            const isCorrection = req.status === 'CORRECTION_REQUIRED';
            const stageUpper = (req.currentStage || '').toUpperCase();
            const isStoreAwaiting = ['AWAITING EMPLOYEE CONFIRMATION', 'AWAITING MATERIAL ISSUE'].includes(stageUpper);

            const isResearch = (req.type || '').toLowerCase() === 'research';
            const isManagerOrStore = ['Manager', 'Admin', 'Store Incharge'].includes(normalizeRole(currentUser.role));

            if (!isApproved && !isCorrection && !isResearch && !isManagerOrStore) {
                container.innerHTML = `
                    <div class="p-8 border border-dashed border-gray-200 rounded-2xl text-center bg-gray-50">
                        <p class="text-3xl mb-2">üîê</p>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-relaxed">Recipe details are restricted<br>until manager approval (Employee view)</p>
                    </div>
                `;
                return;
            }

            let html = '';

            const renderSection = (title, items, icon) => {
                if (!items || items.length === 0) return '';
                let sectionHtml = `
                    <div class="mb-4">
                        <h4 class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <span>${icon}</span> ${title}
                        </h4>
                        <div class="space-y-1">
                `;

                sectionHtml += items.map(ing => {
                    const localCorr = localCorrections[ing.name];
                    const remoteCorr = Array.isArray(req.corrections) ? req.corrections.find(c => c.item === ing.name) : null;
                    const isAdjustable = isStoreAwaiting && (normalizeRole(currentUser.role) === 'Employee');
                    const isRequester = (currentUser.email.toLowerCase().trim() === (req.requesterEmail || '').toLowerCase().trim());
                    const canEdit = isResearch && isRequester && ['SUBMITTED', 'PENDING', 'CORRECTION_REQUIRED'].includes(req.status);
                    const hasChange = localCorr || remoteCorr;

                    // INDUSTRIAL SYNC: Allow reporting ACTUAL usage during WIP
                    const isWIP = stageUpper.includes('WIP') || stageUpper === 'PRODUCTION PAUSED';
                    const canReportActual = isWIP && (isRequester || normalizeRole(currentUser.role) === 'Store Incharge' || normalizeRole(currentUser.role) === 'Operator');

                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0 group">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-gray-700">${ing.name}</span>
                                ${canReportActual ? `
                                    <div class="mt-1 flex items-center gap-1">
                                        <span class="text-[8px] text-gray-400 font-bold uppercase">Actual:</span>
                                        <input type="number" step="any" data-item-key="${ing.itemId || ing.name}" value="${ing.quantity || ing.qty || 0}" 
                                               class="w-16 px-1 py-0.5 text-[10px] border border-blue-200 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-400 actual-usage-input">
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${isAdjustable ? `<button onclick="requestItemCorrection('${req.id}', '${ing.name}', '${ing.quantity || ing.qty || 0}')" class="text-blue-500 font-black hover:text-blue-700 uppercase text-[8px] tracking-tighter">[${localCorr ? 'EDIT' : 'ADJ'}]</button>` : ''}
                                ${canEdit ? `
                                    <div class="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="editResearchItem('${req.id}', '${ing.name}', '${ing.quantity || ing.qty || 0}')" title="Edit Quantity" class="text-blue-500 hover:text-blue-700">‚úèÔ∏è</button>
                                        <button onclick="deleteResearchItem('${req.id}', '${ing.name}')" title="Delete Item" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                ${hasChange ? `
                                    <div class="flex flex-col items-end leading-none">
                                        <span class="text-gray-400 line-through text-[8px] font-medium">${ing.quantity || ing.qty || 0}</span>
                                        <span class="font-black ${localCorr ? 'text-blue-600' : 'text-orange-600'} text-[10px]">
                                            ‚Üí ${localCorr ? localCorr.new : remoteCorr.new} ${ing.unit || ''}
                                            ${localCorr ? '<span class="text-[6px] ml-1 bg-blue-50 px-1 rounded uppercase">Unsaved</span>' : ''}
                                        </span>
                                    </div>
                                ` : `<span class="font-black text-gray-900 text-xs">${ing.quantity || ing.qty || 0} ${ing.unit || ''}</span>`}
                            </div>
                        </div>
                    `;
                }).join('');

                sectionHtml += `</div></div>`;
                return sectionHtml;
            };

            html += renderSection('Formula Ingredients', req.ingredients, 'üî¨');
            html += renderSection('Packing Materials', req.packing, 'üì¶');
            html += renderSection('Labels & Printing', req.labels, 'üè∑Ô∏è');
            html += renderSection('Additional Requests', req.additionalItems, '‚ûï');

            container.innerHTML = html || '<p class="text-[10px] text-gray-400 font-bold italic text-center py-4">No items listed</p>';
        }

        function renderActionButtons(req) {
            const actionsArea = document.getElementById('detailsActionsArea');
            let actionBtns = '';
            const hasLocalChanges = Object.keys(localCorrections).length > 0;
            const userRole = normalizeRole(currentUser.role);
            const stage = (req.currentStage || '').toUpperCase();

            console.log(`[ActionButtons] Role: ${userRole}, Stage: ${stage}, Status: ${req.status}`);

            if (userRole === 'Manager' && (
                req.status === 'SUBMITTED' ||
                req.status === 'PENDING' ||
                req.status === 'CORRECTION_REQUIRED' ||
                ((req.status === 'ISSUED' || req.status === 'RESEARCH_ISSUED') && (stage.includes('PENDING') || stage.includes('MANAGER')))
            )) {
                const isIssueApprove = (req.status === 'ISSUED' || req.status === 'RESEARCH_ISSUED');
                const approveLabel = isIssueApprove ? '‚úÖ Approve & Consume' : '‚úÖ Approve';

                actionBtns = `
                    <button onclick="handleApprovalAction('${req.id}', 'approve')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">${approveLabel}</button>
                    <button onclick="handleApprovalAction('${req.id}', 'hold')" class="flex-1 bg-orange-500 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-orange-600 transition-all">‚è∏Ô∏è Hold</button>
                    <button onclick="handleApprovalAction('${req.id}', 'reject')" class="flex-1 bg-red-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-red-700 transition-all">‚ùå Reject</button>
                `;
            } else if (userRole === 'Employee' && req.status === 'APPROVED' && stage === 'AWAITING EMPLOYEE CONFIRMATION') {
                if (hasLocalChanges) {
                    actionBtns = `<button onclick="submitBatchCorrections('${req.id}')" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-blue-700 transition-all animate-pulse border-2 border-blue-400">üì§ Send Batch Correction (${Object.keys(localCorrections).length})</button>`;
                } else {
                    actionBtns = `<button onclick="confirmFormula('${req.id}')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">Confirm & Start Production</button>`;
                }
            } else if (stage === 'WIP' || stage.includes('WIP') || stage === 'PRODUCTION PAUSED') {
                const isRequester = (currentUser.email.toLowerCase().trim() === (req.requesterEmail || '').toLowerCase().trim());
                const isStore = (userRole === 'Store Incharge');

                if (isRequester || isStore) {
                    const isPaused = stage === 'PRODUCTION PAUSED';
                    actionBtns = `
                        <button onclick="triggerWIPAction('${req.id}', '${isPaused ? 'RESUME' : 'PAUSE'}')" class="flex-1 bg-orange-500 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-orange-600 transition-all">${isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause'}</button>
                        <button onclick="completeWIP('${req.id}')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">üì§ Complete</button>
                        <button onclick="triggerWIPAction('${req.id}', 'CANCEL')" class="flex-1 bg-red-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-red-700 transition-all">‚ùå Cancel</button>
                    `;
                } else {
                    actionBtns = `<div class="w-full text-center py-2 bg-gray-50 rounded-lg text-gray-400 text-[10px] font-black uppercase tracking-widest">‚öôÔ∏è Production in Progress (View Only)</div>`;
                }
            } else if (userRole === 'Store Incharge' && (stage === 'AWAITING MATERIAL ISSUE' || stage === 'PENDING STORE & MANAGER')) {
                const btnLabel = (req.type || '').toLowerCase() === 'research' ? 'üì¶ Issue Research Materials' : 'üì¶ Issue Materials & Start WIP';
                actionBtns = `
                    <button onclick="handleStageAction('${req.id}', 'ISSUE')" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-blue-700 transition-all">${btnLabel}</button>
                    <button onclick="handleStageAction('${req.id}', 'PARTIAL_ISSUE')" class="flex-1 bg-indigo-500 text-white font-black py-3 rounded-xl border-b-4 border-indigo-700 uppercase text-[10px] shadow-lg hover:bg-indigo-600 transition-all">üì¶ Issue Partial</button>
                `;

                // Cancellation Button for Requester
                const isRequester = (currentUser.email.toLowerCase().trim() === (req.requesterEmail || '').toLowerCase().trim());
                if (isRequester && ['SUBMITTED', 'PENDING', 'APPROVED', 'APPROVE_REQUEST', 'CORRECTION_REQUIRED'].includes(req.status) && stage !== 'COMPLETED' && stage !== 'CANCELLED') {
                    actionBtns += `<button onclick="cancelRequest('${req.id}')" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl uppercase text-[10px] hover:bg-red-50 hover:text-red-600 transition-all mt-2">üõë Cancel Request</button>`;
                }
            } else if (userRole === 'Operator') {
                if (stage === 'AWAITING PRODUCTION RECORDING') {
                    actionBtns = `<button onclick="handleStageAction('${req.id}', 'RECORD')" class="flex-1 bg-indigo-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:indigo-700 transition-all">Record Production (WIP)</button>`;
                } else if (stage === 'AWAITING DISPATCH') {
                    actionBtns = `<button onclick="handleStageAction('${req.id}', 'DISPATCH')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">Dispatch Goods</button>`;
                }
            }
            if (actionsArea) actionsArea.innerHTML = actionBtns;
        }

        function openCorrectionForm(id, itemName = '', oldQty = '') {
            const existing = localCorrections[itemName];
            const correctionModal = document.createElement('div');
            correctionModal.id = 'correctionModal';
            correctionModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] fade-in';
            correctionModal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-lg p-8 shadow-2xl mx-4 border-t-8 border-blue-500">
                    <h2 class="text-2xl font-black text-gray-800 mb-2">Adjust Quantity</h2>
                    <p class="text-sm text-gray-500 mb-6 font-medium">Proposed change for <b>${itemName}</b></p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Approved Qty</label>
                            <input type="text" id="oldQtyDisplay" readonly value="${oldQty}" class="w-full bg-transparent font-black text-gray-400 outline-none">
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 shadow-sm">
                            <label class="block text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">New Proposed Qty</label>
                            <input type="number" id="newQtyInput" step="0.001" value="${existing ? existing.new : ''}" class="w-full bg-transparent font-black text-blue-700 outline-none" placeholder="0.000" autofocus>
                        </div>
                    </div>

                    <div class="space-y-4 mb-8">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Internal Note (Reason)</label>
                            <textarea id="correctionReason" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Spill recovery, Scale adjustment...">${existing ? existing.reason : ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="this.closest('#correctionModal').remove()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-all uppercase text-xs">Close</button>
                        <button onclick="updateLocalCorrection('${itemName}', '${oldQty}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all uppercase text-xs shadow-lg">Save Adjustment</button>
                    </div>
                </div>
            `;
            document.body.appendChild(correctionModal);
        }

        function updateLocalCorrection(itemName, oldQty) {
            const newQty = document.getElementById('newQtyInput').value;
            const reason = document.getElementById('correctionReason').value;
            if (!newQty || !reason) return showToast('Quantity and reason required', 'warning');

            localCorrections[itemName] = { old: oldQty, new: newQty, reason: reason };

            showToast('‚úÖ Adjustment added to batch', 'success');
            document.getElementById('correctionModal').remove();

            // Refresh detailed view UI locally
            if (currentRequest) {
                renderIngredients(currentRequest);
                renderActionButtons(currentRequest);
            }
        }

        async function submitBatchCorrections(id) {
            const items = Object.keys(localCorrections).map(name => {
                const c = localCorrections[name];
                return { item: name, old: c.old, new: c.new, reason: c.reason };
            });

            if (items.length === 0) return;

            const summary = items.map(i => `${i.item}: ${i.old}‚Üí${i.new}`).join(', ');
            const structuredData = JSON.stringify(items);

            showToast('üì§ Sending batch corrections...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=request_correction&id=${id}&corrections=${encodeURIComponent(structuredData)}&summary=${encodeURIComponent(summary)}&user=${encodeURIComponent(currentUser.name)}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('üéâ Batch corrections sent to Manager!', 'success');
                    localCorrections = {};
                    closeDetails();
                    refreshCurrentView();
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Submission failed', 'error');
            }
        }

        function requestItemCorrection(reqId, itemName, currentQty) {
            openCorrectionForm(reqId, itemName, currentQty);
        }

        // ==========================================
        // MANAGER - ARCHIVE VIEW
        // ==========================================
        async function renderManagerHistory() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in p-6">
                    <div class="mb-8">
                        <h2 class="text-3xl font-black text-gray-800 tracking-tighter">Production Archive</h2>
                        <p class="text-gray-500 font-semibold italic">Complete historical logs of all approvals and quantities</p>
                    </div>
                    <div id="managerHistoryList" class="space-y-3">
                        <div class="text-center py-20"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_all_requests`);
                const data = await response.json();
                if (data.result === 'success' && data.requests) {
                    const list = document.getElementById('managerHistoryList');
                    list.innerHTML = data.requests.map(r => `
                        <div onclick="viewRequestDetails('${r.id}')" class="bg-white p-2 rounded-xl border border-gray-100 flex items-center justify-between hover:shadow-md hover:border-blue-200 cursor-pointer transition-all gap-3 group">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="bg-gray-50 p-1.5 rounded-lg text-center min-w-[50px] group-hover:bg-blue-50 transition-colors">
                                    <p class="text-[7px] font-black text-gray-400 uppercase leading-none">${r.id}</p>
                                    <p class="text-[8px] font-black text-blue-600 uppercase leading-none mt-1">${r.type.substring(0, 3)}</p>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="font-black text-gray-800 truncate text-xs leading-tight group-hover:text-blue-600">${r.productName}</h4>
                                    <p class="text-[8px] font-bold text-gray-400 uppercase">By: ${r.requesterName}</p>
                                </div>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <div>
                                    <p class="text-xs font-black text-gray-800 leading-none">${r.quantity} ${r.unit}</p>
                                    <p class="text-[7px] font-black text-gray-400 uppercase mt-0.5">${new Date(r.timestamp).toLocaleDateString()}</p>
                                </div>
                                <div class="min-w-[80px]">
                                    <span class="text-[7px] font-black px-1.5 py-0.5 rounded-full border border-blue-50 text-blue-600 uppercase bg-blue-50">${r.status}</span>
                                </div>
                                <div class="text-blue-500 opacity-0 group-hover:opacity-100 transition-all">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) { showToast('Failed to load archive', 'error'); }
        }

        async function viewRequestDetails(id) {
            const modal = document.getElementById('detailsModal');
            const panel = document.getElementById('detailsPanel');
            const historyContainer = document.getElementById('detailsHistory');
            const recipeContainer = document.getElementById('detailsRecipeContainer');
            const correctionsSection = document.getElementById('detailsCorrectionsSection');
            const correctionsContainer = document.getElementById('detailsCorrectionsContainer');
            const actionsArea = document.getElementById('detailsActionsArea');
            const addArea = document.getElementById('additionalRequestArea');

            // RESET BATCH CORRECTION STATE
            localCorrections = {};
            currentRequest = null;

            // Debug check
            if (!actionsArea) {
                console.error('‚ùå detailsActionsArea not found!');
            }

            // Initial UI state
            document.getElementById('detailsTitle').textContent = `REQ #${id}`;
            document.getElementById('detailsSubtitle').textContent = "üîç Scanning requisition data...";
            historyContainer.innerHTML = '<div class="text-[10px] font-bold text-gray-400 animate-pulse">Scanning timeline...</div>';
            recipeContainer.innerHTML = '';
            correctionsSection.classList.add('hidden');
            actionsArea.innerHTML = '';

            modal.style.display = 'flex';
            setTimeout(() => panel.classList.remove('translate-x-full'), 10);

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_request_details&id=${id}`);
                const data = await response.json();
                const req = data.request;
                currentRequest = req; // Store globally for local refresh

                if (!req) throw new Error('Request not found');

                // Update Header & Stats
                document.getElementById('detailsTitle').textContent = req.productName;
                document.getElementById('detailsSubtitle').textContent = `REQ #${req.id} ‚Ä¢ ${req.status} ‚Ä¢ BY ${req.requesterName}`;
                document.getElementById('detailsQty').textContent = `${req.quantity} ${req.unit || 'Units'}`;
                document.getElementById('detailsStation').textContent = req.currentStage;
                document.getElementById('detailsRecipeStatus').className = `text-[8px] font-black px-2 py-0.5 rounded uppercase ${req.status === 'APPROVED' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}`;
                document.getElementById('detailsRecipeStatus').textContent = req.status;

                // Render Ingredients (show to Manager/Admin/Store so they can approve or issue; restrict for Employee until approved)
                if (req.ingredients && req.ingredients.length > 0) {
                    const isApproved = ['APPROVED', 'APPROVE_REQUEST', 'ISSUED', 'RECORDED', 'PRODUCED', 'DISPATCHED'].includes(req.status);
                    const isCorrection = req.status === 'CORRECTION_REQUIRED';
                    const isStoreAwaiting = ['Awaiting Employee Confirmation', 'Awaiting Material Issue'].includes(req.currentStage);
                    const isManagerOrStore = ['Manager', 'Admin', 'Store Incharge'].includes(normalizeRole(currentUser.role));

                    if (isApproved || isCorrection || isManagerOrStore) {
                        recipeContainer.innerHTML = req.ingredients.map(ing => {
                            const corr = Array.isArray(req.corrections) ? req.corrections.find(c => c.item === ing.name) : null;
                            const isAdjustable = isStoreAwaiting && (currentUser.role === 'Employee');

                            return `
                                <div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0 group">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold text-gray-700">${ing.name}</span>
                                        ${isAdjustable ? `<button onclick="requestItemCorrection('${req.id}', '${ing.name}', '${ing.quantity}')" class="text-blue-500 font-black hover:text-blue-700 uppercase text-[8px] tracking-tighter">[ADJ]</button>` : ''}
                                    </div>
                                    <div class="text-right">
                                        ${corr ? `
                                            <div class="flex flex-col items-end leading-none">
                                                <span class="text-gray-400 line-through text-[8px] font-medium">${ing.quantity}</span>
                                                <span class="font-black text-orange-600 text-[10px]">‚Üí ${corr.new} ${ing.unit}</span>
                                            </div>
                                        ` : `<span class="font-black text-gray-900 text-xs">${ing.quantity} ${ing.unit}</span>`}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        recipeContainer.innerHTML = `
                            <div class="p-8 border border-dashed border-gray-200 rounded-2xl text-center bg-gray-50">
                                <p class="text-3xl mb-2">üîê</p>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-relaxed">Recipe details are restricted<br>until manager approval (Employee view)</p>
                            </div>
                        `;
                    }
                }

                // Render Corrections
                if (req.status === 'CORRECTION_REQUIRED') {
                    correctionsSection.classList.remove('hidden');
                    try {
                        const corrs = Array.isArray(req.corrections) ? req.corrections : JSON.parse(req.corrections || '[]');
                        correctionsContainer.innerHTML = corrs.map(c => `
                            <div class="flex justify-between items-center text-[10px] py-1 border-b border-orange-100 last:border-0">
                                <span class="font-bold text-orange-800">${c.item}:</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400 line-through">${c.old}</span>
                                    <span class="font-black text-orange-600">‚Üí ${c.new}</span>
                                </div>
                            </div>
                        `).join('') + (req.remarks ? `<p class="mt-2 text-[10px] italic text-orange-500 font-medium">"${req.remarks}"</p>` : '');
                    } catch (e) {
                        correctionsContainer.innerHTML = `<p class="text-[10px] italic text-orange-500">Adjustment details unavailable</p>`;
                    }
                }

                // Render History
                if (data.history && data.history.length > 0) {
                    historyContainer.innerHTML = data.history.map(h => `
                        <div class="flex gap-4 items-start relative pb-4">
                            <div class="absolute left-[7px] top-6 bottom-0 w-[2px] bg-gray-100"></div>
                            <div class="z-10 w-3.5 h-3.5 rounded-full bg-blue-500 border-2 border-white shadow-sm mt-1"></div>
                            <div class="flex-1">
                                <div class="text-xs font-black text-gray-800">${h.action}</div>
                                <div class="text-[8px] text-gray-400 font-black uppercase tracking-tighter mb-1">
                                    ${new Date(h.timestamp).toLocaleString()} ‚Ä¢ BY ${h.user}
                                </div>
                                ${h.remarks ? `<div class="text-[10px] text-gray-500 bg-white p-2 rounded-lg border border-gray-100 shadow-sm inline-block italic">"${h.remarks}"</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyContainer.innerHTML = `<div class="text-center py-4 text-[10px] font-bold text-gray-300 uppercase tracking-widest">No events logged</div>`;
                }

                if (actionsArea) {
                    renderIngredients(req);
                    renderActionButtons(req);
                } else {
                    console.error('‚ùå actionsArea is null! Cannot render buttons.');
                }

                // Interactions area logic
                addArea.classList.remove('hidden');
                addArea.dataset.reqId = id;
                if (currentUser.role === 'Employee') {
                    document.getElementById('additionalMaterialInput').classList.remove('hidden');
                } else {
                    document.getElementById('additionalMaterialInput').classList.add('hidden');
                }

            } catch (err) {
                console.error(err);
                showToast('Failed to load details', 'error');
                closeDetails();
            }
        }

        function closeDetails() {
            const modal = document.getElementById('detailsModal');
            const panel = document.getElementById('detailsPanel');
            if (panel) panel.classList.add('translate-x-full');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.add('portal-hidden');
            }, 300);
        }

        async function submitThreadNote() {
            const id = document.getElementById('additionalRequestArea').dataset.reqId;
            const note = document.getElementById('threadNoteInput').value;
            if (!note) return;

            showToast('Posting note...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=add_thread_note&id=${id}&note=${encodeURIComponent(note)}&role=${currentUser.role}&user=${encodeURIComponent(currentUser.name)}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('Note added!', 'success');
                    document.getElementById('threadNoteInput').value = '';
                    viewRequestDetails(id);
                }
            } catch (err) {
                showToast('Error', 'error');
            }
        }

        function renderDispatchView() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üöö Dispatch Management</h2>
                    <div class="space-y-4" id="dispatchViewList">
                        <div class="text-center py-12 text-gray-400 text-sm italic">Scanning for ready goods...</div>
                    </div>
                </div>
            `;
            loadStageRequests('DISPATCH', 'dispatchViewList');
        }

        function closeDetails() {
            const modal = document.getElementById('detailsModal');
            modal.classList.add('portal-hidden');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function submitAddMaterial() {
            const id = document.getElementById('additionalRequestArea').dataset.reqId;
            const category = document.getElementById('addMaterialCategory').value;
            const item = document.getElementById('addMaterialName').value;
            const qty = document.getElementById('addMaterialQty').value;

            if (!item || !qty) return showToast('Please enter item and quantity', 'warning');

            showToast(`Adding ${category.toLowerCase()}...`, 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=add_material_request&id=${id}&category=${category}&itemName=${encodeURIComponent(item)}&quantity=${qty}&user=${encodeURIComponent(currentUser.name)}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast(`${category} added successfully!`, 'success');
                    document.getElementById('addMaterialName').value = '';
                    document.getElementById('addMaterialQty').value = '';
                    viewRequestDetails(id); // Reload history and items
                } else {
                    showToast('Failed: ' + (data.error || 'Server error'), 'error');
                }
            } catch (err) {
                showToast('Network failure', 'error');
            }
        }

        function renderPendingApprovals() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚è≥ Pending Approvals</h2>
                    <div class="space-y-4" id="approvalsList">
                        <div class="text-center py-12 text-gray-400">
                            Loading pending requests...
                        </div>
                    </div>
                </div>
            `;
            loadPendingApprovals();
        }

        // ==========================================
        // ADMIN / MANAGER CONTROL PORTAL
        // ==========================================
        function renderAdminControl() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in max-w-4xl mx-auto">
                    <div class="mb-8">
                        <h2 class="text-3xl font-black text-gray-800 tracking-tighter">‚öôÔ∏è System Control</h2>
                        <p class="text-gray-500 font-semibold italic">Override statuses, stages, and process flows. Super Admin privileges active.</p>
                    </div>

                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8 space-y-6">
                        <div>
                            <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Lookup Request ID</label>
                            <div class="flex gap-2">
                                <input type="text" id="adminReqLookup" placeholder="e.g. REQ-12345" 
                                    class="flex-1 px-6 py-4 bg-gray-50 border-0 rounded-2xl text-lg font-black outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <button onclick="lookupRequestForAdmin()" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-blue-700 transition-all shadow-lg">SEARCH</button>
                            </div>
                        </div>

                        <div id="adminOverridePanel" class="hidden space-y-8 pt-8 border-t border-dashed">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Status Override</label>
                                    <select id="overrideStatus" class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="PENDING">PENDING (Freshly Submitted)</option>
                                        <option value="APPROVED">APPROVED (Awaiting Issue)</option>
                                        <option value="CORRECTION_REQUIRED">CORRECTION REQUIRED</option>
                                        <option value="ISSUED">ISSUED (In Floor/WIP)</option>
                                        <option value="PRODUCED">PRODUCED (Awaiting Dispatch)</option>
                                        <option value="DISPATCHED">DISPATCHED (Completed)</option>
                                        <option value="CANCELLED">CANCELLED (Refunded/Stopped)</option>
                                        <option value="REJECTED">REJECTED</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Stage / Station Override</label>
                                    <input type="text" id="overrideStage" placeholder="e.g. WIP, Management Approval, etc." 
                                        class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div class="bg-red-50 p-6 rounded-3xl border border-red-100">
                                <h4 class="text-xs font-black text-red-600 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span>‚ö†Ô∏è Danger Zone</span>
                                    <span class="text-[8px] bg-red-100 px-2 py-0.5 rounded">High Privileges</span>
                                </h4>
                                <div class="flex flex-wrap gap-3">
                                    <button onclick="performAdminAction('FORCE_WIP')" class="bg-white text-orange-600 border border-orange-200 px-4 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-orange-50 transition-all">Force WIP (Skip Approvals)</button>
                                    <button onclick="performAdminAction('FORCE_COMPLETE')" class="bg-white text-green-600 border border-green-200 px-4 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-green-50 transition-all">Force Complete (Skip WIP)</button>
                                    <button onclick="performAdminAction('FORCE_REFUND')" class="bg-white text-red-600 border border-red-200 px-4 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-red-50 transition-all">Force Refund (Without Status Change)</button>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button onclick="saveAdminOverride()" class="flex-1 bg-gray-800 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-black transition-all shadow-xl">Apply Global Update</button>
                                <button onclick="viewRequestDetails(document.getElementById('adminReqLookup').value)" class="px-8 bg-gray-100 text-gray-400 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-gray-200 hover:text-gray-600 transition-all">Preview Details</button>
                            </div>
                        </div>

                        <div id="adminLookupError" class="hidden p-4 bg-red-50 text-red-600 rounded-xl text-center font-bold text-xs">
                            Request ID not found. Verify and try again.
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // REQUEST NEW FORMULA (Employee)
        // ==========================================
        function renderRequestNewFormula() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üß™ Request New Formula</h2>
                    <p class="text-gray-500 text-sm mb-6">Ask Admin/Manager to add a formulation to Main Inventory. They will be notified by email.</p>
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 space-y-6">
                        <form onsubmit="submitFormulaRequest(event)" class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Formula basis</label>
                                <select id="formulaBasis" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="1 Litre">For 1 Litre</option>
                                    <option value="1 Kg">For 1 Kg</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Formulation details <span class="text-red-500">*</span></label>
                                <textarea id="formulaDetails" required rows="8" placeholder="Enter ingredients and quantities per the basis above (e.g. Ingredient A: 100 ml, Ingredient B: 50 g...)"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            <div class="flex gap-3">
                                <button type="button" onclick="loadView('my-requests')" class="btn-secondary flex-1">Cancel</button>
                                <button type="submit" class="btn-primary flex-1">Submit Request</button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Your formula requests</h3>
                        <div id="myFormulaRequestsList" class="space-y-3">
                            <div class="text-center py-6 text-gray-400 text-sm">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
            loadMyFormulaRequests();
        }

        async function submitFormulaRequest(e) {
            e.preventDefault();
            const basis = document.getElementById('formulaBasis').value;
            const details = document.getElementById('formulaDetails').value.trim();
            if (!details) return showToast('Enter formulation details', 'warning');
            try {
                const response = await fetch(SCRIPT_URL + '?' + new URLSearchParams({
                    action: 'submit_formula_request',
                    email: currentUser.email,
                    name: currentUser.name,
                    formulaBasis: basis,
                    formulaDetails: details
                }));
                const data = await response.json().catch(() => ({}));
                if (data.result === 'success') {
                    showToast('Request submitted. Admin/Manager will be notified by email.', 'success');
                    document.getElementById('formulaDetails').value = '';
                    loadMyFormulaRequests();
                } else {
                    showToast(data.error || 'Submit failed', 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
        }

        async function loadMyFormulaRequests() {
            const el = document.getElementById('myFormulaRequestsList');
            if (!el) return;
            try {
                const response = await fetch(SCRIPT_URL + '?' + new URLSearchParams({
                    action: 'get_formula_requests',
                    email: currentUser.email,
                    role: currentUser.role || 'Employee'
                }));
                const data = await response.json().catch(() => ({}));
                const list = data.requests || [];
                if (list.length === 0) {
                    el.innerHTML = '<p class="text-gray-500 text-sm">No formula requests yet.</p>';
                    return;
                }
                el.innerHTML = list.map(r => `
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <div class="flex justify-between items-start gap-2">
                            <div>
                                <span class="font-mono font-bold text-blue-600">${r.id}</span>
                                <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold ${r.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : r.status === 'Added' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${r.status}</span>
                            </div>
                            <span class="text-xs text-gray-500">${r.formulaBasis || ''}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 line-clamp-2">${(r.formulaDetails || '').replace(/</g, '&lt;')}</p>
                        ${r.resolvedBy ? `<p class="text-xs text-gray-500 mt-2">Resolved by ${r.resolvedBy}${r.notes ? ': ' + r.notes : ''}</p>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                el.innerHTML = '<p class="text-red-500 text-sm">Failed to load.</p>';
            }
        }

        // ==========================================
        // FORMULA REQUESTS (Manager / Admin)
        // ==========================================
        function renderFormulaRequests() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üß™ Formula Requests</h2>
                    <p class="text-gray-500 text-sm mb-6">Employee requests to add formulations to Main Inventory. Resolve after adding the formula in Main Inventory.</p>
                    <div class="flex gap-2 mb-4">
                        <button onclick="loadFormulaRequests('')" class="px-4 py-2 rounded-lg font-semibold text-sm border-2 border-gray-300 hover:border-blue-500">All</button>
                        <button onclick="loadFormulaRequests('Pending')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-yellow-100 text-yellow-800 border-2 border-yellow-300">Pending</button>
                        <button onclick="loadFormulaRequests('Added')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-green-100 text-green-800 border-2 border-green-300">Added</button>
                        <button onclick="loadFormulaRequests('Rejected')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-red-100 text-red-800 border-2 border-red-300">Rejected</button>
                    </div>
                    <div id="formulaRequestsList" class="space-y-4">
                        <div class="text-center py-12 text-gray-400">Loading...</div>
                    </div>
                </div>
            `;
            loadFormulaRequests('Pending');
        }

        async function loadFormulaRequests(statusFilter) {
            const el = document.getElementById('formulaRequestsList');
            if (!el) return;
            el.innerHTML = '<div class="text-center py-8 text-gray-400">Loading...</div>';
            try {
                const params = new URLSearchParams({ action: 'get_formula_requests', email: currentUser.email, role: currentUser.role || '' });
                if (statusFilter) params.set('status', statusFilter);
                const response = await fetch(SCRIPT_URL + '?' + params);
                const data = await response.json().catch(() => ({}));
                const list = data.requests || [];
                if (list.length === 0) {
                    el.innerHTML = '<p class="text-gray-500 text-center py-8">No formula requests.</p>';
                    return;
                }
                el.innerHTML = list.map(r => `
                    <div class="bg-white rounded-xl border border-gray-200 p-5 shadow-sm">
                        <div class="flex justify-between items-start flex-wrap gap-2 mb-3">
                            <span class="font-mono font-bold text-blue-600">${r.id}</span>
                            <span class="px-2 py-1 rounded text-xs font-bold ${r.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : r.status === 'Added' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${r.status}</span>
                        </div>
                        <p class="text-sm text-gray-600"><strong>${(r.requestedByName || '').replace(/</g, '&lt;')}</strong> (${(r.requestedByEmail || '').replace(/</g, '&lt;')})</p>
                        <p class="text-xs text-gray-500 mt-1">Basis: ${(r.formulaBasis || '').replace(/</g, '&lt;')} ‚Ä¢ ${r.createdDate ? new Date(r.createdDate).toLocaleString() : ''}</p>
                        <div class="mt-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-700 whitespace-pre-wrap">${(r.formulaDetails || '').replace(/</g, '&lt;').replace(/\n/g, '<br>')}</div>
                        ${r.status === 'Pending' ? `
                            <div class="mt-4 flex flex-wrap gap-2 items-end">
                                <input type="text" id="formulaResolveNote-${r.id}" placeholder="Optional note" class="flex-1 min-w-[120px] px-3 py-2 border rounded-lg text-sm">
                                <button onclick="resolveFormulaRequest('${r.id}', 'Added')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm hover:bg-green-700">Mark Added</button>
                                <button onclick="resolveFormulaRequest('${r.id}', 'Rejected')" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold text-sm hover:bg-red-700">Reject</button>
                            </div>
                        ` : ''}
                        ${r.resolvedBy ? `<p class="text-xs text-gray-500 mt-2">Resolved by ${(r.resolvedBy || '').replace(/</g, '&lt;')}${r.notes ? ' ‚Äì ' + (r.notes || '').replace(/</g, '&lt;') : ''}</p>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                el.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load.</p>';
            }
        }

        async function resolveFormulaRequest(id, status) {
            const noteEl = document.getElementById('formulaResolveNote-' + id);
            const notes = noteEl ? noteEl.value.trim() : '';
            try {
                const response = await fetch(SCRIPT_URL + '?' + new URLSearchParams({
                    action: 'update_formula_request_status',
                    id: id,
                    status: status,
                    email: currentUser.email,
                    user: currentUser.name,
                    notes: notes
                }));
                const data = await response.json().catch(() => ({}));
                if (data.result === 'success') {
                    showToast('Request ' + status.toLowerCase() + '. Employee will be notified by email.', 'success');
                    loadFormulaRequests('');
                } else {
                    showToast(data.error || 'Update failed', 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
        }

        async function lookupRequestForAdmin() {
            const id = document.getElementById('adminReqLookup').value.trim();
            if (!id) return showToast('Enter Request ID', 'warning');

            showToast('Searching...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_request_details&id=${id}`);
                const data = await response.json();
                const req = data.request;

                if (req) {
                    document.getElementById('adminOverridePanel').classList.remove('hidden');
                    document.getElementById('adminLookupError').classList.add('hidden');

                    document.getElementById('overrideStatus').value = req.status.toUpperCase();
                    document.getElementById('overrideStage').value = req.currentStage;
                    showToast('Data Loaded!', 'success');
                } else {
                    document.getElementById('adminOverridePanel').classList.add('hidden');
                    document.getElementById('adminLookupError').classList.remove('hidden');
                }
            } catch (err) {
                showToast('Lookup failed', 'error');
            }
        }

        async function saveAdminOverride() {
            const id = document.getElementById('adminReqLookup').value.trim();
            const status = document.getElementById('overrideStatus').value;
            const stage = document.getElementById('overrideStage').value;

            if (!confirm('This will bypass all system validations. Are you sure you want to force this change?')) return;

            showToast('Overriding...', 'info');
            try {
                const url = `${SCRIPT_URL}?action=admin_override&id=${id}&status=${encodeURIComponent(status)}&stage=${encodeURIComponent(stage)}&user=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.result === 'success') {
                    showToast('‚úÖ System Override Successful!', 'success');
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
        }

        async function performAdminAction(type) {
            const id = document.getElementById('adminReqLookup').value.trim();
            if (!confirm('Confirm HIGH PRIVILEGE action: ' + type + '?')) return;

            showToast('Executing Force Action...', 'info');
            try {
                const url = `${SCRIPT_URL}?action=admin_force_action&id=${id}&type=${type}&user=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.result === 'success') {
                    showToast('‚úÖ Action Executed!', 'success');
                    lookupRequestForAdmin(); // Refresh panel
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (err) {
                showToast('Action failed', 'error');
            }
        }

        async function loadPendingApprovals() {
            await new Promise(r => setTimeout(r, 50));
            const listContainer = document.getElementById('approvalsList');
            if (!listContainer) return;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_pending_approvals&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();

                if (data.requests && data.requests.length > 0) {
                    listContainer.innerHTML = data.requests.map(req => {
                        const isCorrection = req.status === 'CORRECTION_REQUIRED';
                        const cardClass = isCorrection
                            ? "bg-white rounded-xl shadow-md border-4 border-orange-500 bg-orange-50 p-4 hover:shadow-lg transition-all cursor-pointer group relative overflow-hidden"
                            : "bg-white rounded-xl shadow-sm border-2 border-gray-100 p-4 hover:shadow-md hover:border-blue-400 transition-all cursor-pointer group relative overflow-hidden";

                        return `
                            <div onclick="viewRequestDetails('${req.id}')" class="${cardClass}">
                                ${isCorrection ? `
                                    <div class="absolute top-0 right-0 bg-orange-600 text-white text-[9px] font-black px-4 py-1.5 rounded-bl-xl uppercase tracking-widest shadow-md z-10">
                                        ‚ö†Ô∏è Correction Required
                                    </div>
                                ` : ''}
                                <div class="flex justify-between items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[8px] font-black bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded uppercase">${req.type}</span>
                                            <span class="text-[8px] font-black bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${req.id}</span>
                                        </div>
                                        ${isCorrection ? `<div class="text-[12px] font-black text-orange-600 mb-1 tracking-tighter uppercase italic">üö® Correction Request</div>` : ''}
                                        <h3 class="font-black text-gray-800 truncate text-base group-hover:text-blue-600 transition-colors leading-tight ${isCorrection ? 'text-orange-900 font-black' : ''}">${req.productName}</h3>
                                        <div class="flex flex-col gap-1 mt-1.5">
                                            <p class="text-[9px] text-gray-400 font-black uppercase">Requester: <span class="text-gray-600">${req.requesterName}</span></p>
                                            ${isCorrection && req.remarks ? `
                                                <div class="mt-2 bg-white/50 p-2 rounded-lg border border-orange-200 shadow-inner">
                                                    <p class="text-[10px] text-orange-700 font-bold leading-tight italic">"${req.remarks}"</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end shrink-0">
                                        <p class="text-xl font-black ${isCorrection ? 'text-orange-600' : 'text-gray-800'} leading-none">${req.quantity}</p>
                                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mt-1">${req.unit || 'Units'}</p>
                                        <div class="mt-4 ${isCorrection ? 'text-orange-600 opacity-100' : 'text-blue-500 opacity-0 group-hover:opacity-100'} transition-all font-black text-[9px] uppercase tracking-tighter">Review Change ${isCorrection ? 'Required' : ''} ‚Üí</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listContainer.innerHTML = `
                        <div class="text-center py-20 bg-white rounded-lg shadow border-2 border-dashed">
                            <div class="text-4xl mb-4">‚ú®</div>
                            <p class="text-gray-500 font-medium text-lg">All caught up! No pending approvals.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
                showToast('Failed to load approvals', 'error');
            }
        }

        async function handleApprovalAction(id, action) {
            let reason = '';

            // Prompt for reason if rejecting or holding
            if (action === 'reject' || action === 'hold') {
                const actionText = action === 'reject' ? 'REJECT' : 'HOLD';
                reason = prompt(`Please provide a reason for ${actionText}:`);
                if (!reason || reason.trim() === '') {
                    showToast('Action cancelled - reason required', 'warning');
                    return;
                }
            }

            const apiAction = action === 'approve' ? 'approve_request' :
                action === 'hold' ? 'hold_request' :
                    'reject_request';
            const displayAction = action.charAt(0).toUpperCase() + action.slice(1);
            showToast(`${displayAction}ing...`, 'info');

            try {
                // SECURITY UPDATE: Pass email for role verification
                let url = `${SCRIPT_URL}?action=${apiAction}&id=${id}&user=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}`;
                if (reason) url += `&reason=${encodeURIComponent(reason)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.result === 'success') {
                    showToast(`Request ${displayAction}ed!`, 'success');
                    closeDetails();
                    // Auto-refresh to ensure list view state is consistent
                    if (currentUser.role === 'Manager') {
                        loadView('pending-approvals', 'Manager');
                    } else {
                        refreshCurrentView();
                    }
                } else {
                    showToast(data.error || 'Failed', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Network error', 'error');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        // Auto-refresh logic
        let currentViewId = 'dashboard';

        function startAutoRefresh() {
            // DISABLED: Auto-refresh was interrupting user input
            // User can manually refresh using the refresh button
            console.log('‚ö†Ô∏è Auto-refresh disabled to prevent input interruption');
            return;

            /* DISABLED CODE:
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                const modal = document.getElementById('detailsModal');
                if (modal.style.display !== 'flex') {
                    console.log('üîÑ Auto-refreshing current portal...');
                    initializePortal(currentUser.role);
                }
            }, 300000); // 5 minutes
            */
        }

        async function refreshCurrentView() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            btn.classList.add('opacity-50', 'pointer-events-none');
            icon.classList.add('animate-spin');

            showToast('Syncing data...', 'info');
            await initializePortal(currentUser.role);

            setTimeout(() => {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                icon.classList.remove('animate-spin');
                showToast('Synchronized', 'success');
            }, 500);
        }

        window.onload = function () {
            loadConfig();

            // Check if already logged in
            const savedUser = localStorage.getItem('miklens_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    currentUser.role = normalizeRole(currentUser.role); // NORMALIZE ON LOAD
                    showApp();
                    startAutoRefresh();
                } catch (e) {
                    localStorage.removeItem('miklens_user');
                }
            }


            // Attach Settings modal event listeners
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsCloseBtn = document.getElementById('settingsCloseBtn');
            const settingsCancelBtn = document.getElementById('settingsCancelBtn');
            const settingsSaveBtn = document.getElementById('settingsSaveBtn');

            if (settingsBtn) {
                settingsBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log('Settings button clicked');
                    openSettings();
                });
            }
            if (settingsCloseBtn) {
                settingsCloseBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    closeSettings();
                });
            }
            if (settingsCancelBtn) {
                settingsCancelBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    closeSettings();
                });
            }
            if (settingsSaveBtn) {
                settingsSaveBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    saveSettingsUrl();
                });
            }
        };

        // ==========================================
        // OPERATOR - MASTER ARCHIVE (FOLDER VIEW)
        // ==========================================
        async function renderMasterArchive() {
            const container = document.getElementById('contentArea');
            container.innerHTML = `
                <div class="p-6 fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-gray-800 tracking-tighter">Master Archive</h2>
                            <p class="text-gray-500 font-medium italic">Production Data Folders</p>
                        </div>
                    </div>
                    <div id="archiveContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full py-20 text-center"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_all_requests`);
                const data = await response.json();

                if (data.result === 'success' && data.requests) {
                    const grouped = {};
                    data.requests.forEach(req => {
                        const prod = req.productName || 'General / R&D';
                        if (!grouped[prod]) grouped[prod] = [];
                        grouped[prod].push(req);
                    });

                    const arcContainer = document.getElementById('archiveContainer');
                    if (Object.keys(grouped).length === 0) {
                        arcContainer.innerHTML = '<div class="col-span-full py-12 text-center text-gray-400">No records found.</div>';
                        return;
                    }

                    arcContainer.innerHTML = '';
                    Object.keys(grouped).forEach(prodName => {
                        const reqs = grouped[prodName];
                        const folder = document.createElement('div');
                        folder.className = 'bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-xl transition-all cursor-pointer group';
                        folder.onclick = () => showProductFolderDetails(prodName, reqs);
                        folder.innerHTML = `
                            <div class="flex items-start justify-between mb-4">
                                <div class="bg-blue-50 p-3 rounded-2xl group-hover:bg-blue-600 transition-colors">
                                    <svg class="w-6 h-6 text-blue-600 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                                </div>
                                <span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-1 rounded-full uppercase">${reqs.length} Batches</span>
                            </div>
                            <h3 class="text-xl font-black text-gray-800 mb-1 group-hover:text-blue-600 transition-colors truncate">${prodName}</h3>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Active Data Folder</p>
                            
                            <div class="mt-4 space-y-2 border-t border-gray-50 pt-4">
                                ${reqs.slice(0, 3).map(r => `
                                    <div class="flex justify-between items-center text-[10px]">
                                        <span class="text-gray-500 font-medium">REQ #${r.id}</span>
                                        <span class="font-bold text-gray-800">${r.status}</span>
                                    </div>
                                `).join('')}
                                ${reqs.length > 3 ? `<p class="text-[9px] text-center text-blue-500 font-black mt-2">View ${reqs.length - 3} more ‚Üí</p>` : ''}
                            </div>
                        `;
                        arcContainer.appendChild(folder);
                    });
                }
            } catch (err) {
                console.error(err);
                document.getElementById('archiveContainer').innerHTML = '<div class="col-span-full py-12 text-center text-red-400">Error loading data.</div>';
            }
        }

        function showProductFolderDetails(prodName, reqs) {
            const modal = document.getElementById('detailsModal');
            document.getElementById('detailsTitle').textContent = prodName;
            document.getElementById('detailsStatus').textContent = `Stored in Archive`;

            const historyContainer = document.getElementById('detailsHistory');
            historyContainer.innerHTML = `
                <div class="space-y-4">
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Total Batches: ${reqs.length}</p>
                    ${reqs.map(r => `
                        <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100 hover:border-blue-200 transition-all">
                            <div class="flex justify-between mb-2">
                                <p class="text-[10px] font-black text-blue-600 uppercase">BATCH #${r.id}</p>
                                <p class="text-[10px] font-black text-gray-400 uppercase">${new Date(r.timestamp).toLocaleDateString()}</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm font-bold text-gray-800">${r.requesterName}</p>
                                    <p class="text-[10px] text-gray-500 font-medium">${r.quantity} ${r.unit}</p>
                                </div>
                                <span class="text-[9px] font-black bg-blue-100 px-3 py-1 rounded-full text-blue-700 uppercase">${r.status}</span>
                            </div>
                            <button onclick="viewRequestDetails('${r.id}')" class="mt-4 w-full text-[9px] font-black text-blue-600 hover:text-blue-800 uppercase text-center py-2 border-t border-gray-100">Audit details ‚Üí</button>
                        </div>
                    `).join('')}
                </div>
            `;
            modal.style.display = 'flex';
        }

        async function handleAdminAction(id, action) {
            if (!confirm(`Are you sure you want to ${action === 'APPROVED' ? 'Bypass/Approve' : 'Reject'} this request?`)) return;
            showToast('Executive override...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=approve_request&id=${id}&action=${action}&role=OPERATOR&user=${encodeURIComponent(currentUser.name)}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('Bypass successful!', 'success');
                    initializePortal(currentUser.role);
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (err) { showToast('Execution failed', 'error'); }
        }
        async function cancelRequest(id) {
            if (!confirm('Are you sure you want to cancel this request? This cannot be undone.')) return;
            const reason = prompt('Reason for cancellation:');
            if (reason === null) return;

            showToast('Cancelling request...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=wip_action_req&id=${id}&wipAction=CANCEL&email=${currentUser.email}&user=${currentUser.name}&reason=${encodeURIComponent(reason)}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('Request cancelled', 'success');
                    closeDetails();
                    refreshCurrentView();
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Connection error', 'error');
            }
        }

        async function editResearchItem(id, itemName, currentQty) {
            const newQty = prompt(`Edit quantity for ${itemName}:`, currentQty);
            if (newQty === null || newQty === currentQty) return;

            showToast('Updating quantity...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=edit_request_item&id=${id}&itemName=${encodeURIComponent(itemName)}&quantity=${newQty}&email=${currentUser.email}&user=${currentUser.name}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('Quantity updated', 'success');
                    viewRequestDetails(id); // Reload details
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Connection error', 'error');
            }
        }

        async function deleteResearchItem(id, itemName) {
            if (!confirm(`Remove ${itemName} from this request?`)) return;

            showToast('Removing item...', 'info');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=delete_request_item&id=${id}&itemName=${encodeURIComponent(itemName)}&email=${currentUser.email}&user=${currentUser.name}`);
                const data = await response.json();
                if (data.result === 'success') {
                    showToast('Item removed', 'success');
                    viewRequestDetails(id); // Reload details
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('Connection error', 'error');
            }
        }
    </script>
</body>

</html>
