<!DOCTYPE html>
<html lang="en">
<!-- Keep in sync with index.html when changing flows or API usage -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Keep in sync with index.html when changing flows/API -->
    <title>MIKLENS Digital Requisition System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase config: same for all users/devices (edit firebase-config.js) -->
    <script src="firebase-config.js"></script>
    <!-- Firebase (optional backend) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-backend.js"></script>
    <script>
    /* Inline fallback when firebase-backend.js is not available (e.g. GitHub Pages) */
    if (typeof window.FirebaseBackend === 'undefined') {
    (function(g){'use strict';var db=null;function fail(e){return{result:'error',error:(e&&e.message)||String(e)};}function ok(d){return Object.assign({result:'success'},d);}async function sha256(s){var b=new TextEncoder().encode(s),h=await crypto.subtle.digest('SHA-256',b),a=Array.from(new Uint8Array(h));return a.map(function(x){return('0'+(x&0xff).toString(16)).slice(-2);}).join('');}async function loginUser(email,password){if(!email||!password)return fail(new Error('Email and password required'));var e=String(email).toLowerCase().trim(),ref=db.collection('Users').doc(e.replace(/\//g,'_')),snap=await ref.get();if(!snap.exists)return{result:'error',error:'Invalid login'};var u=snap.data(),st=(u.PasswordHash||'').trim();if(!st)return{result:'error',error:'Invalid login'};var hashed=await sha256(String(password)+e);if(st!==hashed&&(/^[a-f0-9]{64}$/i.test(st)!==false||st!==String(password).trim()))return{result:'error',error:'Invalid login'};return ok({user:{email:u.Email||e,name:u.Name||'',role:u.Role||'',department:u.Department||''}});}async function getDb(){var snap=await db.collection('Database').doc('latest').get();if(!snap.exists)return{status:'success',result:'success',data:null};var d=snap.data(),p=(d&&d.data)?d.data:d,v=(d&&d.latestId)?d.latestId:null;return{status:'success',result:'success',data:p,version:v};}async function saveInventory(payload){var s=(payload&&payload.data)?JSON.stringify(payload):(typeof payload==='string'?payload:JSON.stringify(payload));try{var parsed=typeof s==='string'?JSON.parse(s):s;}catch(e){return fail(e);}var dataObj=(parsed&&parsed.data&&parsed.data.inventory)?parsed.data:parsed;await db.collection('Database').doc('latest').set({data:dataObj||parsed,latestId:Date.now().toString(),exportedAt:new Date().toISOString()});return{status:'success'};}async function getCollectionArray(name){var snap=await db.collection(name).get(),out=[];snap.forEach(function(d){if(d.id==='_empty'||d.id==='latest')return;out.push(Object.assign({_id:d.id},d.data()));});return out;}function safeJson(v,def){if(v==null||v==='')return def;if(Array.isArray(v))return v;if(typeof v==='object')return v;try{return JSON.parse(String(v));}catch(e){return def;}}function rowToRequest(d,light){var r=(d&&d.data)?d.data:d,id=r.RequestID||r.id||d.id,row={id:id,type:r.Type||r.type||'',status:r.Status||r.status||'',requesterName:r.EmployeeName||r.requesterName||'',requesterEmail:r.EmployeeEm||r.requesterEmail||'',productName:r.ProductName||r.productName||'',quantity:r.RequestedQty!=null?r.RequestedQty:r.quantity,unit:r.Unit||r.unit||'',remarks:r.Notes||r.remarks||'',date:r.CreatedDate||r.date,stage:r.CurrentStage||r.stage,currentStage:r.CurrentStage||r.stage};if(r.PartialIssuedQty!=null)row.partialIssuedQty=r.PartialIssuedQty;if(!light){row.ingredients=safeJson(r.Formulaltems||r.ingredients,[]);row.packing=safeJson(r.Additionalltems||r.packing,[]);row.labels=safeJson(r.Labels||r.labels,[]);row.additionalItems=safeJson(r.AdditionalItems||r.additionalItems,[]);row.corrections=safeJson(r.Corrections||r.corrections,[]);}return row;}async function getRequestsByStage(params){var stage=(params.stage||'').toUpperCase(),limit=parseInt(params.limit,10)||20,page=parseInt(params.page,10)||1,skip=(page-1)*limit,light=params.light==='1'||params.light===true,all=await getCollectionArray('Requisitions_V2');function match(r,st){var status=(r.Status||r.status||'').toUpperCase(),cur=(r.CurrentStage||r.currentStage||r.stage||'').toUpperCase();if(st==='ALL')return true;if(st==='PENDING_ISSUE'){if(cur.indexOf('AWAITING MATERIAL ISSUE')>=0||cur.indexOf('PENDING STORE')>=0||cur.indexOf('PENDING MANAGER APPROVAL')>=0)return true;if((status==='APPROVED'||status==='APPROVE_REQUEST')&&(cur.indexOf('AWAITING')>=0||cur.indexOf('MATERIAL ISSUE')>=0))return true;if(status==='PARTIALLY_ISSUED')return true;}if(st==='WIP'&&(cur.indexOf('MANUFACTURING')>=0||cur.indexOf('WIP')>=0||cur.indexOf('MATERIAL ISSUED')>=0||cur==='PAUSED'))return true;if(st==='DISPATCH'&&(cur.indexOf('AWAITING DISPATCH')>=0||status==='PRODUCED'))return true;if(st==='PENDING_RECORD'&&(cur.indexOf('AWAITING PRODUCTION RECORDING')>=0||cur.indexOf('MATERIAL ISSUED')>=0))return true;if(st==='PARTIAL_ISSUE'&&status==='PARTIALLY_ISSUED')return true;return false;}var filtered=stage==='ALL'?all:all.filter(function(r){return match(r,stage);}),total=filtered.length,pageList=filtered.slice(skip,skip+limit),requests=pageList.map(function(d){return rowToRequest(d,light);});return ok({requests:requests,totalMatches:total,page:page});}async function getAllRequests(p){return getRequestsByStage({stage:'ALL',limit:p.limit||500,light:p.light});}async function getRequestDetails(p){var id=p.id;if(!id)return fail(new Error('No id'));var ref=db.collection('Requisitions_V2').doc(String(id).replace(/\//g,'_')),snap=await ref.get();if(!snap.exists)return fail(new Error('Request not found'));var r=snap.data(),tSnap=await db.collection('RequestThreads').where('RequestID','==',id).get(),threads=[];tSnap.forEach(function(t){threads.push(t.data());});threads.sort(function(a,b){return(new Date(a.Timestamp||0)).getTime()-(new Date(b.Timestamp||0)).getTime();});var req={id:r.RequestID||id,type:r.Type,status:r.Status,requesterEmail:r.EmployeeEm,requesterName:r.EmployeeName,productName:r.ProductName,quantity:r.RequestedQty,unit:r.Unit,ingredients:safeJson(r.Formulaltems,[]),packing:safeJson(r.Additionalltems,[]),labels:safeJson(r.Labels,[]),additionalItems:safeJson(r.AdditionalItems,[]),corrections:safeJson(r.Corrections,[]),notes:r.Notes,date:r.CreatedDate,currentStage:r.CurrentStage,managerEmail:r.ManagerEmail,batchId:r.BatchID,partialIssuedQty:r.PartialIssuedQty,thread:threads};return ok({request:req});}function buildFormDataFromInventory(inv){if(!inv)return{products:[],materials:[],raw:[],pack:[],labels:[]};var toItem=function(i){return{id:i.id||i.name,name:i.name||i.itemName||String(i.id||''),unit:i.unit||'Units'};};var raw=(inv.rawMaterials||[]).map(toItem);var pack=(inv.packingMaterials||[]).map(toItem);var lbl=(inv.labels||[]).map(toItem);var prods=(inv.finishedGoods||inv.products||[]).map(toItem);var materials=[].concat(raw.map(function(r){return Object.assign({},r,{category:'raw'});})).concat(pack.map(function(p){return Object.assign({},p,{category:'packing'});})).concat(lbl.map(function(l){return Object.assign({},l,{category:'labels'});}));return{products:prods,materials:materials,raw:raw,pack:pack,labels:lbl};}async function getFormData(){var products=[],materials=[],raw=[],pack=[],labels=[],managers=[];var fcSnap=await db.collection('FormCache').doc('latest').get();if(fcSnap.exists){var fc=fcSnap.data();products=fc.products||[];materials=fc.materials||[];raw=fc.rawMaterials||[];pack=fc.packingMaterials||[];labels=fc.labels||[];}if(products.length===0&&materials.length===0){var formCol=await db.collection('FormCache').limit(10).get();formCol.forEach(function(d){if(products.length>0&&materials.length>0)return;if(d.id==='_empty'||d.id==='latest')return;var fc2=d.data();var p=fc2.products||[];var m=fc2.materials||[];if(p.length||m.length){products=p;materials=m;raw=fc2.rawMaterials||[];pack=fc2.packingMaterials||[];labels=fc2.labels||[];}});}if(products.length===0&&materials.length===0){var dbSnap=await db.collection('Database').doc('latest').get();if(dbSnap.exists){var d=dbSnap.data();var payload=(d&&d.data)?d.data:d;var inv=(payload&&payload.inventory)?payload.inventory:payload;var built=buildFormDataFromInventory(inv);products=built.products;materials=built.materials;raw=built.raw;pack=built.pack;labels=built.labels;}}var dataSnap=await db.collection('Data').doc('latest').get(),employees=[],departments=[];if(dataSnap.exists){var dd=dataSnap.data();employees=dd.Employees||dd.employees||[];departments=dd.Departments||dd.departments||[];}var uSnap=await db.collection('Users').get();uSnap.forEach(function(d){var u=d.data();if(!u.Role)return;if(String(u.Role).toLowerCase().indexOf('manager')>=0||String(u.Role).toLowerCase().indexOf('admin')>=0)managers.push({name:u.Name,email:u.Email});});return ok({products:products,materials:materials,rawMaterials:raw,packingMaterials:pack,labels:labels,managers:managers,employees:employees,departments:departments,approvers:managers.map(function(m){return m.name;})});}async function getLists(){var fd=await getFormData();if(fd.result!=='success')return fd;return ok({data:{products:fd.products,materials:fd.materials,rawMaterials:fd.rawMaterials,packingMaterials:fd.packingMaterials,labels:fd.labels,employees:fd.employees,departments:fd.departments,approvers:fd.approvers}});}async function getStageCounts(){var all=await getCollectionArray('Requisitions_V2'),counts={PENDING_ISSUE:0,WIP:0,DISPATCH:0,PENDING_RECORD:0,PENDING_APPROVALS:0,PARTIAL_ISSUE:0,PENDING_DISPATCH_APPROVALS:0,FORMULA_REQUESTS:0};all.forEach(function(r){var status=(r.Status||r.status||'').toUpperCase(),cur=(r.CurrentStage||r.currentStage||'').toUpperCase();if(cur.indexOf('PENDING MANAGER APPROVAL')>=0&&(status==='SUBMITTED'||status==='PENDING'))counts.PENDING_APPROVALS++;if(cur.indexOf('AWAITING MATERIAL ISSUE')>=0||cur.indexOf('PENDING STORE')>=0||(status==='APPROVED'&&cur.indexOf('AWAITING')>=0)||status==='PARTIALLY_ISSUED')counts.PENDING_ISSUE++;if(cur.indexOf('MANUFACTURING')>=0||cur.indexOf('WIP')>=0||cur==='PAUSED')counts.WIP++;if(cur.indexOf('AWAITING DISPATCH')>=0||status==='PRODUCED')counts.DISPATCH++;if(cur.indexOf('AWAITING PRODUCTION RECORDING')>=0)counts.PENDING_RECORD++;if(status==='PARTIALLY_ISSUED')counts.PARTIAL_ISSUE++;});var dSnap=await db.collection('RequisitionDispatches').get();dSnap.forEach(function(d){if((d.data().Status||'').toLowerCase()==='pending')counts.PENDING_DISPATCH_APPROVALS++;});var fSnap=await db.collection('FormulaRequests').get();fSnap.forEach(function(d){if((d.data().Status||'').toLowerCase()==='pending')counts.FORMULA_REQUESTS++;});return ok({counts:counts});}async function submitRequest(p){var newId='REQ-'+Date.now(),ref=db.collection('Requisitions_V2').doc(newId),payload={RequestID:newId,Type:p.type||'Production',Status:'SUBMITTED',EmployeeEm:p.requesterEmail||p.employeeEmail||'',EmployeeName:p.requesterName||p.employeeName||'',ProductName:p.productName||'',RequestedQty:p.requestedQty!=null?p.requestedQty:p.quantity,Formulaltems:p.ingredients?JSON.stringify(p.ingredients):'[]',Additionalltems:p.packing?JSON.stringify(p.packing):'[]',ManagerEmail:p.managerEmail||'',CreatedDate:new Date().toISOString(),Unit:p.unit||'',Labels:p.labels?JSON.stringify(p.labels):'[]',Notes:p.notes||p.remarks||'',CurrentStage:'Pending Manager Approval',AdditionalItems:p.additionalItems?JSON.stringify(p.additionalItems):'[]',Corrections:'[]',BatchID:'',PartialIssuedQty:0};await ref.set(payload);return ok({requestId:newId});}async function updateRequestStage(p){var id=p.id;if(!id)return fail(new Error('No id'));var ref=db.collection('Requisitions_V2').doc(String(id).replace(/\//g,'_'));var snap=await ref.get();if(!snap.exists)return fail(new Error('Request not found'));var up={};if(p.stageAction==='PARTIAL_ISSUE'&&p.partialQty!=null)up.PartialIssuedQty=parseFloat(p.partialQty);if(p.stage)up.CurrentStage=p.stage;if(p.status)up.Status=p.status;if(Object.keys(up).length)await ref.update(up);return ok({});}async function addThreadNote(p){if(!p.id)return fail(new Error('No id'));await db.collection('RequestThreads').add({RequestID:p.id,Timestamp:new Date().toISOString(),Actor:p.role||'User',Action:'NOTE',User:p.user||'',Remarks:p.note||''});return ok({});}async function addMaterialRequest(p){if(!p.id)return fail(new Error('No id'));var ref=db.collection('Requisitions_V2').doc(String(p.id).replace(/\//g,'_')),snap=await ref.get();if(!snap.exists)return fail(new Error('Request not found'));var add=safeJson(snap.data().AdditionalItems,[]);if(!Array.isArray(add))add=[];add.push({category:p.category,itemName:p.itemName,quantity:parseFloat(p.quantity)||0});await ref.update({AdditionalItems:JSON.stringify(add)});return ok({});}async function actionRequest(p,action){var id=p.id;if(!id)return fail(new Error('No id'));var ref=db.collection('Requisitions_V2').doc(String(id).replace(/\//g,'_'));var status=action==='APPROVED'?'APPROVED':action==='REJECTED'?'REJECTED':action==='ON_HOLD'?'ON_HOLD':'ON_HOLD',stage=action==='APPROVED'?'Awaiting Material Issue':action==='REJECTED'?'Rejected':'On Hold';await ref.update({Status:status,CurrentStage:stage});return ok({});}async function getMyRequests(p){var email=(p.email||'').toLowerCase().trim(),all=await getCollectionArray('Requisitions_V2'),mine=all.filter(function(r){return(r.EmployeeEm||r.requesterEmail||'').toLowerCase()===email;});return ok({requests:mine.map(function(d){return rowToRequest(d,p.light==='1'||p.light===true);})});}async function getStockAdj(p){var all=await getCollectionArray('StockAdjustmentRequests'),list=(p.status||'').toLowerCase()?all.filter(function(r){return(r.Status||'').toLowerCase()===p.status;}):all;return ok({requests:list});}async function markStockDone(p){if(!p.requestId)return fail(new Error('No requestId'));await db.collection('StockAdjustmentRequests').doc(String(p.requestId).replace(/\//g,'_')).update({Status:'Done',DoneBy:p.doneBy||'',DoneAt:new Date().toISOString()});return ok({});}async function getDispApprovals(){var all=await getCollectionArray('RequisitionDispatches');return ok({data:all.filter(function(d){return(d.Status||'').toLowerCase()==='pending';})});}async function getDispatchesForReq(p){var snap=await db.collection('RequisitionDispatches').where('RequestID','==',p.requestId).get(),list=[];snap.forEach(function(d){list.push(d.data());});return ok({dispatches:list});}var handlers={test_connection:async function(){return ok({status:'Online'});},test:async function(){return ok({status:'Online'});},login:loginUser,get_db:getDb,save_inventory:async function(p){var pl=p.data;if(typeof pl==='string')try{pl=JSON.parse(pl);}catch(e){return fail(e);}return saveInventory(pl);},get_form_data:getFormData,get_form_products:async function(){var fd=await getFormData();return fd.result==='success'?ok({products:fd.products}):fd;},get_lists:getLists,get_requests_by_stage:getRequestsByStage,get_all_requests:getAllRequests,get_request_details:getRequestDetails,get_stage_counts:getStageCounts,get_my_requests:getMyRequests,get_pending_approvals:function(p){return getRequestsByStage({stage:'PENDING_ISSUE',limit:100});},get_material_queue:async function(){var q=await getCollectionArray('Material_Requisition_Queue');return ok({queue:q,requests:q});},get_requisition_queue:async function(){var q=await getCollectionArray('Material_Requisition_Queue');return ok({queue:q,requests:q});},get_wip_batches:async function(){return ok({batches:await getCollectionArray('WIP_Batches')});},get_pending_production:async function(){var b=await getCollectionArray('WIP_Batches');return ok({pending:b.filter(function(x){return(x.Status||x.status||'').toLowerCase()!=='completed';})});},get_stock_adjustment_requests:getStockAdj,get_pending_dispatch_approvals:getDispApprovals,get_dispatches_for_request:getDispatchesForReq,submit_request:submitRequest,create_request:submitRequest,update_request_stage:updateRequestStage,update_req_stage:updateRequestStage,add_thread_note:addThreadNote,add_material_request:addMaterialRequest,approve_request:function(p){return actionRequest(p,'APPROVED');},reject_request:function(p){return actionRequest(p,'REJECTED');},hold_request:function(p){return actionRequest(p,'ON_HOLD');},mark_stock_adjustment_done:markStockDone,consume_requisition_material:async function(p){if(!p.reqId||!p.itemName)return fail(new Error('reqId and itemName required'));return ok({message:'Recorded (Firebase)',remaining:0});}};async function callBackend(action,params){if(!db)return fail(new Error('Firebase not initialized'));params=params||{};var h=handlers[action];if(!h)return fail(new Error('Invalid action: '+action));try{return await h(params);}catch(e){return fail(e);}}function init(config){if(typeof g.firebase==='undefined'){console.error('Firebase SDK not loaded');return false;}try{g.firebase.initializeApp(config);db=g.firebase.firestore();return true;}catch(e){console.error('Firebase init failed',e);return false;}}g.FirebaseBackend={init:init,callBackend:callBackend};})(typeof window!=='undefined'?window:this);
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .portal-hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all;
        }

        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all;
        }

        .status-badge {
            @apply inline-block px-3 py-1 rounded-full text-xs font-bold;
        }

        .status-pending {
            @apply bg-yellow-100 text-yellow-800;
        }

        .status-approved {
            @apply bg-green-100 text-green-800;
        }

        .status-rejected {
            @apply bg-red-100 text-red-800;
        }

        .status-issued {
            @apply bg-blue-100 text-blue-800;
        }

        .status-completed {
            @apply bg-purple-100 text-purple-800;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Login Screen -->
    <div id="loginScreen"
        class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-gray-800">MIKLENS</h1>
                <p class="text-gray-500 mt-2">Digital Requisition System</p>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-5">
                <p id="loginHint" class="text-xs text-gray-500 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 hidden"></p>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="loginEmail" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="your.email@company.com">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit" class="w-full btn-primary">
                    LOGIN
                </button>

                <p id="loginError" class="text-red-500 text-sm text-center hidden">Invalid credentials</p>
            </form>

            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Developer: Pavan.R | v1.0</p>
            </div>
        </div>
    </div>

    <!-- Main App Container (Hidden initially) -->
    <div id="appContainer" class="portal-hidden">

        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">MIKLENS Digital Requisition</h1>
                    <p class="text-sm text-gray-500" id="userWelcome">Welcome, User</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openInventoryApp()" id="headerOpenInventoryBtn"
                        class="flex items-center gap-2 px-3 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 rounded-lg text-xs font-bold transition-all" title="Open MIKLENS Inventory Management">
                        üì¶ Inventory
                    </button>
                    <button onclick="refreshCurrentView()" id="refreshBtn"
                        class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-bold transition-all">
                        <svg id="refreshIcon" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <span>SYNC</span>
                    </button>
                    <span id="userRole"
                        class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold"></span>
                    <button type="button" onclick="openChangePasswordModal()" id="changePasswordBtn"
                        class="text-gray-600 hover:text-gray-800 text-sm font-medium" title="Change password">
                        üîë Password
                    </button>
                    <button type="button" onclick="openSettings(event)" id="settingsBtn"
                        class="text-gray-600 hover:text-gray-800" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800 font-semibold">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex gap-4" id="navTabs">
                    <!-- Dynamically populated based on role -->
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="contentArea">
                <!-- Dynamically loaded content -->
            </div>
        </main>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg m-4">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">‚öôÔ∏è</div>
                <h2 class="text-2xl font-bold text-gray-800">System Configuration</h2>
                <p class="text-gray-600 mt-2">Enter your Google Apps Script Web App URL</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Web App URL <span class="text-red-500">*</span>
                    </label>
                    <input type="url" id="configScriptUrl"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="https://script.google.com/macros/s/.../exec">
                    <p class="text-xs text-gray-500 mt-2">
                        üí° Get this URL by deploying the Google Apps Script as a Web App
                    </p>
                    <p class="text-xs text-amber-700 bg-amber-50 border border-amber-100 rounded p-2 mt-2">üîó Use the <strong>same</strong> URL as in <strong>MIKLENS Inventory Management</strong> (Cloud Connection) so dispatches and stock stay in sync.</p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800 font-semibold mb-2">üìã Quick Guide:</p>
                    <ol class="text-xs text-blue-700 space-y-1 ml-4 list-decimal">
                        <li>Open your Google Sheet</li>
                        <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                        <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                        <li>Select <strong>Web app</strong></li>
                        <li>Click <strong>Deploy</strong></li>
                        <li>Copy the URL and paste it above</li>
                    </ol>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="testConfigUrl()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all">
                        üß™ Test Connection
                    </button>
                    <button type="button" onclick="saveConfig()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all">
                        üíæ Save & Continue
                    </button>
                </div>

                <p id="configError" class="text-red-500 text-sm text-center hidden mt-4"></p>
                <p id="configSuccess" class="text-green-500 text-sm text-center hidden mt-4"></p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" onclick="closeSettings()"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 portal-hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‚öôÔ∏è Settings</h2>
                <button type="button" id="settingsCloseBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div id="settingsFirebaseStatus" class="hidden text-sm font-semibold text-green-700 bg-green-50 border border-green-200 rounded-lg p-3">‚úÖ Using Firebase (firebase-config.js). Both apps share the same data.</div>
                <div id="settingsGASBlock">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Google Apps Script Web App URL</label>
                    <input type="text" id="settingsUrlInput"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="https://script.google.com/macros/s/.../exec">
                    <p class="text-xs text-amber-700 bg-amber-50 border border-amber-100 rounded p-2 mt-2">üîó Use the <strong>same</strong> Web App URL as <strong>MIKLENS Inventory Management</strong> so dispatches and stock stay in sync.</p>
                </div>

                <p class="text-xs text-gray-500 bg-blue-50 border border-blue-100 rounded p-2">When Firebase is set in <strong>firebase-config.js</strong>, both apps use Firebase; no GAS URL needed.</p>
                <div id="settingsTestFirebaseBlock" class="hidden">
                    <button type="button" id="btnTestFirebase" class="w-full py-2 bg-green-100 text-green-800 rounded-lg font-semibold text-sm hover:bg-green-200 transition-colors">üîå Test Firebase connection</button>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Open MIKLENS Inventory (optional)</label>
                    <input type="url" id="settingsInventoryAppUrl"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                        placeholder="URL of MIKLENS Inventory Management app">
                    <button type="button" id="btnOpenInventory" onclick="openInventoryApp()" class="mt-2 w-full py-2 bg-indigo-100 text-indigo-800 rounded-lg font-semibold text-sm hover:bg-indigo-200 transition-colors">üì¶ Open MIKLENS Inventory</button>
                </div>

                <div class="text-xs text-gray-500 bg-blue-50 p-3 rounded-lg">
                    <p class="font-semibold mb-1">üí° When to update:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>After creating a new deployment</li>
                        <li>When switching to a different Google Sheet</li>
                        <li>If you get connection errors</li>
                    </ul>
                </div>

                <div class="flex gap-3">
                    <button type="button" id="settingsCancelBtn"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all">
                        Cancel
                    </button>
                    <button type="button" id="settingsSaveBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all">
                        üíæ Save & Close
                    </button>
                </div>

                <p id="settingsError" class="text-red-500 text-sm text-center hidden"></p>
                <p id="settingsSuccess" class="text-green-500 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 portal-hidden flex items-center justify-center" style="display:none">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Change password</h2>
                <button type="button" onclick="closeChangePasswordModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Set your own password. Enter your current password first.</p>
            <form id="changePasswordForm" onsubmit="return submitChangePassword(event);" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Current password</label>
                    <input type="password" id="changePwCurrent" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required minlength="1" placeholder="Current password" autocomplete="current-password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">New password</label>
                    <input type="password" id="changePwNew" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required minlength="4" placeholder="At least 4 characters" autocomplete="new-password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confirm new password</label>
                    <input type="password" id="changePwConfirm" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required minlength="4" placeholder="Same as above" autocomplete="new-password">
                </div>
                <p id="changePasswordError" class="text-red-500 text-sm hidden"></p>
                <p id="changePasswordSuccess" class="text-green-500 text-sm hidden"></p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeChangePasswordModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="changePasswordSubmitBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Update password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal / Side Panel -->
    <div id="detailsModal"
        class="portal-modal portal-hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-end"
        style="display:none">
        <div class="bg-white h-full shadow-2xl w-full max-w-2xl transform transition-transform duration-300 translate-x-full flex flex-col"
            id="detailsPanel">
            <!-- Header -->
            <div class="flex justify-between items-center p-6 border-b bg-white z-10 flex-shrink-0">
                <div>
                    <h2 class="text-xl font-black text-gray-800" id="detailsTitle">Request Details</h2>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-0.5"
                        id="detailsSubtitle">Loading information...</p>
                </div>
                <button onclick="closeDetails()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div id="detailsContent" class="p-6 space-y-8 overflow-y-auto flex-1 custom-scrollbar">

                <!-- 1. Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <p class="text-[10px] font-black text-blue-400 uppercase mb-1">Target Quantity</p>
                        <p class="text-2xl font-black text-blue-900" id="detailsQty">0.000</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Current Station</p>
                        <p class="text-xs font-black text-gray-800 uppercase" id="detailsStation">N/A</p>
                    </div>
                </div>

                <!-- 2. Recipe Section -->
                <div id="detailsRecipeSection">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest">üìã Material Checklist
                        </h3>
                        <span id="detailsRecipeStatus"
                            class="text-[8px] font-black bg-gray-100 text-gray-500 px-2 py-0.5 rounded uppercase">Pending</span>
                    </div>
                    <div id="detailsStockBanner" class="hidden mb-4"></div>
                    <div id="detailsRecipeContainer" class="space-y-2">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- 3. Corrections / Adjustments -->
                <div id="detailsCorrectionsSection" class="hidden">
                    <h3 class="font-black text-xs text-orange-400 uppercase tracking-widest mb-4">‚ö†Ô∏è Proposed Changes
                    </h3>
                    <div id="detailsCorrectionsContainer"
                        class="space-y-2 bg-orange-50 p-4 rounded-2xl border border-orange-100">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- 4. Dispatch history (when produced / dispatched) -->
                <div id="detailsDispatchSection" class="hidden">
                    <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest mb-2">üöö Dispatch History</h3>
                    <p class="text-[10px] text-gray-500 mb-3">Partial dispatches and status. Approved dispatches are reflected in Main Inventory.</p>
                    <div id="detailsDispatchHistory" class="space-y-2 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- 5. Audit Trail -->
                <div>
                    <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest mb-4">üìú Global Audit Log</h3>
                    <div id="detailsHistory" class="space-y-4">
                        <!-- Timeline items -->
                    </div>
                </div>

                <!-- 6. Interactions -->
                <div id="additionalRequestArea" class="bg-gray-50 p-6 rounded-2xl border border-gray-100 space-y-4">
                    <h3 class="font-black text-xs text-gray-400 uppercase tracking-widest">üìù Communications</h3>

                    <div id="additionalMaterialInput" class="hidden">
                        <p class="text-[10px] font-black text-gray-500 mb-2 uppercase tracking-tight">Request Extra
                            Items</p>
                        <div class="flex flex-col gap-2">
                            <select id="addMaterialCategory"
                                class="w-full px-4 py-2 border rounded-xl text-[10px] font-black uppercase tracking-tight outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="RAW">üî¨ Raw Material / Chemical</option>
                                <option value="PACKING">üì¶ Packing Material</option>
                                <option value="LABEL">üè∑Ô∏è Label / Printing</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="text" id="addMaterialName" placeholder="Item Name"
                                    class="flex-1 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="number" id="addMaterialQty" placeholder="Qty"
                                    class="w-16 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="submitAddMaterial()"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-xs hover:bg-blue-700 transition-all shadow-md">Add</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <p class="text-[10px] font-black text-gray-500 mb-2 uppercase tracking-tight">Post
                            Instruction/Note</p>
                        <div class="flex gap-2">
                            <input type="text" id="threadNoteInput" placeholder="Message..."
                                class="flex-1 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="submitThreadNote()"
                                class="bg-gray-800 text-white px-4 py-2 rounded-xl font-black text-xs">Post</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions (Sticky at bottom) -->
            <div id="detailsActionsArea" class="p-6 border-t bg-white flex gap-3 flex-shrink-0">
                <!-- Filled dynamically by actor role and status -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let currentUser = null;
        let refreshTimer = null;
        let cachedFormData = null; // To cache products/materials
        let localCorrections = {}; // STORE UNSAVED CORRECTIONS
        let currentRequest = null; // TRACK CURRENT REQ FOR UI REFRESHES
        let SCRIPT_URL = ''; // Will be set from config
        let USE_FIREBASE = false;

        // ==========================================
        // CONFIGURATION MANAGEMENT
        // ==========================================
        function loadConfig() {
            var config = typeof window.FIREBASE_CONFIG !== 'undefined' ? window.FIREBASE_CONFIG : null;
            if (config && config.apiKey && config.projectId && config.apiKey !== 'YOUR_API_KEY' && window.FirebaseBackend) {
                USE_FIREBASE = window.FirebaseBackend.init(config);
            }
            if (!USE_FIREBASE) {
                SCRIPT_URL = localStorage.getItem('DIGITAL_REQ_SCRIPT_URL') ||
                    localStorage.getItem('GAS_URL') ||
                    localStorage.getItem('inventoryCloudUrl') || '';
            }
            var hintEl = document.getElementById('loginHint');
            if (hintEl) {
                if (USE_FIREBASE) {
                    hintEl.textContent = 'Log in with your email and password. Same config for all users and devices.';
                    hintEl.classList.remove('hidden');
                } else if (!SCRIPT_URL) {
                    hintEl.textContent = 'Your admin must add Firebase config in firebase-config.js (same folder as this app). Then reload and log in with your email and password.';
                    hintEl.classList.remove('hidden');
                } else {
                    hintEl.classList.add('hidden');
                }
            }
        }
        document.addEventListener('DOMContentLoaded', loadConfig);

        /** Single backend call: Google Sheet URL or Firebase. Returns Promise<data>. */
        async function callBackend(action, params) {
            params = params || {};
            if (USE_FIREBASE && window.FirebaseBackend) {
                const data = await window.FirebaseBackend.callBackend(action, params);
                return data;
            }
            const qs = new URLSearchParams(Object.assign({ action: action }, params));
            const url = SCRIPT_URL + '?' + qs.toString();
            const res = await fetch(url, { method: 'GET', redirect: 'follow' });
            let data;
            try { data = await res.json(); } catch (e) { data = { result: 'error', error: 'Invalid response' }; }
            return data;
        }

        async function callBackendPost(action, params) {
            if (USE_FIREBASE && window.FirebaseBackend) {
                return await window.FirebaseBackend.callBackend(action, params);
            }
            const body = new URLSearchParams(Object.assign({ action: action }, params));
            const res = await fetch(SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body });
            let data;
            try { data = await res.json(); } catch (e) { data = {}; }
            return data;
        }

        // ==========================================
        // LOGIN SYSTEM
        // ==========================================
        async function handleLogin(event) {
            event.preventDefault();
            loadConfig();

            if (!USE_FIREBASE && !SCRIPT_URL) {
                document.getElementById('loginError').textContent = 'Firebase not configured. Ask your admin to set firebase-config.js.';
                document.getElementById('loginError').classList.remove('hidden');
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showToast('Logging in...', 'info');

            try {
                const data = await callBackendPost('login', { email: email, password: password });
                if (data.result === 'success') {
                    currentUser = data.user;
                    currentUser.role = normalizeRole(currentUser.role);
                    localStorage.setItem('miklens_user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    document.getElementById('loginError').textContent = userFriendlyError(data.error) || 'Invalid credentials';
                    document.getElementById('loginError').classList.remove('hidden');
                    showToast('Login failed', 'error');
                }
            } catch (error) {
                console.error(error);
                document.getElementById('loginError').textContent = USE_FIREBASE ? 'Connection error. Check Firebase config.' : 'Connection error. Check System URL.';
                document.getElementById('loginError').classList.remove('hidden');
                showToast('Connection error.', 'error');
            }
        }

        function showApp() {
            // Hide login screen
            document.getElementById('loginScreen').classList.add('portal-hidden');
            document.getElementById('loginScreen').style.display = 'none';

            // Show app
            document.getElementById('appContainer').classList.remove('portal-hidden');
            document.getElementById('appContainer').style.display = 'block';

            // Clear any error messages
            document.getElementById('loginError').classList.add('hidden');

            // Set user info
            document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.name}`;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();

            initializePortal(currentUser.role);

            // Preload form data in background so Product Name dropdown is ready when user opens New Request
            loadFormDropdowns();
        }

        function logout() {
            localStorage.removeItem('miklens_user');
            currentUser = null;

            // Show login screen
            document.getElementById('loginScreen').classList.remove('portal-hidden');
            document.getElementById('loginScreen').style.display = 'block';

            // Hide app
            document.getElementById('appContainer').classList.add('portal-hidden');
            document.getElementById('appContainer').style.display = 'none';

            // Reset form
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        // ==========================================
        // SETTINGS MODAL
        // ==========================================
        function openSettings(e) {
            if (e) e.stopPropagation();
            loadConfig();
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            const urlInput = document.getElementById('settingsUrlInput');
            if (urlInput) urlInput.value = SCRIPT_URL || '';
            const invUrlInput = document.getElementById('settingsInventoryAppUrl');
            if (invUrlInput) invUrlInput.value = localStorage.getItem('MIKLENS_INVENTORY_APP_URL') || '';
            document.getElementById('settingsError').classList.add('hidden');
            document.getElementById('settingsSuccess').classList.add('hidden');
            const fbStatus = document.getElementById('settingsFirebaseStatus');
            const gasBlock = document.getElementById('settingsGASBlock');
            const testFbBlock = document.getElementById('settingsTestFirebaseBlock');
            if (USE_FIREBASE) {
                if (fbStatus) { fbStatus.classList.remove('hidden'); }
                if (gasBlock) { gasBlock.classList.add('hidden'); }
                if (testFbBlock) { testFbBlock.classList.remove('hidden'); }
            } else {
                if (fbStatus) { fbStatus.classList.add('hidden'); }
                if (gasBlock) { gasBlock.classList.remove('hidden'); }
                if (testFbBlock) { testFbBlock.classList.add('hidden'); }
            }
            modal.classList.remove('portal-hidden');
            modal.style.display = 'flex';
        }

        function openInventoryApp() {
            const url = localStorage.getItem('MIKLENS_INVENTORY_APP_URL') || (document.getElementById('settingsInventoryAppUrl') && document.getElementById('settingsInventoryAppUrl').value) || '';
            if (url && url.startsWith('http')) {
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                showToast('Set MIKLENS Inventory URL in Settings (gear icon)', 'warning');
                openSettings();
            }
        }

        function saveFirebaseConfig() {
            const el = document.getElementById('settingsFirebaseConfig');
            const raw = (el && el.value) ? el.value.trim() : '';
            if (!raw) {
                showToast('Paste your Firebase config JSON first.', 'warning');
                return;
            }
            function extractJsonObject(str) {
                try { return JSON.parse(str); } catch (_) {}
                var start = str.indexOf('{');
                if (start < 0) return null;
                var depth = 0, end = start;
                for (var i = start; i < str.length; i++) {
                    if (str[i] === '{') depth++;
                    if (str[i] === '}') { depth--; if (depth === 0) { end = i; break; } }
                }
                var extracted = str.substring(start, end + 1);
                try { return JSON.parse(extracted); } catch (_) {}
                // Firebase Console copies JS object literal (unquoted keys); JSON.parse fails. Parse as JS.
                try {
                    extracted = extracted.replace(/\/\/[^\n]*/g, ''); // strip single-line comments
                    var fn = new Function('return (' + extracted + ')');
                    var obj = fn();
                    if (obj && typeof obj === 'object') return obj;
                } catch (_) {}
                return null;
            }
            try {
                const config = extractJsonObject(raw);
                if (!config) {
                    if (raw.indexOf('{') < 0) {
                        showToast('Paste the full Firebase config. In Firebase Console go to Project settings ‚Üí Your apps ‚Üí copy the entire config object (starts with { and includes apiKey, projectId, appId).', 'error');
                    } else {
                        showToast('Could not parse config. Paste the complete JSON object or "const firebaseConfig = { ... }" from Firebase Console.', 'error');
                    }
                    return;
                }
                if (!config.apiKey || !config.projectId) {
                    showToast('Config is incomplete: must include apiKey and projectId. Copy the full config from Firebase Console (Project settings ‚Üí Your apps).', 'error');
                    return;
                }
                localStorage.setItem('FIREBASE_CONFIG', JSON.stringify(config));
                localStorage.removeItem('DIGITAL_REQ_SCRIPT_URL');
                USE_FIREBASE = true;
                SCRIPT_URL = '';
                if (window.FirebaseBackend) window.FirebaseBackend.init(config);
                showToast('Firebase config saved. Reload the page to use Firebase.', 'success');
            } catch (e) {
                showToast('Invalid config: ' + (e.message || ''), 'error');
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.add('portal-hidden');
                modal.style.display = 'none';
            }
        }

        function openChangePasswordModal() {
            if (!currentUser || !currentUser.email) return;
            const modal = document.getElementById('changePasswordModal');
            if (!modal) return;
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
            modal.classList.remove('portal-hidden');
            modal.style.display = 'flex';
        }
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.classList.add('portal-hidden');
                modal.style.display = 'none';
            }
        }
        async function submitChangePassword(ev) {
            if (ev) ev.preventDefault();
            if (!currentUser || !currentUser.email) return false;
            const current = document.getElementById('changePwCurrent').value;
            const newPw = document.getElementById('changePwNew').value;
            const confirmPw = document.getElementById('changePwConfirm').value;
            const errEl = document.getElementById('changePasswordError');
            const okEl = document.getElementById('changePasswordSuccess');
            const btn = document.getElementById('changePasswordSubmitBtn');
            errEl.classList.add('hidden');
            okEl.classList.add('hidden');
            if (newPw.length < 4) {
                errEl.textContent = 'New password must be at least 4 characters.';
                errEl.classList.remove('hidden');
                return false;
            }
            if (newPw !== confirmPw) {
                errEl.textContent = 'New password and confirm do not match.';
                errEl.classList.remove('hidden');
                return false;
            }
            if (btn) { btn.disabled = true; btn.textContent = 'Updating...'; }
            try {
                const data = await callBackendPost('change_password', {
                    email: currentUser.email,
                    currentPassword: current,
                    newPassword: newPw
                });
                if (data && data.result === 'success') {
                    okEl.textContent = 'Password updated. Use your new password next time you log in.';
                    okEl.classList.remove('hidden');
                    document.getElementById('changePasswordForm').reset();
                    setTimeout(closeChangePasswordModal, 1500);
                } else {
                    errEl.textContent = (data && data.error) ? data.error : 'Failed to update password.';
                    errEl.classList.remove('hidden');
                }
            } catch (e) {
                errEl.textContent = e.message || 'Connection error.';
                errEl.classList.remove('hidden');
            }
            if (btn) { btn.disabled = false; btn.textContent = 'Update password'; }
            return false;
        }

        async function testSettingsUrl() {
            const urlInput = document.getElementById('settingsUrlInput');
            const errorMsg = document.getElementById('settingsError');
            const successMsg = document.getElementById('settingsSuccess');
            const url = urlInput.value.trim();

            // Reset messages
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');

            if (!url) {
                errorMsg.textContent = 'Please enter a URL';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                errorMsg.textContent = 'Invalid Google Apps Script URL';
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(url + '?action=test_connection', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json().catch(() => ({}));
                const success = response.ok && (data.result === 'success' || data.status === 'Online');

                if (success) {
                    successMsg.textContent = '‚úÖ Connection successful!';
                    successMsg.classList.remove('hidden');
                } else {
                    errorMsg.textContent = (data && data.error) ? data.error : (response.ok ? 'Backend returned an error.' : 'Connection failed - check URL');
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Connection test failed';
                errorMsg.classList.remove('hidden');
            }
        }

        function saveSettingsUrl() {
            const urlInput = document.getElementById('settingsUrlInput');
            const errorMsg = document.getElementById('settingsError');
            const invUrlInput = document.getElementById('settingsInventoryAppUrl');
            if (invUrlInput) localStorage.setItem('MIKLENS_INVENTORY_APP_URL', (invUrlInput.value || '').trim());

            if (USE_FIREBASE) {
                showToast('Settings saved. Using Firebase.', 'success');
                closeSettings();
                return;
            }

            const url = (urlInput && urlInput.value) ? urlInput.value.trim() : '';
            errorMsg.classList.add('hidden');
            if (!url) {
                errorMsg.textContent = 'Please enter a URL';
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                errorMsg.textContent = 'Invalid Google Apps Script URL';
                errorMsg.classList.remove('hidden');
                return;
            }
            localStorage.removeItem('FIREBASE_CONFIG');
            USE_FIREBASE = false;
            localStorage.setItem('DIGITAL_REQ_SCRIPT_URL', url);
            SCRIPT_URL = url;
            showToast('Web App URL updated successfully!', 'success');
            closeSettings();
        }

        async function testFirebaseConnection() {
            const errorMsg = document.getElementById('settingsError');
            const successMsg = document.getElementById('settingsSuccess');
            if (errorMsg) errorMsg.classList.add('hidden');
            if (successMsg) successMsg.classList.add('hidden');
            if (!USE_FIREBASE || !window.FirebaseBackend) {
                if (errorMsg) { errorMsg.textContent = 'Firebase not configured.'; errorMsg.classList.remove('hidden'); }
                return;
            }
            try {
                const data = await window.FirebaseBackend.callBackend('test_connection', {});
                if (data && (data.result === 'success' || data.status === 'Online')) {
                    if (successMsg) { successMsg.textContent = '‚úÖ Firebase connection successful!'; successMsg.classList.remove('hidden'); }
                } else {
                    if (errorMsg) { errorMsg.textContent = (data && data.error) || 'Connection failed'; errorMsg.classList.remove('hidden'); }
                }
            } catch (e) {
                if (errorMsg) { errorMsg.textContent = 'Connection failed: ' + (e.message || ''); errorMsg.classList.remove('hidden'); }
            }
        }


        // ==========================================
        // PORTAL INITIALIZATION
        // ==========================================
        function initializePortal(rawRole) {
            const role = normalizeRole(rawRole); // Ensure "Store" works as "Store Incharge"
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';

            // Manager and Admin have identical permissions. Operator role removed ‚Äì treated as Manager.
            const managerAdminTabs = [
                { id: 'pending-approvals', label: 'Pending Approvals', icon: '‚è≥' },
                { id: 'pending-issue', label: 'Pending Issue', icon: 'üì¶' },
                { id: 'pending-record', label: 'Pending Recording', icon: 'üíæ' },
                { id: 'pending-dispatch-approvals', label: 'Dispatch Approvals', icon: 'üöö' },
                { id: 'dispatch-queue', label: 'Dispatch Queue', icon: 'üö¢' },
                { id: 'formula-requests', label: 'Formula Requests', icon: 'üß™' },
                { id: 'wip-management', label: 'WIP Monitor', icon: '‚öôÔ∏è' },
                { id: 'admin-control', label: 'System Control', icon: 'üõ†Ô∏è' },
                { id: 'all-requests', label: 'Master Archive', icon: 'üìÅ' }
            ];
            const portals = {
                'Store Incharge': [
                    { id: 'pending-issue', label: 'Pending Issue', icon: 'üì¶' },
                    { id: 'partial-issue', label: 'Partial / Incomplete', icon: 'üìã' },
                    { id: 'wip-management', label: 'WIP Monitor', icon: '‚öôÔ∏è' },
                    { id: 'issued-items', label: 'Issued Items', icon: '‚úÖ' }
                ],
                'Employee': [
                    { id: 'my-requests', label: 'My Requests', icon: 'üìã' },
                    { id: 'wip-management', label: 'Production Tasks', icon: 'üè≠' },
                    { id: 'new-request', label: 'New Request', icon: '‚ûï' },
                    { id: 'request-new-formula', label: 'Request New Formula', icon: 'üß™' }
                ],
                'Manager': managerAdminTabs,
                'Admin': managerAdminTabs
            };

            const tabs = portals[role] || [];
            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = `px-6 py-4 text-sm font-semibold border-b-2 transition-colors flex items-center gap-1.5 ${index === 0 ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}`;
                button.dataset.tabId = tab.id;
                button.innerHTML = `${tab.icon} ${tab.label}<span class="tab-badge hidden ml-1.5 min-w-[20px] h-[20px] px-1 rounded-full bg-red-500 text-white text-[11px] font-black inline-flex items-center justify-center shadow-md ring-2 ring-white">0</span>`;
                button.onclick = (e) => loadView(tab.id, role, e);
                navTabs.appendChild(button);
            });

            // Load first view
            if (tabs.length > 0) {
                loadView(tabs[0].id, role);
            }
            fetchTabCounts();
        }

        async function fetchTabCounts() {
            try {
                const data = await callBackend('get_stage_counts', {});
                if (data.result !== 'success' || !data.counts) return;
                const c = data.counts;
                const map = {
                    'pending-issue': c.PENDING_ISSUE || 0,
                    'partial-issue': c.PARTIAL_ISSUE || 0,
                    'wip-management': c.WIP || 0,
                    'dispatch-queue': c.DISPATCH || 0,
                    'pending-record': c.PENDING_RECORD || 0,
                    'pending-approvals': c.PENDING_APPROVALS || 0,
                    'formula-requests': c.FORMULA_REQUESTS || 0,
                    'pending-dispatch-approvals': c.PENDING_DISPATCH_APPROVALS || 0
                };
                document.querySelectorAll('#navTabs button[data-tab-id]').forEach(btn => {
                    const tabId = btn.dataset.tabId;
                    const n = map[tabId] != null ? map[tabId] : 0;
                    const badge = btn.querySelector('.tab-badge');
                    if (badge) {
                        if (n > 0) {
                            badge.textContent = n > 99 ? '99+' : n;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                });
            } catch (e) { /* ignore */ }
        }

        // ROLE NORMALIZATION HELPER
        function normalizeRole(role) {
            if (!role) return role;
            const r = role.toLowerCase().trim();
            if (r === 'store' || r === 'storekeeper' || r === 'store incharge') return 'Store Incharge';
            if (r === 'operator') return 'Manager'; // Operator role removed ‚Äì same permissions as Manager
            return role;
        }

        // ==========================================
        // IN-MEMORY VIEW CACHE (session only, no localStorage)
        // ==========================================
        const VIEW_CACHE_TTL_MS = 6000;
        let viewCache = {};
        function invalidateViewCache(viewIdOrAll) {
            if (viewIdOrAll === true) { viewCache = {}; detailCache = {}; }
            else if (viewIdOrAll) delete viewCache[viewIdOrAll];
        }
        function getCachedView(viewId) {
            const c = viewCache[viewId];
            if (!c || (Date.now() - c.ts) > VIEW_CACHE_TTL_MS) return null;
            return c.html;
        }
        function setCachedView(viewId, html) {
            viewCache[viewId] = { html: html, ts: Date.now() };
        }
        const CACHEABLE_VIEWS = ['my-requests','pending-approvals','all-requests','pending-issue','partial-issue','pending-record','wip-management','dispatch-queue','dispatch','issued-items','pending-dispatch-approvals','master_archive','formula-requests'];

        // Detail panel cache (in-memory, no localStorage)
        const DETAIL_CACHE_TTL_MS = 8000;
        let detailCache = {};
        function getCachedDetail(id) {
            const c = detailCache[String(id)];
            if (!c || (Date.now() - c.ts) > DETAIL_CACHE_TTL_MS) return null;
            return c.data;
        }
        function setCachedDetail(id, data) {
            detailCache[String(id)] = { data: data, ts: Date.now() };
        }
        function getDetailSkeletonHTML() {
            return `
                <div class="flex justify-between items-center py-2 border-b border-gray-100"><div class="h-3 bg-gray-200 rounded w-24 animate-pulse"></div><div class="h-3 bg-gray-200 rounded w-16 animate-pulse"></div></div>
                <div class="flex justify-between items-center py-2 border-b border-gray-100"><div class="h-3 bg-gray-200 rounded w-32 animate-pulse"></div><div class="h-3 bg-gray-200 rounded w-14 animate-pulse"></div></div>
                <div class="flex justify-between items-center py-2 border-b border-gray-100"><div class="h-3 bg-gray-200 rounded w-28 animate-pulse"></div><div class="h-3 bg-gray-200 rounded w-12 animate-pulse"></div></div>
            `;
        }
        function getHistorySkeletonHTML() {
            return `
                <div class="flex gap-4 items-start pb-4"><div class="w-3.5 h-3.5 rounded-full bg-gray-200 animate-pulse mt-1"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-32 mb-2 animate-pulse"></div><div class="h-2 bg-gray-100 rounded w-40 animate-pulse"></div></div></div>
                <div class="flex gap-4 items-start pb-4"><div class="w-3.5 h-3.5 rounded-full bg-gray-200 animate-pulse mt-1"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-28 mb-2 animate-pulse"></div><div class="h-2 bg-gray-100 rounded w-36 animate-pulse"></div></div></div>
                <div class="flex gap-4 items-start pb-4"><div class="w-3.5 h-3.5 rounded-full bg-gray-200 animate-pulse mt-1"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-24 mb-2 animate-pulse"></div><div class="h-2 bg-gray-100 rounded w-32 animate-pulse"></div></div></div>
            `;
        }

        function getSkeletonListHTML(count) {
            count = count || 5;
            let h = '';
            for (let i = 0; i < count; i++) {
                h += `<div class="bg-white rounded-xl border border-gray-100 p-4 mb-3 animate-pulse">
                    <div class="flex justify-between gap-4"><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-20 mb-2"></div><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-100 rounded w-24"></div></div><div class="h-8 w-12 bg-gray-200 rounded"></div></div>
                </div>`;
            }
            return h;
        }

        // ==========================================
        // VIEW LOADING
        // ==========================================
        function loadView(viewId, role, clickEvent) {
            const contentArea = document.getElementById('contentArea');
            if (!contentArea) return;

            // Update active tab only if there's a click event
            if (clickEvent && clickEvent.target) {
                document.querySelectorAll('#navTabs button').forEach(btn => {
                    btn.className = btn.className.replace('border-blue-600 text-blue-600', 'border-transparent text-gray-600');
                });
                clickEvent.target.className += ' border-blue-600 text-blue-600';
            }

            // Serve from in-memory cache if valid (instant tab switch)
            if (CACHEABLE_VIEWS.indexOf(viewId) !== -1) {
                const cached = getCachedView(viewId);
                if (cached) {
                    contentArea.innerHTML = cached;
                    return;
                }
            }

            // Non-cacheable or cache miss: show lightweight skeleton then load
            contentArea.innerHTML = '<div class="p-4 min-h-[200px]">' + getSkeletonListHTML(4) + '</div>';

            // Load view content
            switch (viewId) {
                case 'my-requests':
                    renderMyRequests();
                    break;
                case 'new-request':
                    renderNewRequestForm();
                    break;
                case 'pending-approvals':
                    renderPendingApprovals();
                    break;
                case 'all-requests':
                    renderManagerHistory();
                    break;
                case 'pending-issue':
                    renderPendingIssue();
                    break;
                case 'partial-issue':
                    renderPartialIssue();
                    break;
                case 'pending-record':
                    renderPendingRecord();
                    break;
                case 'wip-management':
                    renderWIPManagement();
                    break;
                case 'dispatch-queue':
                    renderDispatchQueue();
                    break;
                case 'dispatch':
                    renderDispatchView();
                    break;
                case 'pending-dispatch-approvals':
                    renderPendingDispatchApprovals();
                    break;
                case 'issued-items':
                    renderIssuedItems();
                    break;
                case 'master_archive':
                    renderMasterArchive();
                    break;
                case 'admin-control':
                    renderAdminControl();
                    break;
                case 'request-new-formula':
                    renderRequestNewFormula();
                    break;
                case 'formula-requests':
                    renderFormulaRequests();
                    break;
                default:
                    contentArea.innerHTML = `<div class="p-8 text-center"><p class="text-gray-500">View "${viewId}" pending implementation.</p></div>`;
            }
        }

        // ==========================================
        // EMPLOYEE VIEWS
        // ==========================================
        function renderMyRequests() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">My Requests</h2>
                        <button onclick="loadView('new-request')" class="btn-primary">
                            ‚ûï New Request
                        </button>
                    </div>
                    
                    <div class="space-y-4" id="requestsList">
                        ${getSkeletonListHTML(4)}
                    </div>
                </div>
            `;

            loadMyRequests();
        }

        async function loadMyRequests() {
            if (!currentUser || !currentUser.email) return;

            // Wait briefly for DOM to settle if called immediately after render
            await new Promise(r => setTimeout(r, 50));
            const listContainer = document.getElementById('requestsList');
            if (!listContainer) return;

            try {
                const data = await callBackend('get_my_requests', { email: currentUser.email, light: '1' });

                if (data.requests && data.requests.length > 0) {
                    listContainer.innerHTML = data.requests.map(req => {
                        const isApproved = ['APPROVED', 'APPROVE_REQUEST', 'ISSUED', 'RECORDED', 'PRODUCED', 'DISPATCHED'].includes(req.status);
                        const isCorrection = req.status === 'CORRECTION_REQUIRED';
                        const isRejected = ['REJECTED', 'REJECTED_BY_MANAGER', 'REJECT_REQUEST'].includes(req.status);
                        const isStoreIssuedPending = req.status === 'ISSUED_PENDING_APPROVAL';

                        const statusStyle = isApproved ? 'bg-green-100 text-green-700' :
                            isStoreIssuedPending ? 'bg-amber-100 text-amber-700' :
                            isRejected ? 'bg-red-100 text-red-700' :
                                isCorrection ? 'bg-orange-100 text-orange-700' :
                                    'bg-yellow-100 text-yellow-700';
                        const statusText = isApproved ? 'APPROVED' : (isRejected ? 'REJECTED' : (isCorrection ? 'CORRECTION' : (isStoreIssuedPending ? 'Store Issued ‚Äì Awaiting Approval' : req.status)));

                        return `
                            <div onclick="viewRequestDetails('${req.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group">
                                <div class="flex justify-between items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[8px] font-black bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded uppercase">${req.id}</span>
                                            <span class="text-[8px] font-black bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded uppercase">${req.type}</span>
                                            <span class="${statusStyle} text-[8px] font-black px-1.5 py-0.5 rounded uppercase">${statusText}</span>
                                        </div>
                                        <h3 class="font-black text-gray-900 truncate leading-tight text-base group-hover:text-blue-600 transition-colors">${req.productName}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-[8px] font-black uppercase text-gray-400">At Station:</span>
                                            <span class="text-[8px] font-black px-1.5 py-0.5 rounded border ${getStageColor(isApproved && req.currentStage.includes('MANAGER APPROVAL') ? 'Awaiting Employee Confirmation' : req.currentStage)} uppercase tracking-tighter">${isApproved && req.currentStage.includes('MANAGER APPROVAL') ? 'Awaiting Employee Confirmation' : req.currentStage}</span>
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end">
                                        <p class="text-lg font-black text-gray-800 leading-none">${req.quantity}</p>
                                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mt-1">${req.unit || 'Units'}</p>
                                        <div class="mt-2 text-blue-500 font-black text-[9px] uppercase tracking-tighter">View Details ‚Üí</div>
                                    </div>
                                </div>
                                
                                ${(req.currentStage || '').toUpperCase().indexOf('WIP') >= 0 ? `
                                <div class="mt-3 pt-3 border-t flex flex-col gap-2" onclick="event.stopPropagation()">
                                    ${(req.currentStage || '').toUpperCase().indexOf('AWAITING MANAGER APPROVAL') >= 0 ? '<p class="text-[9px] font-bold text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1">üîí Complete after Manager approves issue</p>' : ''}
                                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                                        <button onclick="triggerWIPAction(event, '${req.id}', 'PAUSE')" class="flex-1 min-w-[60px] bg-orange-50 text-orange-600 font-black py-2 rounded-lg uppercase text-[9px] border border-orange-100 hover:bg-orange-100 transition-all">‚è∏Ô∏è Pause</button>
                                        <button ${(req.currentStage || '').toUpperCase().indexOf('AWAITING MANAGER APPROVAL') >= 0 ? 'disabled' : ''} onclick="triggerWIPAction(event, '${req.id}', 'COMPLETE')" class="flex-1 min-w-[60px] bg-green-50 text-green-600 font-black py-2 rounded-lg uppercase text-[9px] border border-green-100 hover:bg-green-100 transition-all ${(req.currentStage || '').toUpperCase().indexOf('AWAITING MANAGER APPROVAL') >= 0 ? 'opacity-50 cursor-not-allowed' : ''}" title="${(req.currentStage || '').toUpperCase().indexOf('AWAITING MANAGER APPROVAL') >= 0 ? 'Unlocks after Manager approves the material issue' : ''}">‚úÖ Complete</button>
                                        <button onclick="triggerWIPAction(event, '${req.id}', 'CANCEL')" class="flex-1 min-w-[60px] bg-red-50 text-red-600 font-black py-2 rounded-lg uppercase text-[9px] border border-red-100 hover:bg-red-100 transition-all">‚ùå Cancel</button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
                else {
                    listContainer.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <p class="text-lg mb-4">No requests yet</p>
                            <button onclick="loadView('new-request')" class="btn-primary">Create Your First Request</button>
                        </div>
                    `;
                }
                const contentArea = document.getElementById('contentArea');
                if (contentArea) setCachedView('my-requests', contentArea.innerHTML);
            } catch (error) {
                console.error(error);
                showToast('Failed to load requests', 'error');
            }
        }

        function renderNewRequestForm() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">New Request</h2>
                    
                    <!-- Request Type Selection -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Request Type</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="selectRequestType('production')" id="btn-type-production"
                                    class="p-6 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                                <div class="text-4xl mb-2">üè≠</div>
                                <div class="font-bold text-gray-800">Production</div>
                                <div class="text-xs text-gray-600 mt-1">For manufacturing products</div>
                            </button>
                            <button onclick="selectRequestType('research')" id="btn-type-research"
                                    class="p-6 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors">
                                <div class="text-4xl mb-2">üî¨</div>
                                <div class="font-bold text-gray-800">Research</div>
                                <div class="text-xs text-gray-600 mt-1">For R&D and trials</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Production Form -->
                    <div id="productionForm" class="bg-white rounded-lg shadow p-6">
                        <form onsubmit="submitProductionRequest(event)" class="space-y-6">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-bold text-gray-700">Product Name</label>
                                    <button type="button" onclick="loadFormDropdowns()" class="text-xs text-blue-600 hover:text-blue-800 font-semibold">Refresh product list</button>
                                </div>
                                <select id="productSelect" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select product...</option>
                                    <!-- Populated from formulas sheet -->
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Quantity to Produce</label>
                                <div class="flex gap-4">
                                    <input type="number" id="prodQuantity" required step="0.01" 
                                           class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                           placeholder="1000">
                                    <input type="text" id="prodUnit" readonly 
                                           class="w-24 px-4 py-3 border rounded-lg bg-gray-100"
                                           placeholder="L">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Purpose / Batch ID</label>
                                <input type="text" id="prodPurpose" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Batch-B-205">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Target Date</label>
                                <input type="date" id="prodTargetDate" 
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Removed manual manager selection -->
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Remarks (Optional)</label>
                                <textarea id="prodRemarks" rows="3"
                                          class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="Any special instructions..."></textarea>
                            </div>

                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <p class="text-xs font-bold text-gray-600 mb-2">üì¶ Optional: Packing & Labels</p>
                                <p class="text-[10px] text-gray-500 mb-3">Add now if you know pack size/labels; otherwise you can add them before closing the batch (via request details ‚Üí <strong>Update packing & labels</strong>).</p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 uppercase">Packing materials</label>
                                        <div id="prodPackingRows" class="space-y-2 mt-1"></div>
                                        <button type="button" onclick="addProductionPackingRow()" class="mt-1 text-xs text-blue-600 hover:text-blue-800 font-semibold">+ Add packing item</button>
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 uppercase">Labels</label>
                                        <div id="prodLabelsRows" class="space-y-2 mt-1"></div>
                                        <button type="button" onclick="addProductionLabelsRow()" class="mt-1 text-xs text-blue-600 hover:text-blue-800 font-semibold">+ Add label item</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-4">
                                <button type="button" onclick="loadView('my-requests')" class="btn-secondary flex-1">
                                    Cancel
                                </button>
                                <button type="submit" class="btn-primary flex-1">
                                    Submit for Approval
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Research Form (MULTI-ITEM ENHANCED) -->
                    <div id="researchForm" class="bg-white rounded-lg shadow p-6 hidden">
                        <form onsubmit="submitResearchRequest(event)" class="space-y-6">
                            
                            <!-- Category Selector Tabs -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-3">Select Material Categories</label>
                                <div class="grid grid-cols-3 gap-3" id="categoryTabs">
                                    <button type="button" onclick="toggleCategory('raw')" id="tab-raw"
                                        class="category-tab p-4 border-2 border-gray-300 rounded-lg hover:border-blue-400 transition-colors text-center">
                                        <div class="text-2xl mb-1">üß™</div>
                                        <div class="text-xs font-bold text-gray-700">Raw Materials</div>
                                    </button>
                                    <button type="button" onclick="toggleCategory('packing')" id="tab-packing"
                                        class="category-tab p-4 border-2 border-gray-300 rounded-lg hover:border-blue-400 transition-colors text-center">
                                        <div class="text-2xl mb-1">üì¶</div>
                                        <div class="text-xs font-bold text-gray-700">Packing Materials</div>
                                    </button>
                                    <button type="button" onclick="toggleCategory('labels')" id="tab-labels"
                                        class="category-tab p-4 border-2 border-gray-300 rounded-lg hover:border-blue-400 transition-colors text-center">
                                        <div class="text-2xl mb-1">üè∑Ô∏è</div>
                                        <div class="text-xs font-bold text-gray-700">Labels</div>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">üí° Select one or more categories to add items from</p>
                            </div>

                            <!-- Multi-Item Entry Section -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-sm font-bold text-gray-700">Items Required</label>
                                    <span class="text-xs text-gray-500" id="itemCount">0 items</span>
                                </div>

                                <!-- Item Rows Container -->
                                <div id="itemRowsContainer" class="space-y-3">
                                    <!-- Dynamic rows will be inserted here -->
                                </div>

                                <!-- Add More Items Button -->
                                <button type="button" onclick="addItemRow()" 
                                    class="mt-3 w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-400 hover:text-blue-600 font-semibold text-sm transition-colors">
                                    ‚ûï Add More Items
                                </button>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Trial / Project Name</label>
                                <input type="text" id="resPurpose" required
                                       class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Herbicide Trial A">
                            </div>
                            
                            <!-- Removed manual manager selection -->
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Remarks (Optional)</label>
                                <textarea id="resRemarks" rows="3"
                                          class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="Purpose of R&D use..."></textarea>
                            </div>
                            
                            <div class="flex gap-4">
                                <button type="button" onclick="loadView('my-requests')" class="btn-secondary flex-1">
                                    Cancel
                                </button>
                                <button type="submit" class="btn-primary flex-1">
                                    Submit Research Request
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            loadFormDropdowns();
        }

        // ==========================================
        // EMPLOYEE FORM HELPERS
        // ==========================================
        function selectRequestType(type) {
            if (type === 'production') {
                document.getElementById('productionForm').classList.remove('hidden');
                document.getElementById('researchForm').classList.add('hidden');

                // Update button styles
                document.getElementById('btn-type-production').className = 'p-6 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors';
                document.getElementById('btn-type-research').className = 'p-6 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors';
            } else {
                document.getElementById('productionForm').classList.add('hidden');
                document.getElementById('researchForm').classList.remove('hidden');

                // Update button styles
                document.getElementById('btn-type-production').className = 'p-6 border-2 border-gray-300 rounded-lg hover:border-gray-400 transition-colors';
                document.getElementById('btn-type-research').className = 'p-6 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors';

                // Initialize research form with default rows
                setTimeout(() => initializeResearchForm(), 100);
            }
        }

        const FORM_DATA_CACHE_KEY = 'MIKLENS_REQ_FORM_DATA';
        const FORM_DATA_CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

        function getFormDataFromStorage() {
            try {
                const raw = localStorage.getItem(FORM_DATA_CACHE_KEY);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                if (!obj || !obj.data || !obj.ts) return null;
                if (Date.now() - obj.ts > FORM_DATA_CACHE_TTL_MS) return null;
                return obj.data;
            } catch (e) { return null; }
        }

        function setFormDataInStorage(data) {
            try {
                localStorage.setItem(FORM_DATA_CACHE_KEY, JSON.stringify({ data: data, ts: Date.now() }));
            } catch (e) {}
        }

        async function loadFormDropdowns() {
            const productSelect = document.getElementById('productSelect');
            const materialSelect = document.getElementById('materialSelect');

            if (productSelect) {
                productSelect.innerHTML = '<option value="">Loading products...</option>';
                productSelect.disabled = true;
            }
            if (materialSelect) {
                materialSelect.innerHTML = '<option value="">Loading materials...</option>';
                materialSelect.disabled = true;
            }

            // Optional: show last-known data while fetching. Server response overwrites (single source of truth).
            const stored = getFormDataFromStorage();
            if (stored && (stored.products?.length || stored.materials?.length)) {
                if (productSelect) productSelect.disabled = false;
                if (materialSelect) materialSelect.disabled = false;
                populateDropdowns(stored);
            }

            const FETCH_TIMEOUT_MS = 20000;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

            function applyFormData(data) {
                if (!data || data.result !== 'success') return false;
                const payload = data.data ? {
                    result: 'success',
                    products: data.data.products || [],
                    materials: data.data.materials || [],
                    rawMaterials: data.data.rawMaterials || [],
                    packingMaterials: data.data.packingMaterials || [],
                    labels: data.data.labels || []
                } : data;
                if (!payload.products && !payload.materials) return false;
                cachedFormData = payload;
                setFormDataInStorage(payload);
                if (productSelect) productSelect.disabled = false;
                if (materialSelect) materialSelect.disabled = false;
                populateDropdowns(payload);
                return true;
            }

            try {
                // 1) Same call as old requisition app ‚Äì get_lists (Data sheet + FormCache). Fast and reliable.
                clearTimeout(timeoutId);
                const data = await callBackend('get_lists', {}).catch(() => ({}));
                if (applyFormData(data)) return;

                // 2) Fallback: get_form_data (builds from Database if FormCache empty)
                const fallbackData = await callBackend('get_form_data', {}).catch(() => ({}));
                if (applyFormData(fallbackData)) return;

                if (productSelect) {
                    productSelect.disabled = false;
                    productSelect.innerHTML = '<option value="">Select product...</option><option value="">No data ‚Äì run seedFormCacheFromDatabase in Apps Script once</option>';
                }
                if (materialSelect) materialSelect.disabled = false;
                showToast('No products from server. Run seedFormCacheFromDatabase in Apps Script once.', 'warning');
            } catch (error) {
                clearTimeout(timeoutId);
                const isTimeout = error && error.name === 'AbortError';
                if (productSelect) {
                    productSelect.disabled = false;
                    productSelect.innerHTML = '<option value="">Select product...</option><option value="">' + (isTimeout ? 'Timed out. Click Retry load.' : 'Load failed. Check Web App URL.') + '</option>';
                }
                if (materialSelect) {
                    materialSelect.disabled = false;
                    materialSelect.innerHTML = '<option value="">Select material...</option>';
                }
                showToast(isTimeout ? 'Timed out. Click Retry load.' : 'Load failed. Check Web App URL in Settings.', 'error');
                console.error('Form data fetch failed:', error);
            }
        }

        // Helper to handle the actual DOM manipulation
        function populateDropdowns(data) {
            // 1. Populate product dropdown (Production)
            const productSelect = document.getElementById('productSelect');
            if (productSelect && data.products && data.products.length > 0) {
                productSelect.innerHTML = '<option value="">Select product...</option>';
                data.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    option.dataset.unit = product.unit || 'L';
                    productSelect.appendChild(option);
                });

                productSelect.onchange = function () {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.unit) {
                        document.getElementById('prodUnit').value = selectedOption.dataset.unit;
                    }
                };
                console.log(`‚úÖ Populated ${data.products.length} products`);
            }

            // 2. Populate material dropdown (Research)
            const materialSelect = document.getElementById('materialSelect');
            if (materialSelect && data.materials && data.materials.length > 0) {
                materialSelect.innerHTML = '<option value="">Select material...</option>';
                data.materials.forEach(mat => {
                    const option = document.createElement('option');
                    option.value = mat.name;
                    option.textContent = `[${mat.category.charAt(0).toUpperCase()}] ${mat.name}`;
                    option.dataset.unit = mat.unit || 'Kg';
                    materialSelect.appendChild(option);
                });

                materialSelect.onchange = function () {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.unit) {
                        document.getElementById('resUnit').value = selectedOption.dataset.unit;
                    }
                };
                console.log(`‚úÖ Populated ${data.materials.length} materials`);
            }
        }

        let prodPackingLabelsRowId = 0;
        function addProductionPackingRow() {
            const container = document.getElementById('prodPackingRows');
            if (!container) return;
            const data = (typeof cachedFormData !== 'undefined' && cachedFormData && cachedFormData.packingMaterials) ? cachedFormData.packingMaterials : [];
            const id = 'prod-pack-' + (++prodPackingLabelsRowId);
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center';
            row.dataset.rowId = id;
            let opts = '<option value="">Select...</option>';
            (data || []).forEach(m => { opts += `<option value="${(m.id || m.name || '').toString().replace(/"/g, '&quot;')}" data-name="${(m.name || '').toString().replace(/"/g, '&quot;')}" data-unit="${(m.unit || '').toString().replace(/"/g, '&quot;')}">${(m.name || m.id || '').toString().replace(/</g, '&lt;')}</option>`; });
            row.innerHTML = `
                <select class="prod-pack-select flex-1 px-2 py-1.5 border rounded text-sm" data-role="packing">
                    ${opts}
                </select>
                <input type="number" class="prod-pack-qty w-20 px-2 py-1.5 border rounded text-sm" step="0.01" min="0" placeholder="Qty">
                <span class="prod-pack-unit text-xs text-gray-500 w-8"></span>
                <button type="button" onclick="this.closest('[data-row-id]').remove()" class="text-red-500 hover:text-red-700 text-sm font-bold">‚úï</button>
            `;
            row.querySelector('.prod-pack-select').onchange = function() {
                const opt = this.options[this.selectedIndex];
                row.querySelector('.prod-pack-unit').textContent = opt && opt.dataset.unit ? opt.dataset.unit : '';
            };
            container.appendChild(row);
        }
        function addProductionLabelsRow() {
            const container = document.getElementById('prodLabelsRows');
            if (!container) return;
            const data = (typeof cachedFormData !== 'undefined' && cachedFormData && cachedFormData.labels) ? cachedFormData.labels : [];
            const id = 'prod-lbl-' + (++prodPackingLabelsRowId);
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center';
            row.dataset.rowId = id;
            let opts = '<option value="">Select...</option>';
            (data || []).forEach(m => { opts += `<option value="${(m.id || m.name || '').toString().replace(/"/g, '&quot;')}" data-name="${(m.name || '').toString().replace(/"/g, '&quot;')}" data-unit="${(m.unit || '').toString().replace(/"/g, '&quot;')}">${(m.name || m.id || '').toString().replace(/</g, '&lt;')}</option>`; });
            row.innerHTML = `
                <select class="prod-pack-select flex-1 px-2 py-1.5 border rounded text-sm" data-role="labels">
                    ${opts}
                </select>
                <input type="number" class="prod-pack-qty w-20 px-2 py-1.5 border rounded text-sm" step="0.01" min="0" placeholder="Qty">
                <span class="prod-pack-unit text-xs text-gray-500 w-8"></span>
                <button type="button" onclick="this.closest('[data-row-id]').remove()" class="text-red-500 hover:text-red-700 text-sm font-bold">‚úï</button>
            `;
            row.querySelector('.prod-pack-select').onchange = function() {
                const opt = this.options[this.selectedIndex];
                row.querySelector('.prod-pack-unit').textContent = opt && opt.dataset.unit ? opt.dataset.unit : '';
            };
            container.appendChild(row);
        }
        function getProductionPackingLabelsJson(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            const arr = [];
            container.querySelectorAll('.prod-pack-select').forEach(sel => {
                const opt = sel.options[sel.selectedIndex];
                if (!opt || !opt.value) return;
                const qty = parseFloat(sel.closest('[data-row-id]').querySelector('.prod-pack-qty').value);
                if (isNaN(qty) || qty <= 0) return;
                arr.push({
                    itemId: opt.value,
                    name: opt.dataset.name || opt.textContent,
                    quantity: qty,
                    unit: opt.dataset.unit || ''
                });
            });
            return arr;
        }

        async function submitProductionRequest(event) {
            event.preventDefault();
            const btn = event.submitter || event.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></span>Submitting...'; }

            const requestData = {
                action: 'create_request',
                type: 'production',
                requesterEmail: currentUser.email,
                requesterName: currentUser.name,
                productName: document.getElementById('productSelect').value,
                quantity: document.getElementById('prodQuantity').value,
                unit: document.getElementById('prodUnit').value,
                purpose: document.getElementById('prodPurpose').value,
                targetDate: document.getElementById('prodTargetDate').value,
                remarks: document.getElementById('prodRemarks').value,
                idempotency_key: (currentUser.email || '') + '_' + Math.floor(Date.now() / 5000)
            };
            const packingJson = getProductionPackingLabelsJson('prodPackingRows');
            const labelsJson = getProductionPackingLabelsJson('prodLabelsRows');
            if (packingJson.length) requestData.packingJson = JSON.stringify(packingJson);
            if (labelsJson.length) requestData.labelsJson = JSON.stringify(labelsJson);

            showToast('Submitting request...', 'info');

            try {
                const action = requestData.action || 'submit_request';
                const params = Object.assign({}, requestData); delete params.action;
                const data = await callBackend(action, params);

                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast(data.duplicate ? 'Request already submitted (duplicate prevented).' : 'Request submitted successfully!', 'success');
                    loadView('my-requests', 'Employee');
                } else {
                    showToast(userFriendlyError(data.error) || 'Failed to submit request.', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = 'Submit Request'; }
            }
        }

        // ==========================================
        // MULTI-ITEM FORM MANAGEMENT
        // ==========================================

        let selectedCategories = new Set();
        let itemRowCounter = 0;

        function toggleCategory(category) {
            const tab = document.getElementById(`tab-${category}`);

            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
                tab.classList.remove('border-blue-500', 'bg-blue-50');
                tab.classList.add('border-gray-300');
            } else {
                selectedCategories.add(category);
                tab.classList.remove('border-gray-300');
                tab.classList.add('border-blue-500', 'bg-blue-50');
            }


            // Refresh all existing dropdowns to show items from currently selected categories
            const rows = document.querySelectorAll('.item-row');
            const categoriesToShow = Array.from(selectedCategories);

            if (categoriesToShow.length === 0) {
                // Clear all rows if no categories selected
                document.getElementById('itemRowsContainer').innerHTML = '';
                updateItemCount();
            } else {
                // Update all dropdowns to match new category selection
                rows.forEach(row => {
                    const select = row.querySelector('.item-select');
                    if (select) {
                        const currentValue = select.value;
                        populateItemDropdown(select, categoriesToShow);
                        // Try to restore selection if still valid
                        if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                            select.value = currentValue;
                        }
                    }
                });
            }
        }

        function addItemRow(category = null) {
            const container = document.getElementById('itemRowsContainer');
            if (!container) return;

            const rowId = `item-row-${++itemRowCounter}`;

            // Determine which categories to show in dropdown
            const categoriesToShow = category ? [category] : Array.from(selectedCategories);
            if (categoriesToShow.length === 0 && !category) {
                showToast('Please select at least one category first', 'warning');
                return;
            }

            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'item-row flex gap-2 items-start p-3 bg-gray-50 rounded-lg border border-gray-200';
            row.innerHTML = `
                <div class="flex-1 grid grid-cols-12 gap-2">
                    <div class="col-span-5">
                        <select class="item-select w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                                onchange="updateItemUnit(this, '${rowId}')">
                            <option value="">Select item...</option>
                        </select>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="item-quantity w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                               placeholder="Qty" step="0.01" min="0">
                    </div>
                    <div class="col-span-3">
                        <input type="text" class="item-unit w-full px-3 py-2 border rounded-lg text-sm bg-gray-100" 
                               placeholder="Unit" readonly>
                    </div>
                    <div class="col-span-1 flex items-center">
                        <button type="button" onclick="removeItemRow('${rowId}')" 
                                class="text-red-500 hover:text-red-700 font-bold text-lg px-2">
                            ‚úï
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(row);

            // Populate the dropdown with materials from selected/specified categories
            populateItemDropdown(row.querySelector('.item-select'), categoriesToShow);
            updateItemCount();
        }

        function populateItemDropdown(selectElement, categories) {
            if (!cachedFormData || !cachedFormData.materials) return;

            selectElement.innerHTML = '<option value="">Select item...</option>';

            cachedFormData.materials.forEach(mat => {
                // Map category names
                const matCategory = mat.category.toLowerCase();
                const matchesCategory = categories.some(cat => {
                    if (cat === 'raw' && (matCategory.includes('raw') || matCategory.includes('chemical'))) return true;
                    if (cat === 'packing' && matCategory.includes('packing')) return true;
                    if (cat === 'labels' && matCategory.includes('label')) return true;
                    return false;
                });

                if (matchesCategory) {
                    const option = document.createElement('option');
                    option.value = mat.name;
                    option.textContent = `${mat.name}`;
                    option.dataset.unit = mat.unit || 'Kg';
                    option.dataset.category = mat.category;
                    selectElement.appendChild(option);
                }
            });
        }

        function updateItemUnit(selectElement, rowId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const row = document.getElementById(rowId);
            if (row && selectedOption.dataset.unit) {
                row.querySelector('.item-unit').value = selectedOption.dataset.unit;
            }
        }

        function removeItemRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateItemCount();
            }
        }

        function updateItemCount() {
            const container = document.getElementById('itemRowsContainer');
            const countDisplay = document.getElementById('itemCount');
            if (container && countDisplay) {
                const rows = container.querySelectorAll('.item-row');
                countDisplay.textContent = `${rows.length} items`;
            }
        }

        function collectItemsData() {
            const rows = document.querySelectorAll('.item-row');
            const items = [];

            rows.forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = row.querySelector('.item-quantity').value;
                const unit = row.querySelector('.item-unit').value;

                if (select.value && quantity && parseFloat(quantity) > 0) {
                    const selectedOption = select.options[select.selectedIndex];
                    items.push({
                        name: select.value,
                        category: selectedOption.dataset.category || 'Raw Materials',
                        quantity: parseFloat(quantity),
                        unit: unit || 'Kg'
                    });
                }
            });

            return items;
        }

        // Initialize form with default rows when Research is selected
        function initializeResearchForm() {
            // Auto-select all categories by default
            selectedCategories = new Set(['raw', 'packing', 'labels']);
            ['raw', 'packing', 'labels'].forEach(cat => {
                const tab = document.getElementById(`tab-${cat}`);
                if (tab) {
                    tab.classList.remove('border-gray-300');
                    tab.classList.add('border-blue-500', 'bg-blue-50');
                }
            });

            // Add 5 default rows
            const container = document.getElementById('itemRowsContainer');
            if (container) {
                container.innerHTML = ''; // Clear any existing
                for (let i = 0; i < 5; i++) {
                    addItemRow('raw'); // Default to raw materials
                }
            }
        }

        async function submitResearchRequest(event) {
            event.preventDefault();
            const btn = event.submitter || event.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full mr-2"></span>Submitting...'; }

            // Collect all items
            const items = collectItemsData();

            // Validation: must have at least one item
            if (items.length === 0) {
                showToast('Please add at least one item with quantity', 'error');
                if (btn) { btn.disabled = false; btn.innerText = 'Submit Request'; }
                return;
            }

            const requestData = {
                action: 'create_request',
                type: 'research',
                requesterEmail: currentUser.email,
                requesterName: currentUser.name,
                items: JSON.stringify(items), // Send as JSON string
                purpose: document.getElementById('resPurpose').value,
                remarks: document.getElementById('resRemarks').value
            };

            showToast('Submitting research request...', 'info');

            try {
                const action = requestData.action || 'submit_request';
                const params = Object.assign({}, requestData); delete params.action;
                const data = await callBackend(action, params);
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast(`Research request submitted with ${items.length} items!`, 'success');
                    loadView('my-requests', 'Employee');
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (error) {
                console.error(error);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            } finally {
                if (btn) { btn.disabled = false; btn.innerText = 'Submit Request'; }
            }
        }

        // ==========================================
        // UI HELPERS & COLOR CODING
        // ==========================================
        function getStageColor(stage = '') {
            const s = stage.toUpperCase();
            if (s.includes('COMPLETED')) return 'bg-green-100 text-green-700 border-green-200';
            if (s.includes('/ WIP')) return 'bg-indigo-100 text-indigo-700 border-indigo-200';
            if (s.includes('MANAGER')) return 'bg-purple-100 text-purple-700 border-purple-200';
            if (s.includes('EMPLOYEE')) return 'bg-blue-100 text-blue-700 border-blue-200';
            if (s.includes('STORE ISSUED') || s.includes('AWAITING MANAGER APPROVAL (STORE')) return 'bg-amber-100 text-amber-700 border-amber-200';
            if (s.includes('MATERIAL') || s.includes('ISSUE')) return 'bg-orange-100 text-orange-700 border-orange-200';
            if (s.includes('MANUFACTURING') || s.includes('WIP')) return 'bg-indigo-100 text-indigo-700 border-indigo-200';
            if (s.includes('DISPATCH')) return 'bg-pink-100 text-pink-700 border-pink-200';
            if (s.includes('RECORDING')) return 'bg-green-100 text-green-700 border-green-200';
            return 'bg-gray-100 text-gray-500 border-gray-200';
        }

        function getStatusStyle(status = '') {
            const s = status.toUpperCase();
            if (s === 'APPROVED' || s === 'PRODUCED') return 'bg-green-100 text-green-700';
            if (s === 'ISSUED_PENDING_APPROVAL') return 'bg-amber-100 text-amber-700';
            if (s.includes('REJECTED')) return 'bg-red-100 text-red-700';
            if (s.includes('CORRECTION')) return 'bg-orange-100 text-orange-700';
            return 'bg-blue-100 text-blue-700';
        }

        function getStatusDisplayText(status = '') {
            const s = (status || '').toUpperCase();
            if (s === 'ISSUED_PENDING_APPROVAL') return 'Store Issued ‚Äì Awaiting Manager Approval';
            return status;
        }

        function userFriendlyError(backendMsg) {
            if (!backendMsg) return 'Something went wrong. Try again.';
            var s = String(backendMsg);
            if (/stock error|insufficient stock|missing items|no items found/i.test(s)) return 'Stock insufficient for full issue. Use Issue Partial to issue what\'s available, or add stock in Main Inventory (Stock Adjustment) and try again.';
            if (/already issued|already consumed|do not consume again/i.test(s)) return s;
            if (/already finalized|already completed/i.test(s)) return 'This request was already completed. Refresh the list.';
            if (/email is required/i.test(s)) return 'Please log in again to view details.';
            if (/unauthorized|forbidden/i.test(s)) return 'You don\'t have permission for this action.';
            if (/request not found|requisition not found/i.test(s)) return 'Request not found. It may have been deleted. Refresh the list.';
            if (/complete is locked|awaiting manager approval/i.test(s)) return s;
            return s.length > 80 ? s.substring(0, 77) + '...' : s;
        }

        const CRITICAL_ACTION_RETRY_MSG = 'Request may have succeeded. Refresh the list before retrying.';

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-orange-500'
            };

            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg fade-in`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ==========================================
        // OPERATOR PORTAL VIEWS
        // ==========================================
        // ==========================================
        // OPERATOR PORTAL VIEWS (Obsolete - Auto-Managed)
        // ==========================================
        // Functions removed for Phase 7 Automation


        function renderDispatchQueue() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üö¢ Dispatch Queue</h2>
                    <p class="text-sm text-gray-500 mb-4">Produced batches awaiting dispatch. Open a request and use <strong>Request Dispatch</strong> to submit quantity for Manager approval; once approved, it syncs to Main Inventory.</p>
                    <div class="space-y-4" id="dispatchList">
                        <div class="text-center py-12 text-gray-400">Loading ready items...</div>
                    </div>
                </div>
            `;
            loadStageRequests('DISPATCH', 'dispatchList', false, 'dispatch-queue');
        }

        function renderPendingIssue() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üì¶ Pending Material Issue</h2>
                    <p class="text-xs text-gray-500 mb-4">Includes partially issued items ‚Äì open any to issue remaining or issue more (partial).</p>
                    <div class="space-y-4" id="issueList">
                        <div class="text-center py-12 text-gray-400">Loading requisitions...</div>
                    </div>
                </div>
            `;
            loadStageRequests('PENDING_ISSUE', 'issueList', false, 'pending-issue');
        }

        function renderPartialIssue() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üìã Partial / Incomplete Issues</h2>
                    <p class="text-xs text-gray-500 mb-4">Items partially issued ‚Äì open any to issue remaining or issue more (partial). Stock already issued is deducted in Main Inventory.</p>
                    <div class="space-y-4" id="partialIssueList">
                        <div class="text-center py-12 text-gray-400">Loading...</div>
                    </div>
                </div>
            `;
            loadStageRequests('PARTIAL_ISSUE', 'partialIssueList', false, 'partial-issue');
        }

        function renderWIPManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Production in Progress (WIP)</h2>
                    <p class="text-sm text-gray-500 mb-4">Items issued to floor. Valid reasons required for all actions.</p>
                    <div class="space-y-4" id="wipList">
                        <div class="text-center py-12 text-gray-400">Loading WIP batches...</div>
                    </div>
                </div>
            `;
            loadStageRequests('WIP', 'wipList', false, 'wip-management');
        }

        function renderIssuedItems() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">‚úÖ Issued Items History</h2>
                    <p class="text-xs text-gray-500 mb-4">Fully issued and completed items. For partially issued items use the <strong>Partial / Incomplete</strong> tab.</p>
                    <div class="space-y-4" id="issuedHistoryList">
                        <div class="text-center py-12 text-gray-400">Loading history...</div>
                    </div>
                </div>
            `;
            loadStageRequests('ISSUED_HISTORY', 'issuedHistoryList', false, 'issued-items');
        }

        // Pagination State
        let stagePagination = {};

        async function loadStageRequests(stage, containerId, append = false, viewIdForCache) {
            const LIMIT = 20;
            if (!append) {
                stagePagination[stage] = 1;
            }
            const page = stagePagination[stage] || 1;

            const container = document.getElementById(containerId);
            if (!container) return;

            if (!append && viewIdForCache) container.innerHTML = getSkeletonListHTML(4);

            try {
                const data = await callBackend('get_requests_by_stage', { stage: stage, page: page, limit: LIMIT, light: '1' });

                // Remove existing "Load More" button if any
                const existingBtn = document.getElementById(`btn-load-more-${stage}`);
                if (existingBtn) existingBtn.remove();

                if (data.requests && data.requests.length > 0) {
                    const html = data.requests.map(req => {
                        return `
                            <div onclick="viewRequestDetails('${req.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group fade-in mb-3">
                                <div class="flex justify-between items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                                            <span class="text-[8px] font-black bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded uppercase">${req.type}</span>
                                            <span class="text-[8px] font-black bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${req.id}</span>
                                            <span class="text-[8px] font-black px-1.5 py-0.5 rounded border uppercase ${req.status === 'ISSUED_PENDING_APPROVAL' ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-gray-50 text-gray-400'}">${getStatusDisplayText(req.status)}</span>
                                            ${req.status === 'PARTIALLY_ISSUED' && req.partialIssuedQty != null ? `<span class="text-[8px] font-black bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded uppercase">Partial ${req.partialIssuedQty}/${req.quantity || '?'}</span>` : ''}
                                        </div>
                                        <h3 class="font-black text-gray-800 truncate text-base group-hover:text-blue-600 transition-colors leading-tight">${req.productName}</h3>
                                        <div class="flex items-center gap-3 mt-1.5">
                                            <p class="text-[9px] text-gray-400 font-black uppercase">Staff: <span class="text-gray-600">${req.requesterName}</span></p>
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end">
                                        <p class="text-lg font-black text-blue-700 leading-none">${req.quantity}</p>
                                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mt-1">${req.unit || 'Units'}</p>
                                        <div class="mt-2 text-blue-500 font-black text-[9px] uppercase tracking-tighter">Open Process ‚Üí</div>
                                    </div>
                                </div>
                                ${req.status === 'PARTIALLY_ISSUED' ? `
                                <div class="mt-3 pt-3 border-t border-indigo-100">
                                    <p class="text-[10px] font-bold text-indigo-700 bg-indigo-50 px-3 py-1.5 rounded-lg">üì¶ Partially issued ‚Äì tap to issue remaining or issue more</p>
                                </div>
                                ` : ''}
                                
                                ${stage === 'WIP' ? `
                                <div class="mt-3 pt-3 border-t">
                                    <div class="bg-blue-50 text-blue-800 text-[10px] font-bold px-3 py-2 rounded flex items-center gap-2">
                                        <span class="animate-pulse">‚öôÔ∏è</span>
                                        Production in Progress (Auto-Tracking)
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');

                    if (!append) {
                        container.innerHTML = html;
                    } else {
                        container.insertAdjacentHTML('beforeend', html);
                    }

                    // Check if we need a Load More button
                    if (data.requests.length === LIMIT) {
                        const btnId = `btn-load-more-${stage}`;
                        const btnHtml = `
                            <div id="${btnId}" class="text-center pt-4 pb-2">
                                <button onclick="stagePagination['${stage}']++; loadStageRequests('${stage}', '${containerId}', true)" 
                                        class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-colors">
                                    Load More
                                </button>
                            </div>
                         `;
                        container.insertAdjacentHTML('beforeend', btnHtml);
                    }

                } else {
                    if (!append) {
                        const emptyMsg = stage === 'DISPATCH' ? 'No batches awaiting dispatch. Produced batches will appear here for Request Dispatch.' : (stage === 'WIP' ? 'No production in progress.' : stage === 'PARTIAL_ISSUE' ? 'No partially issued items. Issue partial from Pending Issue to see them here.' : `No items currently in ${stage.replace(/_/g, ' ')} queue.`);
                        container.innerHTML = `<div class="text-center py-12 bg-gray-50 rounded-xl border border-gray-100"><p class="text-3xl mb-2">${stage === 'DISPATCH' ? 'üö¢' : stage === 'WIP' ? '‚öôÔ∏è' : stage === 'PARTIAL_ISSUE' ? 'üìã' : 'üìã'}</p><p class="text-gray-600 font-medium">${emptyMsg}</p></div>`;
                    } else {
                        // End of list
                    }
                }
                if (viewIdForCache && !append) {
                    const contentArea = document.getElementById('contentArea');
                    if (contentArea) setCachedView(viewIdForCache, contentArea.innerHTML);
                }
            } catch (err) {
                console.error(`‚ùå loadStageRequests ERROR [Stage: ${stage}]:`, err);
                if (!append && container) {
                    container.innerHTML = `<div class="text-center py-8 bg-red-50 rounded-xl border border-red-100"><p class="text-red-600 font-semibold">Failed to load</p><p class="text-sm text-red-500 mt-1">Check connection and Web App URL in Settings.</p><button type="button" onclick="loadStageRequests('${stage}', '${containerId}')" class="mt-3 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold">Retry</button></div>`;
                }
                showToast(`Failed to load ${stage} data.`, 'error');
            }
            if (typeof fetchTabCounts === 'function') fetchTabCounts();
        }

        async function handleStageAction(ev, id, action) {
            if (typeof id === 'undefined') { id = ev; ev = null; action = arguments[2] || arguments[1]; }
            var key = 'stage_' + id + '_' + action;
            if (window._actionKeys && window._actionKeys[key]) return;
            window._actionKeys = window._actionKeys || {};
            window._actionKeys[key] = true;
            if (ev && ev.target) { if (ev.target.disabled) { delete window._actionKeys[key]; return; } ev.target.disabled = true; }
            showToast('Processing...', 'info');
            try {
                let extraParams = '';
                if (action === 'PARTIAL_ISSUE') {
                    showToast('Use the "Issue Partial" button to open the form with product and ingredients.', 'info');
                    delete (window._actionKeys || {})[key];
                    if (ev && ev.target) ev.target.disabled = false;
                    return;
                }
                const params = { id, stageAction: action, user: currentUser.name, email: currentUser.email };
                if (extraParams && action === 'PARTIAL_ISSUE') {
                    const m = extraParams.match(/partialQty=([^&]+)/);
                    if (m) params.partialQty = parseFloat(m[1]) || m[1];
                }
                const data = await callBackendPost('update_request_stage', params);
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    if (action === 'ISSUE' || action === 'PARTIAL_ISSUE') {
                        if (data.newStatus === 'COMPLETED') {
                            showToast('‚úÖ Auto-Process Complete! Items issued & consumed. Request finished.', 'success');
                        } else if (data.message && data.message.indexOf('Remaining') >= 0) {
                            showToast('‚úÖ Remaining stock issued. Full quantity now issued.', 'success');
                        } else if (data.newStatus === 'PARTIALLY_ISSUED') {
                            showToast('‚úÖ Partial issue recorded. You can issue full stock (remaining) later from Pending Issue.', 'success');
                        } else {
                            showToast('‚úÖ Items Issued. Status: ' + (data.newStatus || 'PARTIALLY_ISSUED'), 'success');
                        }
                    } else {
                        showToast('Action successful!', 'success');
                    }
                    closeDetails();
                    initializePortal(currentUser.role);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    if (ev && ev.target) ev.target.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                if (ev && ev.target) ev.target.disabled = false;
            } finally {
                delete (window._actionKeys || {})[key];
            }
        }

        function openRequestDispatchModal(requestId, productName, maxQty, unit) {
            const existing = document.getElementById('requestDispatchModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'requestDispatchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110]';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl mx-4 border-t-4 border-green-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">üöö Request Dispatch</h2>
                    <p class="text-sm text-gray-500 mb-4">Product: <strong>${(productName || '').replace(/</g, '&lt;')}</strong>. Quantity will be deducted from Main Inventory after Manager approval.</p>
                    <p class="text-xs text-amber-600 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2 mb-4">üí° You can request partial dispatch (e.g. send some today, rest later). Submit multiple requests if needed.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Quantity to dispatch</label>
                            <input type="number" id="dispatchQtyInput" step="0.01" min="0.01" max="${maxQty || 999999}" value="${maxQty || ''}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Qty" aria-label="Dispatch quantity">
                            <span class="text-xs text-gray-500">${unit ? 'Unit: ' + unit : ''} (max ${maxQty || '‚Äî'})</span>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Remarks (optional)</label>
                            <input type="text" id="dispatchRemarksInput" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" placeholder="e.g. Partial send today; rest as FG">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="document.getElementById('requestDispatchModal').remove()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                        <button type="button" id="btnSubmitDispatch" onclick="submitRequestDispatch('${requestId}', '${(productName || '').replace(/'/g, "\\'")}', '${(unit || '').replace(/'/g, "\\'")}')" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Submit for Approval</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitRequestDispatch(requestId, productName, unit) {
            const qty = parseFloat(document.getElementById('dispatchQtyInput').value);
            const remarks = (document.getElementById('dispatchRemarksInput') || {}).value || '';
            if (!qty || qty <= 0) { showToast('Enter valid quantity', 'warning'); return; }
            const btn = document.getElementById('btnSubmitDispatch');
            if (btn) { btn.disabled = true; btn.textContent = 'Submitting...'; }
            showToast('Submitting dispatch request...', 'info');
            try {
                const data = await callBackendPost('request_dispatch', { requestId, productName, quantity: qty, unit, user: currentUser.name, remarks });
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('Dispatch request submitted. Awaiting Manager approval.', 'success');
                    document.getElementById('requestDispatchModal').remove();
                    closeDetails();
                    initializePortal(currentUser.role);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    if (btn) { btn.disabled = false; btn.textContent = 'Submit for Approval'; }
                }
            } catch (e) {
                console.error(e);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                if (btn) { btn.disabled = false; btn.textContent = 'Submit for Approval'; }
            }
        }

        async function renderPendingDispatchApprovals() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üöö Dispatch Approvals</h2>
                    <p class="text-sm text-gray-500 mb-6">Approve dispatch requests from Store/Operator. Approved dispatches are deducted from Main Inventory (Finished Goods).</p>
                    <div id="pendingDispatchList" class="space-y-3">Loading...</div>
                </div>
            `;
            try {
                const data = await callBackend('get_pending_dispatch_approvals', {});
                const list = (data.data || []);
                const container = document.getElementById('pendingDispatchList');
                if (list.length === 0) {
                    container.innerHTML = `
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-12 text-center">
                            <p class="text-4xl mb-3">‚úÖ</p>
                            <p class="font-semibold text-gray-700">No pending dispatch approvals</p>
                            <p class="text-sm text-gray-500 mt-1">When Store/Operator submit a "Request Dispatch", they will appear here.</p>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = list.map(d => `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-wrap items-center justify-between gap-4 hover:border-green-200 transition-colors">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-gray-800">${(d.productName || '').replace(/</g, '&lt;')}</p>
                            <p class="text-sm text-gray-500">Req: ${(d.requestId || '').replace(/</g, '&lt;')} ¬∑ ${d.quantity} ${(d.unit || '').replace(/</g, '&lt;')}</p>
                            <p class="text-xs text-gray-400">Requested by ${(d.requestedBy || '').replace(/</g, '&lt;')} ${d.requestedAt ? ' ¬∑ ' + new Date(d.requestedAt).toLocaleString() : ''}</p>
                            ${(d.remarks || '').toString().trim() ? `<p class="text-xs text-amber-600 mt-1">Note: ${(d.remarks || '').toString().replace(/</g, '&lt;')}</p>` : ''}
                        </div>
                        <button type="button" data-dispatch-id="${(d.dispatchId || d.DispatchID || d._id || '').replace(/"/g, '&quot;')}" onclick="approveDispatch('${(d.dispatchId || d.DispatchID || d._id || '').replace(/'/g, "\\'")}')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all shadow-sm" title="Approve and deduct from Main Inventory">Approve & Sync to Main Inventory</button>
                    </div>
                `).join('');
            } catch (e) {
                const container = document.getElementById('pendingDispatchList');
                if (container) container.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center"><p class="text-red-600 font-semibold">Failed to load.</p><p class="text-sm text-red-500 mt-1">Check connection and try again.</p><button onclick="renderPendingDispatchApprovals()" class="mt-3 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold">Retry</button></div>';
            }
        }

        async function approveDispatch(dispatchId) {
            const btn = document.querySelector(`#pendingDispatchList [data-dispatch-id="${dispatchId.replace(/"/g, '')}"]`);
            if (btn) { btn.disabled = true; btn.textContent = 'Approving...'; }
            showToast('Approving...', 'info');
            try {
                const approveParams = { dispatchId, user: currentUser.name, email: currentUser.email }; if (currentUser.uid) approveParams.adminUid = currentUser.uid;
                const data = await callBackendPost('approve_dispatch', approveParams);
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('Dispatch approved. Main Inventory updated.', 'success');
                    renderPendingDispatchApprovals();
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    renderPendingDispatchApprovals();
                }
            } catch (e) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                renderPendingDispatchApprovals();
            }
        }

        function openUpdatePackingLabelsModal(requestId) {
            const req = currentRequest || {};
            const packing = req.packing && Array.isArray(req.packing) ? req.packing : [];
            const labels = req.labels && Array.isArray(req.labels) ? req.labels : [];
            const existing = document.getElementById('updatePackingLabelsModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'updatePackingLabelsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110]';
            const packRows = packing.map(p => `<div class="pack-row flex gap-2 items-center"><input type="text" class="flex-1 px-2 py-1.5 border rounded text-sm" value="${(p.name || '').toString().replace(/"/g, '&quot;')}" placeholder="Name" readonly data-item-id="${(p.itemId || '').toString().replace(/"/g, '&quot;')}"><input type="number" step="0.01" class="w-20 px-2 py-1.5 border rounded text-sm pack-qty" value="${p.quantity || p.qty || ''}" placeholder="Qty"><span class="text-xs text-gray-500 w-8 pack-unit">${(p.unit || '').toString().replace(/</g, '&lt;')}</span><button type="button" onclick="this.closest('.pack-row').remove()" class="text-red-500 text-sm">‚úï</button></div>`).join('');
            const labelRows = labels.map(l => `<div class="label-row flex gap-2 items-center"><input type="text" class="flex-1 px-2 py-1.5 border rounded text-sm" value="${(l.name || '').toString().replace(/"/g, '&quot;')}" placeholder="Name" readonly data-item-id="${(l.itemId || '').toString().replace(/"/g, '&quot;')}"><input type="number" step="0.01" class="w-20 px-2 py-1.5 border rounded text-sm label-qty" value="${l.quantity || l.qty || ''}" placeholder="Qty"><span class="text-xs text-gray-500 w-8 label-unit">${(l.unit || '').toString().replace(/</g, '&lt;')}</span><button type="button" onclick="this.closest('.label-row').remove()" class="text-red-500 text-sm">‚úï</button></div>`).join('');
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl mx-4 border-t-4 border-amber-500 max-h-[80vh] overflow-y-auto">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">üì¶ Update packing & labels</h2>
                    <p class="text-xs text-gray-500 mb-4">Required before closing the batch if not added at request. Edit quantities or add items, then Save.</p>
                    <div class="space-y-4 mb-6">
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase">Packing materials</label><div id="modalPackingRows" class="space-y-2 mt-1">${packRows || '<div class="text-xs text-gray-400">None yet</div>'}</div><button type="button" onclick="addModalPackingRow()" class="mt-1 text-xs text-blue-600 font-semibold">+ Add packing</button></div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase">Labels</label><div id="modalLabelsRows" class="space-y-2 mt-1">${labelRows || '<div class="text-xs text-gray-400">None yet</div>'}</div><button type="button" onclick="addModalLabelsRow()" class="mt-1 text-xs text-blue-600 font-semibold">+ Add label</button></div>
                    </div>
                    <div class="flex gap-3"><button type="button" onclick="document.getElementById('updatePackingLabelsModal').remove()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold">Cancel</button><button type="button" id="btnSavePackingLabels" onclick="submitUpdatePackingLabels('${requestId}')" class="flex-1 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700">Save</button></div>
                </div>
            `;
            document.body.appendChild(modal);
            window._modalPackingData = packing.map(p => ({ itemId: p.itemId, name: p.name, quantity: p.quantity || p.qty, unit: p.unit }));
            window._modalLabelsData = labels.map(l => ({ itemId: l.itemId, name: l.name, quantity: l.quantity || l.qty, unit: l.unit }));
        }

        function addModalPackingRow() {
            const container = document.getElementById('modalPackingRows');
            if (!container) return;
            const data = (typeof cachedFormData !== 'undefined' && cachedFormData && cachedFormData.packingMaterials) ? cachedFormData.packingMaterials : [];
            let opts = '<option value="">Select...</option>';
            (data || []).forEach(m => { opts += `<option value="${(m.id || m.name || '').toString().replace(/"/g, '&quot;')}" data-name="${(m.name || '').toString().replace(/"/g, '&quot;')}" data-unit="${(m.unit || '').toString().replace(/"/g, '&quot;')}">${(m.name || m.id || '').toString().replace(/</g, '&lt;')}</option>`; });
            const row = document.createElement('div');
            row.className = 'pack-row flex gap-2 items-center';
            row.innerHTML = `<select class="flex-1 px-2 py-1.5 border rounded text-sm modal-pack-select">${opts}</select><input type="number" step="0.01" class="w-20 px-2 py-1.5 border rounded text-sm pack-qty" placeholder="Qty"><span class="text-xs text-gray-500 w-8"></span><button type="button" onclick="this.closest('.pack-row').remove()" class="text-red-500 text-sm">‚úï</button>`;
            if (container.querySelector('.text-gray-400')) container.innerHTML = '';
            container.appendChild(row);
        }
        function addModalLabelsRow() {
            const container = document.getElementById('modalLabelsRows');
            if (!container) return;
            const data = (typeof cachedFormData !== 'undefined' && cachedFormData && cachedFormData.labels) ? cachedFormData.labels : [];
            let opts = '<option value="">Select...</option>';
            (data || []).forEach(m => { opts += `<option value="${(m.id || m.name || '').toString().replace(/"/g, '&quot;')}" data-name="${(m.name || '').toString().replace(/"/g, '&quot;')}" data-unit="${(m.unit || '').toString().replace(/"/g, '&quot;')}">${(m.name || m.id || '').toString().replace(/</g, '&lt;')}</option>`; });
            const row = document.createElement('div');
            row.className = 'label-row flex gap-2 items-center';
            row.innerHTML = `<select class="flex-1 px-2 py-1.5 border rounded text-sm modal-label-select">${opts}</select><input type="number" step="0.01" class="w-20 px-2 py-1.5 border rounded text-sm label-qty" placeholder="Qty"><span class="text-xs text-gray-500 w-8"></span><button type="button" onclick="this.closest('.label-row').remove()" class="text-red-500 text-sm">‚úï</button>`;
            if (container.querySelector('.text-gray-400')) container.innerHTML = '';
            container.appendChild(row);
        }

        async function submitUpdatePackingLabels(requestId) {
            const packing = [];
            document.querySelectorAll('#updatePackingLabelsModal .pack-row').forEach(row => {
                const qtyIn = row.querySelector('.pack-qty, input[type=number]');
                const qty = qtyIn ? parseFloat(qtyIn.value) : 0;
                if (isNaN(qty) || qty <= 0) return;
                const sel = row.querySelector('.modal-pack-select');
                const inp = row.querySelector('input[readonly]');
                const unitEl = row.querySelector('.pack-unit, .text-xs');
                if (sel && sel.value) packing.push({ itemId: sel.value, name: (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].text) || sel.value, quantity: qty, unit: (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].dataset && sel.options[sel.selectedIndex].dataset.unit) || '' });
                else if (inp) packing.push({ itemId: inp.dataset.itemId || inp.value, name: inp.value, quantity: qty, unit: (unitEl && unitEl.textContent) || '' });
            });
            const labels = [];
            document.querySelectorAll('#updatePackingLabelsModal .label-row').forEach(row => {
                const qtyIn = row.querySelector('.label-qty, input[type=number]');
                const qty = qtyIn ? parseFloat(qtyIn.value) : 0;
                if (isNaN(qty) || qty <= 0) return;
                const sel = row.querySelector('.modal-label-select');
                const inp = row.querySelector('input[readonly]');
                const unitEl = row.querySelector('.label-unit, .text-xs');
                if (sel && sel.value) labels.push({ itemId: sel.value, name: (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].text) || sel.value, quantity: qty, unit: (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].dataset && sel.options[sel.selectedIndex].dataset.unit) || '' });
                else if (inp) labels.push({ itemId: inp.dataset.itemId || inp.value, name: inp.value, quantity: qty, unit: (unitEl && unitEl.textContent) || '' });
            });
            const saveBtn = document.getElementById('btnSavePackingLabels');
            if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }
            showToast('Saving...', 'info');
            try {
                const data = await callBackend('update_request_packing_labels', { id: requestId, user: currentUser.name, packing, labels });
                if (data.result === 'success') {
                    showToast('Packing & labels updated.', 'success');
                    document.getElementById('updatePackingLabelsModal').remove();
                    viewRequestDetails(requestId);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
                }
            } catch (e) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
            }
        }

        async function confirmFormula(id) {
            showToast('Confirming...', 'info');
            try {
                const data = await callBackend('confirm_formula', { id, user: currentUser.name });
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('Formula Confirmed!', 'success');
                    closeDetails();
                    refreshCurrentView();
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Sync failed', 'error');
            }
        }

        async function openCompleteBatchModal(reqId) {
            let req = (typeof currentRequest !== 'undefined' && currentRequest && currentRequest.id === reqId) ? currentRequest : null;
            if (!req) {
                try {
                    let data = await callBackend('get_request_details', { id: reqId, user: currentUser.name, email: currentUser.email }).catch(() => ({}));
                    if (data.result === 'success' && data.request) req = data.request;
                } catch (e) { showToast('Could not load request.', 'error'); return; }
            }
            if (!req) { showToast('Request not found.', 'error'); return; }

            const stageUpper = (req.currentStage || '').toUpperCase();
            if (stageUpper.indexOf('AWAITING MANAGER APPROVAL') >= 0) {
                showToast('Complete is locked until Manager approves the material issue. Store has issued; stock will deduct on approval.', 'warning');
                return;
            }

            const allFormulaItems = [];
            [].concat(req.ingredients || [], req.packing || [], req.labels || [], req.additionalItems || []).forEach(ing => {
                const key = ing.itemId || ing.name || ing.itemName;
                if (!key) return;
                allFormulaItems.push({
                    key: key,
                    name: ing.name || ing.itemName || ing.itemId || 'Unnamed',
                    reqQty: ing.quantity != null ? ing.quantity : (ing.qty != null ? ing.qty : 0),
                    unit: ing.unit || ''
                });
            });

            const usageRows = allFormulaItems.map(ing => {
                const safeName = String(ing.name).replace(/</g, '&lt;').replace(/"/g, '&quot;');
                const safeKey = String(ing.key).replace(/"/g, '&quot;');
                return `<tr class="border-b border-gray-100"><td class="py-1.5 text-[10px] font-bold text-gray-700">${safeName}</td><td class="py-1.5 text-[10px] text-gray-500">${ing.reqQty} ${ing.unit}</td><td class="py-1.5"><input type="number" step="any" min="0" data-item-key="${safeKey}" value="${ing.reqQty}" class="complete-actual-usage w-20 px-2 py-1 text-[10px] border rounded"></td></tr>`;
            }).join('') || '<tr><td colspan="3" class="py-2 text-[10px] text-gray-400">No formula items</td></tr>';

            const directUseOpts = [];
            if (typeof cachedFormData !== 'undefined' && cachedFormData) {
                const raw = (cachedFormData.rawMaterials || []).map(m => ({ id: m.id || m.name, name: m.name || m.id || '', unit: m.unit || '' }));
                const pack = (cachedFormData.packingMaterials || []).map(m => ({ id: m.id || m.name, name: m.name || m.id || '', unit: m.unit || '' }));
                const lbl = (cachedFormData.labels || []).map(m => ({ id: m.id || m.name, name: m.name || m.id || '', unit: m.unit || '' }));
                const products = (cachedFormData.products || []).map(p => ({ id: p.id || p.name, name: (p.name || p.id || '') + ' (Finished Good)', unit: p.unit || 'Units' }));
                [].concat(raw, pack, lbl, products).forEach(m => {
                    if (m.id && !directUseOpts.find(o => o.id === m.id)) directUseOpts.push(m);
                });
            }
            const directUseSelectOpts = '<option value="">Select item...</option>' + directUseOpts.map(o => `<option value="${String(o.id).replace(/"/g, '&quot;')}" data-name="${String(o.name).replace(/"/g, '&quot;')}" data-unit="${String(o.unit || '').replace(/"/g, '&quot;')}">${String(o.name).replace(/</g, '&lt;')}</option>`).join('');

            const existing = document.getElementById('completeBatchModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'completeBatchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] overflow-y-auto py-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl mx-4 border-t-4 border-green-500 my-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">Complete Batch</h2>
                    <p class="text-xs text-gray-500 mb-4">Reason, actual yield, per-item usage and direct-use items in one form.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Reason (required)</label>
                            <textarea id="completeReason" rows="2" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Reason for completion"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Actual produced quantity (Yield)</label>
                            <input type="number" id="completeActualYield" step="0.01" min="0.01" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0" value="${(req.quantity || req.theoreticalYield || '').toString().replace(/"/g, '&quot;')}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Actual usage (formula items)</label>
                            <div class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg">
                                <table class="w-full text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 text-[9px] font-black text-gray-500 uppercase">Item</th><th class="p-2 text-[9px] font-black text-gray-500 uppercase">Req</th><th class="p-2 text-[9px] font-black text-gray-500 uppercase">Actual</th></tr></thead><tbody>${usageRows}</tbody></table>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Direct-use items (not in formula) ‚Äì optional</label>
                            <div id="completeDirectUseRows" class="space-y-2">
                                <div class="complete-direct-row flex gap-2 items-center">
                                    <select class="flex-1 px-2 py-1.5 border rounded text-sm complete-direct-select">${directUseSelectOpts}</select>
                                    <input type="number" step="0.01" min="0.01" class="w-20 px-2 py-1.5 border rounded text-sm complete-direct-qty" placeholder="Qty">
                                    <button type="button" onclick="this.closest('.complete-direct-row').remove()" class="text-red-500 text-sm">Remove</button>
                                </div>
                            </div>
                            <button type="button" onclick="addCompleteDirectUseRow()" class="mt-1 text-xs text-indigo-600 font-bold">+ Add direct-use item</button>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-5">
                        <button type="button" onclick="document.getElementById('completeBatchModal').remove()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold">Cancel</button>
                        <button type="button" onclick="submitCompleteBatch('${reqId}')" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Submit Complete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window._completeDirectUseSelectOpts = directUseSelectOpts;
        }

        function addCompleteDirectUseRow() {
            const container = document.getElementById('completeDirectUseRows');
            if (!container) return;
            const opts = window._completeDirectUseSelectOpts || '<option value="">Select item...</option>';
            const row = document.createElement('div');
            row.className = 'complete-direct-row flex gap-2 items-center';
            row.innerHTML = `<select class="flex-1 px-2 py-1.5 border rounded text-sm complete-direct-select">${opts}</select><input type="number" step="0.01" min="0.01" class="w-20 px-2 py-1.5 border rounded text-sm complete-direct-qty" placeholder="Qty"><button type="button" onclick="this.closest('.complete-direct-row').remove()" class="text-red-500 text-sm">Remove</button>`;
            container.appendChild(row);
        }

        async function submitCompleteBatch(reqId) {
            var key = 'complete_' + reqId;
            if (window._actionKeys && window._actionKeys[key]) return;
            window._actionKeys = window._actionKeys || {};
            window._actionKeys[key] = true;
            const submitBtn = document.querySelector('#completeBatchModal button[onclick*="submitCompleteBatch"]');
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Submitting...'; }
            const reasonEl = document.getElementById('completeReason');
            const reason = reasonEl ? reasonEl.value.trim() : '';
            if (!reason) { showToast('Reason is required.', 'warning'); delete (window._actionKeys || {})[key]; if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit Complete'; } return; }
            const yieldEl = document.getElementById('completeActualYield');
            const actualYield = yieldEl ? parseFloat(yieldEl.value) : NaN;
            if (!yieldEl || isNaN(actualYield) || actualYield <= 0) { showToast('Enter a valid actual yield.', 'warning'); delete (window._actionKeys || {})[key]; if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit Complete'; } return; }

            const consumptionMap = {};
            document.querySelectorAll('#completeBatchModal .complete-actual-usage').forEach(input => {
                const key = input.getAttribute('data-item-key');
                const val = parseFloat(input.value);
                if (key && !isNaN(val)) consumptionMap[key] = val;
            });

            const directUseItems = [];
            document.querySelectorAll('#completeBatchModal .complete-direct-row').forEach(row => {
                const sel = row.querySelector('.complete-direct-select');
                const qtyIn = row.querySelector('.complete-direct-qty');
                const qty = qtyIn ? parseFloat(qtyIn.value) : 0;
                if (!sel || !sel.value || isNaN(qty) || qty <= 0) return;
                const opt = sel.options[sel.selectedIndex];
                const name = (opt && opt.dataset && opt.dataset.name) ? opt.dataset.name : (opt ? opt.text : sel.value);
                const unit = (opt && opt.dataset && opt.dataset.unit) ? opt.dataset.unit : '';
                directUseItems.push({ itemId: sel.value, name: name, quantity: qty, unit: unit });
            });

            const modal = document.getElementById('completeBatchModal');
            if (modal) modal.remove();
            showToast('Completing batch...', 'info');
            try {
                const params = { id: reqId, wipAction: 'COMPLETE', user: currentUser.name, email: currentUser.email, reason, actualYield };
                if (Object.keys(consumptionMap).length > 0) params.consumptionMap = JSON.stringify(consumptionMap);
                if (directUseItems.length > 0) params.directUseItems = JSON.stringify(directUseItems);
                const data = await callBackendPost('wip_action_req', params);
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('Production completed.', 'success');
                    closeDetails();
                    initializePortal(currentUser.role);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            } finally {
                delete (window._actionKeys || {})['complete_' + reqId];
            }
        }

        async function triggerWIPAction(ev, reqId, action) {
            if (typeof reqId === 'undefined') { reqId = ev; ev = null; action = arguments[2] || arguments[1]; }
            var key = 'wip_' + reqId + '_' + action;
            if (window._actionKeys && window._actionKeys[key]) return;
            window._actionKeys = window._actionKeys || {};
            window._actionKeys[key] = true;
            if (ev && ev.target) { if (ev.target.disabled) { delete window._actionKeys[key]; return; } ev.target.disabled = true; }
            const labels = { 'PAUSE': 'pause', 'COMPLETE': 'complete', 'CANCEL': 'cancel', 'RESUME': 'resume' };
            const verb = labels[action] || action.toLowerCase();
            if (action === 'COMPLETE') {
                openCompleteBatchModal(reqId);
                delete (window._actionKeys || {})[key];
                return;
            }
            if (!confirm('Are you sure about this action?')) { delete (window._actionKeys || {})[key]; if (ev && ev.target) ev.target.disabled = false; return; }
            let reason = prompt(`Please provide a reason for ${verb.toUpperCase()} (Required):`);
            if (!reason || reason.trim() === '') {
                showToast('Action cancelled: Reason is mandatory.', 'warning');
                delete (window._actionKeys || {})[key];
                if (ev && ev.target) ev.target.disabled = false;
                return;
            }
            showToast(`Processing ${verb}...`, 'info');
            try {
                const data = await callBackendPost('wip_action_req', { id: reqId, wipAction: action, user: currentUser.name, email: currentUser.email, reason });
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast(`‚úÖ Production ${action.toLowerCase()}ed!`, 'success');
                    initializePortal(currentUser.role);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    if (ev && ev.target) ev.target.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                if (ev && ev.target) ev.target.disabled = false;
            } finally {
                delete (window._actionKeys || {})[key];
            }
        }

        function completeWIP(ev, id, role) {
            if (typeof id === 'undefined') { id = ev; ev = null; }
            triggerWIPAction(ev, id, 'COMPLETE');
        }

        function renderIngredients(req) {
            const container = document.getElementById('detailsRecipeContainer');
            if (!container) return;

            const isApproved = ['APPROVED', 'APPROVE_REQUEST', 'ISSUED', 'RECORDED', 'PRODUCED', 'DISPATCHED'].includes(req.status);
            const isCorrection = req.status === 'CORRECTION_REQUIRED';
            const stageUpper = (req.currentStage || '').toUpperCase();
            const isStoreAwaiting = ['AWAITING EMPLOYEE CONFIRMATION', 'AWAITING MATERIAL ISSUE'].includes(stageUpper);

            const isResearch = (req.type || '').toLowerCase() === 'research';
            const isManagerOrStore = ['Manager', 'Admin', 'Store Incharge'].includes(normalizeRole(currentUser.role));

            if (!isApproved && !isCorrection && !isResearch && !isManagerOrStore) {
                container.innerHTML = `
                    <div class="p-8 border border-dashed border-gray-200 rounded-2xl text-center bg-gray-50">
                        <p class="text-3xl mb-2">üîê</p>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-relaxed">Recipe details are restricted<br>until manager approval (Employee view)</p>
                    </div>
                `;
                return;
            }

            let html = '';

            const renderSection = (title, items, icon) => {
                if (!items || items.length === 0) return '';
                let sectionHtml = `
                    <div class="mb-4">
                        <h4 class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-2 flex items-center gap-2">
                            <span>${icon}</span> ${title}
                        </h4>
                        <div class="space-y-1">
                `;

                sectionHtml += items.map(ing => {
                    const itemName = ing.name || ing.itemName || 'Unnamed item';
                    const localCorr = localCorrections[itemName];
                    const remoteCorr = Array.isArray(req.corrections) ? req.corrections.find(c => c.item === itemName) : null;
                    const isAdjustable = isStoreAwaiting && (normalizeRole(currentUser.role) === 'Employee');
                    const isRequester = (currentUser.email.toLowerCase().trim() === (req.requesterEmail || '').toLowerCase().trim());
                    const canEdit = isResearch && isRequester && ['SUBMITTED', 'PENDING', 'CORRECTION_REQUIRED'].includes(req.status);
                    const hasChange = localCorr || remoteCorr;
                    const stockVal = ing.currentStock !== undefined ? Number(ing.currentStock) : null;
                    const stockLine = isManagerOrStore ? `<div class="text-[9px] ${ing.lowStock ? 'text-red-600 font-bold' : 'text-gray-500'}">Stock: ${stockVal !== null ? stockVal : '‚Äî'}${ing.lowStock ? ' LOW' : ''}</div>` : '';

                    // INDUSTRIAL SYNC: Allow reporting ACTUAL usage during WIP
                    const isWIP = stageUpper.includes('WIP') || stageUpper === 'PRODUCTION PAUSED';
                    const canReportActual = isWIP && (isRequester || normalizeRole(currentUser.role) === 'Store Incharge' || normalizeRole(currentUser.role) === 'Manager' || normalizeRole(currentUser.role) === 'Admin');

                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0 group">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-gray-700">${itemName.replace(/</g, '&lt;')}</span>
                                ${canReportActual ? `
                                    <div class="mt-1 flex items-center gap-1">
                                        <span class="text-[8px] text-gray-400 font-bold uppercase">Actual:</span>
                                        <input type="number" step="any" data-item-key="${ing.itemId || ing.name}" value="${ing.quantity || ing.qty || 0}" 
                                               class="w-16 px-1 py-0.5 text-[10px] border border-blue-200 rounded bg-blue-50 focus:outline-none focus:ring-1 focus:ring-blue-400 actual-usage-input">
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${isAdjustable ? `<button onclick="requestItemCorrection('${req.id}', '${itemName.replace(/'/g, "\\'")}', '${ing.quantity || ing.qty || 0}')" class="text-blue-500 font-black hover:text-blue-700 uppercase text-[8px] tracking-tighter">[${localCorr ? 'EDIT' : 'ADJ'}]</button>` : ''}
                                ${canEdit ? `
                                    <div class="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="editResearchItem('${req.id}', '${itemName.replace(/'/g, "\\'")}', '${ing.quantity || ing.qty || 0}')" title="Edit Quantity" class="text-blue-500 hover:text-blue-700">‚úèÔ∏è</button>
                                        <button onclick="deleteResearchItem('${req.id}', '${itemName.replace(/'/g, "\\'")}')" title="Delete Item" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right flex flex-col items-end gap-0.5">
                                ${stockLine}
                                ${hasChange ? `
                                    <div class="flex flex-col items-end leading-none">
                                        <span class="text-gray-400 line-through text-[8px] font-medium">${ing.quantity || ing.qty || 0}</span>
                                        <span class="font-black ${localCorr ? 'text-blue-600' : 'text-orange-600'} text-[10px]">
                                            ‚Üí ${localCorr ? localCorr.new : remoteCorr.new} ${ing.unit || ''}
                                            ${localCorr ? '<span class="text-[6px] ml-1 bg-blue-50 px-1 rounded uppercase">Unsaved</span>' : ''}
                                        </span>
                                    </div>
                                ` : `<span class="font-black text-gray-900 text-xs">${ing.quantity || ing.qty || 0} ${ing.unit || ''}</span>`}
                            </div>
                        </div>
                    `;
                }).join('');

                sectionHtml += `</div></div>`;
                return sectionHtml;
            };

            html += renderSection('Formula Ingredients', req.ingredients, 'üî¨');
            html += renderSection('Packing Materials', req.packing, 'üì¶');
            html += renderSection('Labels & Printing', req.labels, 'üè∑Ô∏è');
            html += renderSection('Additional Requests', req.additionalItems, '‚ûï');

            container.innerHTML = html || '<p class="text-[10px] text-gray-400 font-bold italic text-center py-4">No items listed</p>';
        }

        function renderActionButtons(req) {
            const actionsArea = document.getElementById('detailsActionsArea');
            let actionBtns = '';
            const hasLocalChanges = Object.keys(localCorrections).length > 0;
            const userRole = normalizeRole(currentUser.role);
            const stage = (req.currentStage || '').toUpperCase();

            console.log(`[ActionButtons] Role: ${userRole}, Stage: ${stage}, Status: ${req.status}`);

            if ((userRole === 'Manager' || userRole === 'Admin') && (
                req.status === 'SUBMITTED' ||
                req.status === 'PENDING' ||
                req.status === 'CORRECTION_REQUIRED' ||
                req.status === 'ISSUED_PENDING_APPROVAL' ||
                ((req.status === 'ISSUED' || req.status === 'RESEARCH_ISSUED') && (stage.includes('PENDING') || stage.includes('MANAGER')))
            )) {
                const isStoreIssuedFirst = (req.status === 'ISSUED_PENDING_APPROVAL');
                const isIssueApprove = (req.status === 'ISSUED' || req.status === 'RESEARCH_ISSUED') && !isStoreIssuedFirst;
                const approveLabel = isStoreIssuedFirst ? '‚úÖ Approve & Deduct Materials' : (isIssueApprove ? '‚úÖ Approve & Consume' : '‚úÖ Proceed');

                actionBtns = `
                    <div class="grid grid-cols-2 gap-2 w-full">
                        <button onclick="handleApprovalAction(event, '${req.id}', 'approve')" class="col-span-2 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">${approveLabel}</button>
                        <button onclick="handleApprovalAction(event, '${req.id}', 'approve_partial')" class="bg-indigo-500 text-white font-black py-3 rounded-xl uppercase text-[10px] shadow-lg hover:bg-indigo-600 transition-all">üì¶ Partial Issue</button>
                        <button onclick="handleApprovalAction(event, '${req.id}', 'hold')" class="bg-orange-500 text-white font-black py-3 rounded-xl uppercase text-[10px] shadow-lg hover:bg-orange-600 transition-all">‚è∏Ô∏è Hold</button>
                        <button onclick="handleApprovalAction(event, '${req.id}', 'hold_plan')" class="bg-amber-500 text-white font-black py-3 rounded-xl uppercase text-[10px] shadow-lg hover:bg-amber-600 transition-all">üìã Hold Plan</button>
                        <button onclick="handleApprovalAction(event, '${req.id}', 'reject')" class="bg-red-600 text-white font-black py-3 rounded-xl uppercase text-[10px] shadow-lg hover:bg-red-700 transition-all">‚ùå Reject</button>
                    </div>
                `;
            } else if (userRole === 'Employee' && req.status === 'APPROVED' && stage === 'AWAITING EMPLOYEE CONFIRMATION') {
                if (hasLocalChanges) {
                    actionBtns = `<button onclick="submitBatchCorrections('${req.id}')" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-blue-700 transition-all animate-pulse border-2 border-blue-400">üì§ Send Batch Correction (${Object.keys(localCorrections).length})</button>`;
                } else {
                    actionBtns = `<button onclick="confirmFormula('${req.id}')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">Confirm & Start Production</button>`;
                }
            } else if (stage === 'WIP' || stage.includes('WIP') || stage === 'PRODUCTION PAUSED') {
                const isRequester = (currentUser.email.toLowerCase().trim() === (req.requesterEmail || '').toLowerCase().trim());
                const isStore = (userRole === 'Store Incharge');
                const completeLocked = stage.indexOf('AWAITING MANAGER APPROVAL') >= 0;

                if (isRequester || isStore) {
                    const isPaused = stage === 'PRODUCTION PAUSED';
                    actionBtns = `
                        ${completeLocked ? '<p class="w-full text-[10px] font-bold text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 mb-2">üîí Complete unlocks only after Manager approves the material issue (Store has issued; stock will deduct on approval).</p>' : ''}
                        <button onclick="triggerWIPAction(event, '${req.id}', '${isPaused ? 'RESUME' : 'PAUSE'}')" class="flex-1 bg-orange-500 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-orange-600 transition-all">${isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause'}</button>
                        <button ${completeLocked ? 'disabled title="Complete is available only after Manager approves the material issue."' : ''} onclick="completeWIP(event, '${req.id}')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all ${completeLocked ? 'opacity-50 cursor-not-allowed' : ''}">üì§ Complete</button>
                        <button onclick="triggerWIPAction(event, '${req.id}', 'CANCEL')" class="flex-1 bg-red-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-red-700 transition-all">‚ùå Cancel</button>
                    `;
                } else {
                    actionBtns = `<div class="w-full text-center py-2 bg-gray-50 rounded-lg text-gray-400 text-[10px] font-black uppercase tracking-widest">‚öôÔ∏è Production in Progress (View Only)</div>`;
                }
            } else if (userRole === 'Store Incharge' && req.status === 'PARTIALLY_ISSUED' && (stage.indexOf('Partially') >= 0 || stage.indexOf('PARTIAL') >= 0)) {
                const partialQty = req.partialIssuedQty != null ? Number(req.partialIssuedQty) : 0;
                const totalQty = parseFloat(req.quantity || req.requestedQty || 0) || 0;
                const remaining = totalQty - partialQty;
                actionBtns = `
                    <p class="w-full text-[10px] font-bold text-indigo-700 bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 mb-2">üì¶ Partially issued: <strong>${partialQty}</strong> of <strong>${totalQty}</strong> ${req.unit || 'units'}. Remaining: <strong>${remaining}</strong></p>
                    <button type="button" onclick="handleStageAction(event, '${req.id}', 'ISSUE')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">‚úÖ Issue full stock (remaining)</button>
                    <button type="button" onclick="openPartialIssueModal()" class="flex-1 bg-indigo-500 text-white font-black py-3 rounded-xl border-b-4 border-indigo-700 uppercase text-[10px] shadow-lg hover:bg-indigo-600 transition-all">üì¶ Issue more (partial)</button>
                `;
            } else if (userRole === 'Store Incharge' && (stage === 'AWAITING MATERIAL ISSUE' || stage === 'PENDING STORE & MANAGER' || (stage || '').indexOf('PARTIAL OK') >= 0 || (stage || '').toUpperCase().indexOf('PENDING MANAGER') >= 0)) {
                const btnLabel = (req.type || '').toLowerCase() === 'research' ? 'üì¶ Issue Research Materials' : 'üì¶ Issue Materials & Start WIP';
                const stockShort = req.stockSummary && !req.stockSummary.allSufficient;
                const fullIssueDisabled = stockShort ? ' disabled title="Use Issue Partial when items are short, or add stock in Main Inventory first."' : '';
                const fullIssueClass = stockShort ? 'flex-1 bg-blue-400 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg opacity-60 cursor-not-allowed' : 'flex-1 bg-blue-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-blue-700 transition-all';
                    actionBtns = `
                    <button type="button"${fullIssueDisabled} onclick="handleStageAction(event, '${req.id}', 'ISSUE')" class="${fullIssueClass}">${btnLabel}</button>
                    <button type="button" onclick="openPartialIssueModal()" class="flex-1 bg-indigo-500 text-white font-black py-3 rounded-xl border-b-4 border-indigo-700 uppercase text-[10px] shadow-lg hover:bg-indigo-600 transition-all">üì¶ Issue Partial</button>
                `;

                // Cancellation Button for Requester
                const isRequester = (currentUser.email.toLowerCase().trim() === (req.requesterEmail || '').toLowerCase().trim());
                if (isRequester && ['SUBMITTED', 'PENDING', 'APPROVED', 'APPROVE_REQUEST', 'CORRECTION_REQUIRED'].includes(req.status) && stage !== 'COMPLETED' && stage !== 'CANCELLED') {
                    actionBtns += `<button onclick="cancelRequest(event, '${req.id}')" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl uppercase text-[10px] hover:bg-red-50 hover:text-red-600 transition-all mt-2">üõë Cancel Request</button>`;
                }
            } else if (userRole === 'Manager' || userRole === 'Admin') {
                if (stage === 'AWAITING PRODUCTION RECORDING') {
                    actionBtns = `<button onclick="handleStageAction(event, '${req.id}', 'RECORD')" class="flex-1 bg-indigo-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-indigo-700 transition-all">Record Production (WIP)</button>`;
                } else if (stage === 'AWAITING DISPATCH') {
                    actionBtns = `<button onclick="openRequestDispatchModal('${req.id}', '${(req.productName || '').replace(/'/g, "\\'")}', ${parseFloat(req.requestedQty || req.quantity || 0) || 0}, '${(req.unit || '').replace(/'/g, "\\'")}')" class="flex-1 bg-green-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg hover:bg-green-700 transition-all">Request Dispatch</button>`;
                }
            }
            if ((req.status === 'PRODUCED' || (stage && stage.includes('DISPATCH'))) && req.status !== 'DISPATCHED') {
                actionBtns += `<button onclick="openUpdatePackingLabelsModal('${req.id}')" class="flex-1 mt-2 bg-amber-100 text-amber-800 font-bold py-2 rounded-xl uppercase text-[10px] hover:bg-amber-200 transition-all">üì¶ Update packing & labels</button>`;
            }
            if (actionsArea) actionsArea.innerHTML = actionBtns;
        }

        function openCorrectionForm(id, itemName = '', oldQty = '') {
            const existing = localCorrections[itemName];
            const correctionModal = document.createElement('div');
            correctionModal.id = 'correctionModal';
            correctionModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] fade-in';
            correctionModal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-lg p-8 shadow-2xl mx-4 border-t-8 border-blue-500">
                    <h2 class="text-2xl font-black text-gray-800 mb-2">Adjust Quantity</h2>
                    <p class="text-sm text-gray-500 mb-6 font-medium">Proposed change for <b>${itemName}</b></p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Approved Qty</label>
                            <input type="text" id="oldQtyDisplay" readonly value="${oldQty}" class="w-full bg-transparent font-black text-gray-400 outline-none">
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 shadow-sm">
                            <label class="block text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">New Proposed Qty</label>
                            <input type="number" id="newQtyInput" step="0.001" value="${existing ? existing.new : ''}" class="w-full bg-transparent font-black text-blue-700 outline-none" placeholder="0.000" autofocus>
                        </div>
                    </div>

                    <div class="space-y-4 mb-8">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Internal Note (Reason)</label>
                            <textarea id="correctionReason" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Spill recovery, Scale adjustment...">${existing ? existing.reason : ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="this.closest('#correctionModal').remove()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-all uppercase text-xs">Close</button>
                        <button onclick="updateLocalCorrection('${itemName}', '${oldQty}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all uppercase text-xs shadow-lg">Save Adjustment</button>
                    </div>
                </div>
            `;
            document.body.appendChild(correctionModal);
        }

        function updateLocalCorrection(itemName, oldQty) {
            const newQty = document.getElementById('newQtyInput').value;
            const reason = document.getElementById('correctionReason').value;
            if (!newQty || !reason) return showToast('Quantity and reason required', 'warning');

            localCorrections[itemName] = { old: oldQty, new: newQty, reason: reason };

            showToast('‚úÖ Adjustment added to batch', 'success');
            document.getElementById('correctionModal').remove();

            // Refresh detailed view UI locally
            if (currentRequest) {
                renderIngredients(currentRequest);
                renderActionButtons(currentRequest);
            }
        }

        async function submitBatchCorrections(id) {
            const items = Object.keys(localCorrections).map(name => {
                const c = localCorrections[name];
                return { item: name, old: c.old, new: c.new, reason: c.reason };
            });

            if (items.length === 0) return;

            const summary = items.map(i => `${i.item}: ${i.old}‚Üí${i.new}`).join(', ');
            const structuredData = JSON.stringify(items);

            showToast('üì§ Sending batch corrections...', 'info');
            try {
                const data = await callBackendPost('request_correction', { id, corrections: structuredData, summary, user: currentUser.name });
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('üéâ Batch corrections sent to Manager!', 'success');
                    localCorrections = {};
                    closeDetails();
                    refreshCurrentView();
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Submission failed', 'error');
            }
        }

        function requestItemCorrection(reqId, itemName, currentQty) {
            openCorrectionForm(reqId, itemName, currentQty);
        }

        function openPartialIssueModal() {
            const req = window._currentReqDetails;
            if (!req) { showToast('Open a request first (Pending Issue or Issued Items).', 'warning'); return; }
            const totalQty = parseFloat(req.quantity || req.requestedQty || 0) || 0;
            const unit = (req.unit || 'Units').replace(/</g, '&lt;');
            const productName = String(req.productName || 'Request').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            const isAlreadyPartial = req.status === 'PARTIALLY_ISSUED' && (req.partialIssuedQty != null || req.partialIssuedQty === 0);
            const alreadyIssued = isAlreadyPartial ? (parseFloat(req.partialIssuedQty) || 0) : 0;
            const remaining = totalQty - alreadyIssued;
            const ingredients = [];
            [].concat(req.ingredients || [], req.packing || [], req.labels || [], req.additionalItems || []).forEach(function(ing) {
                if (!ing || (!ing.name && !ing.itemName)) return;
                const qty = ing.quantity != null ? ing.quantity : (ing.qty != null ? ing.qty : 0);
                ingredients.push({ name: String(ing.name || ing.itemName || '').replace(/</g, '&lt;').replace(/"/g, '&quot;'), required: parseFloat(qty) || 0, unit: String(ing.unit || '').replace(/</g, '&lt;') });
            });
            const tableRows = ingredients.map(function(ing, i) {
                return `<tr class="border-b border-gray-100"><td class="py-1.5 text-[10px] font-bold text-gray-700">${ing.name}</td><td class="py-1.5 text-[10px] text-gray-500">${ing.required} ${ing.unit}</td><td class="py-1.5 text-[10px] text-indigo-600 font-bold partial-will-deduct" data-required="${ing.required}" data-unit="${ing.unit}">‚Äî</td></tr>`;
            }).join('') || '<tr><td colspan="3" class="py-2 text-[10px] text-gray-400">No formula items</td></tr>';
            const existing = document.getElementById('partialIssueModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'partialIssueModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110] overflow-y-auto py-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl mx-4 border-t-4 border-indigo-500 my-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">üì¶ Issue partial ‚Äì ${productName}</h2>
                    <p class="text-xs text-gray-500 mb-2">Target quantity: <strong>${totalQty} ${unit}</strong>${isAlreadyPartial ? '. Already issued: <strong>' + alreadyIssued + ' ' + unit + '</strong>. Enter <strong>additional</strong> quantity to issue now.' : '.'}</p>
                    <p class="text-[10px] text-gray-600 mb-3">Enter how many <strong>product units</strong> you are issuing now. Ingredients will be deducted proportionally from Main Inventory.</p>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-600 mb-1">Quantity to issue now (product units)</label>
                        <input type="number" id="partialIssueProductQty" step="any" min="0.01" max="${isAlreadyPartial ? remaining : totalQty}" value="" placeholder="${isAlreadyPartial ? 'e.g. ' + Math.min(1, remaining) : 'e.g. 1'}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-600 mb-1">Formula ingredients ‚Äì required (full) vs will deduct (this time)</label>
                        <div class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 text-[9px] font-black text-gray-500 uppercase">Ingredient</th><th class="p-2 text-[9px] font-black text-gray-500 uppercase">Required (full)</th><th class="p-2 text-[9px] font-black text-indigo-600 uppercase">Will deduct (this time)</th></tr></thead><tbody id="partialIssuePreviewBody">${tableRows}</tbody></table>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button type="button" onclick="document.getElementById('partialIssueModal').remove()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                        <button type="button" id="partialIssueSubmitBtn" onclick="submitPartialIssue('${req.id.replace(/'/g, "\\'")}', ${totalQty})" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">Issue partial</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            window._partialIssueTotalQty = totalQty;
            const inputEl = document.getElementById('partialIssueProductQty');
            if (inputEl) {
                inputEl.addEventListener('input', updatePartialIssuePreview);
                inputEl.addEventListener('change', updatePartialIssuePreview);
            }
        }

        function updatePartialIssuePreview() {
            const totalQty = window._partialIssueTotalQty;
            if (totalQty == null || totalQty <= 0) return;
            const qty = parseFloat(document.getElementById('partialIssueProductQty').value) || 0;
            const ratio = qty / totalQty;
            const tbody = document.getElementById('partialIssuePreviewBody');
            if (!tbody) return;
            tbody.querySelectorAll('tr .partial-will-deduct').forEach(function(td) {
                const required = parseFloat(td.getAttribute('data-required')) || 0;
                const unit = td.getAttribute('data-unit') || '';
                const deduct = (ratio * required);
                td.textContent = deduct > 0 ? (Math.round(deduct * 1000) / 1000) + ' ' + unit : '‚Äî';
            });
        }

        async function submitPartialIssue(reqId, totalQty) {
            const qtyEl = document.getElementById('partialIssueProductQty');
            const partialQty = qtyEl ? parseFloat(qtyEl.value) : NaN;
            if (!qtyEl || isNaN(partialQty) || partialQty <= 0) {
                showToast('Enter a valid quantity (product units) to issue.', 'warning');
                return;
            }
            const btn = document.getElementById('partialIssueSubmitBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }
            try {
                const data = await callBackendPost('update_request_stage', { id: reqId, stageAction: 'PARTIAL_ISSUE', user: currentUser.name, email: currentUser.email, partialQty });
                document.getElementById('partialIssueModal').remove();
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    if (data.newStatus === 'COMPLETED') {
                        showToast('‚úÖ Auto-Process Complete! Items issued & consumed. Request finished.', 'success');
                    } else if (data.message && data.message.indexOf('Remaining') >= 0) {
                        showToast('‚úÖ Remaining stock issued. Full quantity now issued.', 'success');
                    } else if (data.newStatus === 'PARTIALLY_ISSUED') {
                        showToast('‚úÖ Partial issue recorded. Stock deducted in Main Inventory. Issue remaining from Pending Issue.', 'success');
                    } else {
                        showToast('‚úÖ Items issued. Status: ' + (data.newStatus || 'PARTIALLY_ISSUED'), 'success');
                    }
                    closeDetails();
                    initializePortal(currentUser.role);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Network error. Please try again.', 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'Issue partial'; }
            }
        }

        function openRequestStockAdjustmentModal() {
            const req = window._currentReqDetails;
            if (!req) { showToast('No request in view.', 'warning'); return; }
            const lowItems = [];
            [].concat(req.ingredients || [], req.packing || [], req.labels || [], req.additionalItems || []).forEach(function(ing) {
                if (ing && ing.lowStock && (ing.name || ing.itemName)) {
                    lowItems.push({
                        name: ing.name || ing.itemName,
                        itemId: ing.itemId || ing.id,
                        currentStock: ing.currentStock != null ? Number(ing.currentStock) : 0,
                        unit: ing.unit || ''
                    });
                }
            });
            const uniq = [];
            const seen = {};
            lowItems.forEach(function(it) {
                const key = (it.name || '').toLowerCase();
                if (!seen[key]) { seen[key] = true; uniq.push(it); }
            });
            if (uniq.length === 0) { showToast('No short items to request.', 'info'); return; }

            const existing = document.getElementById('requestStockAdjustmentModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'requestStockAdjustmentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[110]';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl mx-4 border-t-4 border-indigo-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">üì§ Request to add stock</h2>
                    <p class="text-xs text-gray-500 mb-4">Main Inventory will see this and can apply the adjustment. Enter the physical quantity available for each short item.</p>
                    <div id="requestStockAdjustmentList" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
                    <div class="flex gap-3 mt-4">
                        <button type="button" onclick="document.getElementById('requestStockAdjustmentModal').remove()" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                        <button type="button" id="btnSubmitStockRequests" onclick="submitStockAdjustmentRequests('${req.id.replace(/'/g, "\\'")}')" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">Send request(s)</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            const listEl = document.getElementById('requestStockAdjustmentList');
            listEl.innerHTML = uniq.map(function(it, idx) {
                const id = 'stock_req_qty_' + idx;
                return `<div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <span class="text-xs font-bold text-gray-800">${String(it.name).replace(/</g, '&lt;')}</span>
                        <span class="text-[10px] text-gray-500 ml-1">(digital: ${it.currentStock} ${it.unit})</span>
                    </div>
                    <label class="text-[10px] font-medium text-gray-600 whitespace-nowrap">Physical qty:</label>
                    <input type="number" step="any" min="0" id="${id}" data-item-name="${String(it.name).replace(/"/g, '&quot;')}" data-item-id="${it.itemId || ''}" data-unit="${String(it.unit).replace(/"/g, '&quot;')}" class="w-20 px-2 py-1 text-xs border border-gray-300 rounded" placeholder="0">
                </div>`;
            }).join('');
        }

        async function submitStockAdjustmentRequests(reqId) {
            const listEl = document.getElementById('requestStockAdjustmentList');
            if (!listEl) return;
            const inputs = listEl.querySelectorAll('input[type="number"]');
            const toSend = [];
            inputs.forEach(function(inp) {
                const qty = parseFloat(inp.value);
                if (!isNaN(qty) && qty >= 0) {
                    toSend.push({
                        itemName: inp.getAttribute('data-item-name'),
                        itemId: inp.getAttribute('data-item-id') || null,
                        unit: inp.getAttribute('data-unit') || '',
                        quantity: qty
                    });
                }
            });
            if (toSend.length === 0) { showToast('Enter at least one physical quantity.', 'warning'); return; }
            const btn = document.getElementById('btnSubmitStockRequests');
            if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }
            let ok = 0;
            for (let i = 0; i < toSend.length; i++) {
                const p = toSend[i];
                const params = { quantity: p.quantity, user: currentUser.name || 'Store', email: currentUser.email || '', requisitionId: reqId };
                if (p.itemName) params.itemName = p.itemName;
                if (p.itemId) params.itemId = p.itemId;
                if (p.unit) params.unit = p.unit;
                try {
                    const data = await callBackendPost('submit_stock_adjustment_request', params);
                    if (data.result === 'success') ok++;
                } catch (e) { console.error(e); }
            }
            if (btn) { btn.disabled = false; btn.textContent = 'Send request(s)'; }
            document.getElementById('requestStockAdjustmentModal').remove();
            showToast(ok > 0 ? 'Request(s) sent. Main Inventory will add stock as adjustment.' : 'Failed to send. Try again.', ok > 0 ? 'success' : 'error');
            if (ok > 0 && typeof invalidateViewCache === 'function') invalidateViewCache(true);
        }

        // ==========================================
        // MANAGER - ARCHIVE VIEW
        // ==========================================
        async function renderManagerHistory() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in p-6">
                    <div class="mb-8">
                        <h2 class="text-3xl font-black text-gray-800 tracking-tighter">Production Archive</h2>
                        <p class="text-gray-500 font-semibold italic">Complete historical logs of all approvals and quantities</p>
                    </div>
                    <div id="managerHistoryList" class="space-y-3">
                        <div class="text-center py-20"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>
                    </div>
                </div>
            `;

            try {
                const data = await callBackend('get_all_requests', {});
                if (data.result === 'success' && data.requests) {
                    const list = document.getElementById('managerHistoryList');
                    list.innerHTML = data.requests.map(r => `
                        <div onclick="viewRequestDetails('${r.id}')" class="bg-white p-2 rounded-xl border border-gray-100 flex items-center justify-between hover:shadow-md hover:border-blue-200 cursor-pointer transition-all gap-3 group">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="bg-gray-50 p-1.5 rounded-lg text-center min-w-[50px] group-hover:bg-blue-50 transition-colors">
                                    <p class="text-[7px] font-black text-gray-400 uppercase leading-none">${r.id}</p>
                                    <p class="text-[8px] font-black text-blue-600 uppercase leading-none mt-1">${r.type.substring(0, 3)}</p>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="font-black text-gray-800 truncate text-xs leading-tight group-hover:text-blue-600">${r.productName}</h4>
                                    <p class="text-[8px] font-bold text-gray-400 uppercase">By: ${r.requesterName}</p>
                                </div>
                            </div>
                            <div class="text-right flex items-center gap-4">
                                <div>
                                    <p class="text-xs font-black text-gray-800 leading-none">${r.quantity} ${r.unit}</p>
                                    <p class="text-[7px] font-black text-gray-400 uppercase mt-0.5">${new Date(r.timestamp).toLocaleDateString()}</p>
                                </div>
                                <div class="min-w-[80px]">
                                    <span class="text-[7px] font-black px-1.5 py-0.5 rounded-full border border-blue-50 text-blue-600 uppercase bg-blue-50">${r.status}</span>
                                </div>
                                <div class="text-blue-500 opacity-0 group-hover:opacity-100 transition-all">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) { showToast('Failed to load archive', 'error'); }
        }

        function applyDetailData(id, data) {
            const req = data.request;
            if (!req) return;
            window._currentReqDetails = req;
            const historyContainer = document.getElementById('detailsHistory');
            const recipeContainer = document.getElementById('detailsRecipeContainer');
            const correctionsSection = document.getElementById('detailsCorrectionsSection');
            const correctionsContainer = document.getElementById('detailsCorrectionsContainer');
            const actionsArea = document.getElementById('detailsActionsArea');
            const addArea = document.getElementById('additionalRequestArea');

            document.getElementById('detailsTitle').textContent = req.productName;
            const partialBadge = req.status === 'PARTIALLY_ISSUED' && (req.partialIssuedQty != null || req.partialIssuedQty === 0) ? ' <span class="text-[9px] font-black bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded uppercase">PARTIAL ' + req.partialIssuedQty + '/' + (req.quantity || '?') + ' ' + (req.unit || '').replace(/</g, '&lt;') + '</span>' : '';
            document.getElementById('detailsSubtitle').innerHTML = 'REQ #' + String(req.id).replace(/</g, '&lt;') + ' ‚Ä¢ ' + String(req.status).replace(/</g, '&lt;') + ' ‚Ä¢ BY ' + String(req.requesterName || '').replace(/</g, '&lt;') + partialBadge;
            document.getElementById('detailsQty').textContent = `${req.quantity} ${req.unit || 'Units'}`;
            document.getElementById('detailsStation').textContent = req.currentStage;
            document.getElementById('detailsRecipeStatus').className = `text-[8px] font-black px-2 py-0.5 rounded uppercase ${req.status === 'APPROVED' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}`;
            document.getElementById('detailsRecipeStatus').textContent = req.status;

            const stockBanner = document.getElementById('detailsStockBanner');
            if (stockBanner) {
                if (req.stockSummary && !req.stockSummary.allSufficient && req.stockSummary.lowStockItems && req.stockSummary.lowStockItems.length > 0) {
                    stockBanner.className = 'mb-4 p-3 rounded-xl bg-amber-50 border border-amber-200';
                    const isStore = normalizeRole(currentUser.role) === 'Store Incharge';
                    const requestStockBtn = isStore ? `<p class="mt-2"><button type="button" onclick="openRequestStockAdjustmentModal()" class="text-[10px] font-black text-indigo-700 bg-indigo-100 hover:bg-indigo-200 px-3 py-1.5 rounded-lg uppercase tracking-wider">üì§ Request to add stock (Main Inventory will apply)</button></p>` : '';
                    stockBanner.innerHTML = `<p class="text-[10px] font-black text-amber-800 uppercase tracking-wider">‚ö†Ô∏è Some items may be short ‚Äì verify stock before issue</p><ul class="mt-1 text-[9px] text-amber-700 font-medium list-disc list-inside">${req.stockSummary.lowStockItems.map(s => '<li>' + String(s).replace(/</g, '&lt;') + '</li>').join('')}</ul><p class="mt-2 text-[9px] text-amber-700 font-medium">Use <strong>Issue Partial</strong> to issue what‚Äôs available. ${isStore ? 'Or send a <strong>Request to add stock</strong> below ‚Äì Main Inventory can apply the adjustment directly.' : 'Physical stock there but digital record low? In Main Inventory app open the item ‚Üí Stock Adjustment to add quantity, then refresh and issue.'}</p>${requestStockBtn}`;
                    stockBanner.classList.remove('hidden');
                } else {
                    stockBanner.classList.add('hidden');
                    stockBanner.innerHTML = '';
                }
            }

            const ingList = req.ingredients && Array.isArray(req.ingredients) ? req.ingredients : [];
            const isApproved = ['APPROVED', 'APPROVE_REQUEST', 'ISSUED', 'RECORDED', 'PRODUCED', 'DISPATCHED'].includes(req.status);
            const isCorrection = req.status === 'CORRECTION_REQUIRED';
            const isStoreAwaiting = ['Awaiting Employee Confirmation', 'Awaiting Material Issue'].includes(req.currentStage);
            const isManagerOrStore = ['Manager', 'Admin', 'Store Incharge'].includes(normalizeRole(currentUser.role));

            if (ingList.length > 0 && (isApproved || isCorrection || isManagerOrStore)) {
                recipeContainer.innerHTML = ingList.map(ing => {
                    const itemName = ing.name || ing.itemName || 'Unnamed item';
                    const qty = ing.quantity != null ? ing.quantity : (ing.baseQty != null ? ing.baseQty : '');
                    const corr = Array.isArray(req.corrections) ? req.corrections.find(c => c.item === itemName) : null;
                    const isAdjustable = isStoreAwaiting && (currentUser.role === 'Employee');
                    const stockInfo = (ing.currentStock !== undefined && isManagerOrStore) ? `<span class="text-[9px] font-medium ${ing.lowStock ? 'text-red-600' : 'text-gray-500'}">Stock: ${Number(ing.currentStock)}</span>${ing.lowStock ? ' <span class="text-[8px] font-black text-red-600 bg-red-100 px-1 rounded uppercase">LOW</span>' : ''}` : '';
                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0 group">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-gray-700">${itemName.replace(/</g, '&lt;')}</span>
                                ${isAdjustable ? `<button onclick="requestItemCorrection('${req.id}', '${itemName.replace(/'/g, "\\'")}', '${qty}')" class="text-blue-500 font-black hover:text-blue-700 uppercase text-[8px] tracking-tighter">[ADJ]</button>` : ''}
                            </div>
                            <div class="text-right flex flex-col items-end gap-0.5">
                                ${stockInfo ? `<div class="flex items-center gap-1">${stockInfo}</div>` : ''}
                                ${corr ? `
                                    <div class="flex flex-col items-end leading-none">
                                        <span class="text-gray-400 line-through text-[8px] font-medium">${qty}</span>
                                        <span class="font-black text-orange-600 text-[10px]">‚Üí ${corr.new} ${(ing.unit || '').replace(/</g, '&lt;')}</span>
                                    </div>
                                ` : `<span class="font-black text-gray-900 text-xs">${qty} ${(ing.unit || '').replace(/</g, '&lt;')}</span>`}
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (ingList.length > 0) {
                recipeContainer.innerHTML = `
                    <div class="p-8 border border-dashed border-gray-200 rounded-2xl text-center bg-gray-50">
                        <p class="text-3xl mb-2">üîê</p>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-relaxed">Recipe details are restricted<br>until manager approval (Employee view)</p>
                    </div>
                `;
            } else {
                recipeContainer.innerHTML = `
                    <div class="p-4 border border-dashed border-amber-200 rounded-xl bg-amber-50 text-center">
                        <p class="text-[10px] font-bold text-amber-800">No formula items for this product yet.</p>
                        <p class="text-[9px] text-amber-600 mt-1">Add a formulation for "${(req.productName || '').replace(/</g, '&lt;')}" in Main Inventory ‚Üí Formulation, or request one via Request New Formula.</p>
                    </div>
                `;
            }

            if (req.status === 'CORRECTION_REQUIRED') {
                correctionsSection.classList.remove('hidden');
                try {
                    const corrs = Array.isArray(req.corrections) ? req.corrections : JSON.parse(req.corrections || '[]');
                    correctionsContainer.innerHTML = corrs.map(c => `
                        <div class="flex justify-between items-center text-[10px] py-1 border-b border-orange-100 last:border-0">
                            <span class="font-bold text-orange-800">${c.item}:</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 line-through">${c.old}</span>
                                <span class="font-black text-orange-600">‚Üí ${c.new}</span>
                            </div>
                        </div>
                    `).join('') + (req.remarks ? `<p class="mt-2 text-[10px] italic text-orange-500 font-medium">"${req.remarks}"</p>` : '');
                } catch (e) {
                    correctionsContainer.innerHTML = `<p class="text-[10px] italic text-orange-500">Adjustment details unavailable</p>`;
                }
            }

            if (data.history && data.history.length > 0) {
                historyContainer.innerHTML = data.history.map(h => `
                    <div class="flex gap-4 items-start relative pb-4">
                        <div class="absolute left-[7px] top-6 bottom-0 w-[2px] bg-gray-100"></div>
                        <div class="z-10 w-3.5 h-3.5 rounded-full bg-blue-500 border-2 border-white shadow-sm mt-1"></div>
                        <div class="flex-1">
                            <div class="text-xs font-black text-gray-800">${h.action}</div>
                            <div class="text-[8px] text-gray-400 font-black uppercase tracking-tighter mb-1">
                                ${new Date(h.timestamp).toLocaleString()} ‚Ä¢ BY ${h.user}
                            </div>
                            ${h.remarks ? `<div class="text-[10px] text-gray-500 bg-white p-2 rounded-lg border border-gray-100 shadow-sm inline-block italic">"${h.remarks}"</div>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                historyContainer.innerHTML = `<div class="text-center py-4 text-[10px] font-bold text-gray-300 uppercase tracking-widest">No events logged</div>`;
            }

            if (actionsArea) {
                renderIngredients(req);
                renderActionButtons(req);
            }

            const dispatchSection = document.getElementById('detailsDispatchSection');
            const dispatchHistoryEl = document.getElementById('detailsDispatchHistory');
            if (dispatchSection && dispatchHistoryEl) {
                if (req.status === 'PRODUCED' || req.status === 'DISPATCHED') {
                    dispatchSection.classList.remove('hidden');
                    dispatchHistoryEl.innerHTML = '<div class="text-[10px] text-gray-400 animate-pulse">Loading...</div>';
                    callBackend('get_dispatches_for_request', { requestId: req.id })
                        .then(dData => {
                            const dispatches = (dData.dispatches || dData.data || []);
                            if (dispatchHistoryEl) {
                                if (dispatches.length === 0) dispatchHistoryEl.innerHTML = '<p class="text-xs text-gray-500">No dispatches yet.</p>';
                                else dispatchHistoryEl.innerHTML = dispatches.map(d => `<div class="flex justify-between items-center text-xs py-1 border-b border-gray-100"><span>${(d.productName || '').replace(/</g, '&lt;')} ¬∑ ${d.quantity} ${(d.unit || '').replace(/</g, '&lt;')}</span><span class="font-bold ${d.status === 'APPROVED' ? 'text-green-600' : 'text-amber-600'}">${(d.status || '').replace(/</g, '&lt;')}</span></div>`).join('');
                            }
                        })
                        .catch(() => { if (dispatchHistoryEl) dispatchHistoryEl.innerHTML = '<p class="text-xs text-red-500">Could not load.</p>'; });
                } else {
                    dispatchSection.classList.add('hidden');
                    dispatchHistoryEl.innerHTML = '';
                }
            }

            addArea.classList.remove('hidden');
            addArea.dataset.reqId = id;
            if (currentUser.role === 'Employee') {
                document.getElementById('additionalMaterialInput').classList.remove('hidden');
            } else {
                document.getElementById('additionalMaterialInput').classList.add('hidden');
            }
        }

        async function viewRequestDetails(id) {
            const modal = document.getElementById('detailsModal');
            const panel = document.getElementById('detailsPanel');
            const historyContainer = document.getElementById('detailsHistory');
            const recipeContainer = document.getElementById('detailsRecipeContainer');
            const correctionsSection = document.getElementById('detailsCorrectionsSection');
            const actionsArea = document.getElementById('detailsActionsArea');
            const addArea = document.getElementById('additionalRequestArea');

            localCorrections = {};
            currentRequest = null;

            if (!actionsArea) console.error('‚ùå detailsActionsArea not found!');

            document.getElementById('detailsTitle').textContent = `REQ #${id}`;
            document.getElementById('detailsSubtitle').textContent = 'Loading...';
            document.getElementById('detailsQty').textContent = '‚Äî';
            document.getElementById('detailsStation').textContent = '‚Äî';
            document.getElementById('detailsRecipeStatus').textContent = 'Loading';
            document.getElementById('detailsRecipeStatus').className = 'text-[8px] font-black px-2 py-0.5 rounded uppercase bg-gray-100 text-gray-500';
            recipeContainer.innerHTML = getDetailSkeletonHTML();
            historyContainer.innerHTML = getHistorySkeletonHTML();
            correctionsSection.classList.add('hidden');
            actionsArea.innerHTML = '';

            modal.style.display = 'flex';
            setTimeout(() => panel.classList.remove('translate-x-full'), 10);

            const cached = getCachedDetail(id);
            if (cached && cached.request) {
                currentRequest = cached.request;
                applyDetailData(id, cached);
                    callBackend('get_request_details', { id: id, user: currentUser ? currentUser.name : '', email: currentUser ? currentUser.email : '' })
                    .then(data => {
                        if (data.request) {
                            setCachedDetail(id, data);
                            applyDetailData(id, data);
                        }
                    })
                    .catch(() => {});
                return;
            }

            try {
                let data = await callBackend('get_request_details', { id: id, user: currentUser ? currentUser.name : '', email: currentUser ? currentUser.email : '' }).catch(() => ({}));
                if (data.result !== 'success' || !data.request) {
                    showToast('Failed to load request details', 'error');
                    return;
                }
                const req = data.request;
                if (!req) throw new Error('Request not found');

                currentRequest = req;
                setCachedDetail(id, data);
                applyDetailData(id, data);
            } catch (err) {
                console.error(err);
                showToast('Failed to load details', 'error');
                closeDetails();
            }
        }

        function closeDetails() {
            const modal = document.getElementById('detailsModal');
            const panel = document.getElementById('detailsPanel');
            if (panel) panel.classList.add('translate-x-full');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.add('portal-hidden');
                fetchTabCounts();
            }, 300);
        }

        async function submitThreadNote() {
            const id = document.getElementById('additionalRequestArea').dataset.reqId;
            const note = document.getElementById('threadNoteInput').value;
            if (!note) return;

            showToast('Posting note...', 'info');
            try {
                const data = await callBackend('add_thread_note', { id: id, note: note, role: currentUser.role, user: currentUser.name });
                if (data.result === 'success') {
                    showToast('Note added!', 'success');
                    document.getElementById('threadNoteInput').value = '';
                    viewRequestDetails(id);
                }
            } catch (err) {
                showToast('Error', 'error');
            }
        }

        function renderDispatchView() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üöö Dispatch Management</h2>
                    <div class="space-y-4" id="dispatchViewList">
                        <div class="text-center py-12 text-gray-400 text-sm italic">Scanning for ready goods...</div>
                    </div>
                </div>
            `;
            loadStageRequests('DISPATCH', 'dispatchViewList', false, 'dispatch');
        }

        function closeDetails() {
            const modal = document.getElementById('detailsModal');
            modal.classList.add('portal-hidden');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function submitAddMaterial() {
            const id = document.getElementById('additionalRequestArea').dataset.reqId;
            const category = document.getElementById('addMaterialCategory').value;
            const item = document.getElementById('addMaterialName').value;
            const qty = document.getElementById('addMaterialQty').value;

            if (!item || !qty) return showToast('Please enter item and quantity', 'warning');

            showToast(`Adding ${category.toLowerCase()}...`, 'info');
            try {
                const data = await callBackend('add_material_request', { id: id, category: category, itemName: item, quantity: qty, user: currentUser.name });
                if (data.result === 'success') {
                    showToast(`${category} added successfully!`, 'success');
                    document.getElementById('addMaterialName').value = '';
                    document.getElementById('addMaterialQty').value = '';
                    viewRequestDetails(id); // Reload history and items
                } else {
                    showToast('Failed: ' + (data.error || 'Server error'), 'error');
                }
            } catch (err) {
                showToast('Network failure', 'error');
            }
        }

        function renderPendingApprovals() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚è≥ Pending Approvals</h2>
                    <div class="space-y-4" id="approvalsList">
                        ${getSkeletonListHTML(4)}
                    </div>
                </div>
            `;
            loadPendingApprovals();
        }

        // ==========================================
        // ADMIN / MANAGER CONTROL PORTAL
        // ==========================================
        function renderAdminControl() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in max-w-4xl mx-auto">
                    <div class="mb-8">
                        <h2 class="text-3xl font-black text-gray-800 tracking-tighter">‚öôÔ∏è System Control</h2>
                        <p class="text-gray-500 font-semibold italic">Override statuses, stages, and process flows. Super Admin privileges active.</p>
                    </div>

                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8 space-y-6">
                        <div>
                            <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Lookup Request ID</label>
                            <div class="flex gap-2">
                                <input type="text" id="adminReqLookup" placeholder="e.g. REQ-12345" 
                                    class="flex-1 px-6 py-4 bg-gray-50 border-0 rounded-2xl text-lg font-black outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <button onclick="lookupRequestForAdmin()" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-blue-700 transition-all shadow-lg">SEARCH</button>
                            </div>
                        </div>

                        <div id="adminOverridePanel" class="hidden space-y-8 pt-8 border-t border-dashed">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Status Override</label>
                                    <select id="overrideStatus" class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="PENDING">PENDING (Freshly Submitted)</option>
                                        <option value="APPROVED">APPROVED (Awaiting Issue)</option>
                                        <option value="CORRECTION_REQUIRED">CORRECTION REQUIRED</option>
                                        <option value="ISSUED">ISSUED (In Floor/WIP)</option>
                                        <option value="PRODUCED">PRODUCED (Awaiting Dispatch)</option>
                                        <option value="DISPATCHED">DISPATCHED (Completed)</option>
                                        <option value="CANCELLED">CANCELLED (Refunded/Stopped)</option>
                                        <option value="REJECTED">REJECTED</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Stage / Station Override</label>
                                    <input type="text" id="overrideStage" placeholder="e.g. WIP, Management Approval, etc." 
                                        class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div class="bg-red-50 p-6 rounded-3xl border border-red-100">
                                <h4 class="text-xs font-black text-red-600 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span>‚ö†Ô∏è Danger Zone</span>
                                    <span class="text-[8px] bg-red-100 px-2 py-0.5 rounded">High Privileges</span>
                                </h4>
                                <div class="flex flex-wrap gap-3">
                                    <button onclick="performAdminAction('FORCE_WIP')" class="bg-white text-orange-600 border border-orange-200 px-4 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-orange-50 transition-all">Force WIP (Skip Approvals)</button>
                                    <button onclick="performAdminAction('FORCE_COMPLETE')" class="bg-white text-green-600 border border-green-200 px-4 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-green-50 transition-all">Force Complete (Skip WIP)</button>
                                    <button onclick="performAdminAction('FORCE_REFUND')" class="bg-white text-red-600 border border-red-200 px-4 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-red-50 transition-all">Force Refund (Without Status Change)</button>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button onclick="saveAdminOverride()" class="flex-1 bg-gray-800 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-black transition-all shadow-xl">Apply Global Update</button>
                                <button onclick="viewRequestDetails(document.getElementById('adminReqLookup').value)" class="px-8 bg-gray-100 text-gray-400 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-gray-200 hover:text-gray-600 transition-all">Preview Details</button>
                            </div>
                        </div>

                        <div id="adminLookupError" class="hidden p-4 bg-red-50 text-red-600 rounded-xl text-center font-bold text-xs">
                            Request ID not found. Verify and try again.
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // REQUEST NEW FORMULA (Employee)
        // ==========================================
        function renderRequestNewFormula() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üß™ Request New Formula</h2>
                    <p class="text-gray-500 text-sm mb-6">Ask Admin/Manager to add a formulation to Main Inventory. They will be notified by email.</p>
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 space-y-6">
                        <form onsubmit="submitFormulaRequest(event)" class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Formula basis</label>
                                <select id="formulaBasis" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="1 Litre">For 1 Litre</option>
                                    <option value="1 Kg">For 1 Kg</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Formulation details <span class="text-red-500">*</span></label>
                                <textarea id="formulaDetails" required rows="8" placeholder="Enter ingredients and quantities per the basis above (e.g. Ingredient A: 100 ml, Ingredient B: 50 g...)"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            <div class="flex gap-3">
                                <button type="button" onclick="loadView('my-requests')" class="btn-secondary flex-1">Cancel</button>
                                <button type="submit" class="btn-primary flex-1">Submit Request</button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Your formula requests</h3>
                        <div id="myFormulaRequestsList" class="space-y-3">
                            <div class="text-center py-6 text-gray-400 text-sm">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
            loadMyFormulaRequests();
        }

        async function submitFormulaRequest(e) {
            e.preventDefault();
            const basis = document.getElementById('formulaBasis').value;
            const details = document.getElementById('formulaDetails').value.trim();
            if (!details) return showToast('Enter formulation details', 'warning');
            try {
                const data = await callBackendPost('submit_formula_request', { email: currentUser.email, name: currentUser.name, formulaBasis: basis, formulaDetails: details }).catch(() => ({}));
                if (data.result === 'success') {
                    showToast('Request submitted. Admin/Manager will be notified by email.', 'success');
                    document.getElementById('formulaDetails').value = '';
                    loadMyFormulaRequests();
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            }
        }

        async function loadMyFormulaRequests() {
            const el = document.getElementById('myFormulaRequestsList');
            if (!el) return;
            try {
                const data = await callBackend('get_formula_requests', { email: currentUser.email, role: currentUser.role || 'Employee' }).catch(() => ({}));
                const list = data.requests || [];
                if (list.length === 0) {
                    el.innerHTML = '<p class="text-gray-500 text-sm">No formula requests yet.</p>';
                    return;
                }
                el.innerHTML = list.map(r => `
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <div class="flex justify-between items-start gap-2">
                            <div>
                                <span class="font-mono font-bold text-blue-600">${r.id}</span>
                                <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold ${r.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : r.status === 'Added' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${r.status}</span>
                            </div>
                            <span class="text-xs text-gray-500">${r.formulaBasis || ''}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 line-clamp-2">${(r.formulaDetails || '').replace(/</g, '&lt;')}</p>
                        ${r.resolvedBy ? `<p class="text-xs text-gray-500 mt-2">Resolved by ${r.resolvedBy}${r.notes ? ': ' + r.notes : ''}</p>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                el.innerHTML = '<p class="text-red-500 text-sm">Failed to load.</p>';
            }
        }

        // ==========================================
        // FORMULA REQUESTS (Manager / Admin)
        // ==========================================
        function renderFormulaRequests() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üß™ Formula Requests</h2>
                    <p class="text-gray-500 text-sm mb-6">Employee requests to add formulations to Main Inventory. Resolve after adding the formula in Main Inventory.</p>
                    <div class="flex gap-2 mb-4">
                        <button onclick="loadFormulaRequests('')" class="px-4 py-2 rounded-lg font-semibold text-sm border-2 border-gray-300 hover:border-blue-500">All</button>
                        <button onclick="loadFormulaRequests('Pending')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-yellow-100 text-yellow-800 border-2 border-yellow-300">Pending</button>
                        <button onclick="loadFormulaRequests('Added')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-green-100 text-green-800 border-2 border-green-300">Added</button>
                        <button onclick="loadFormulaRequests('Rejected')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-red-100 text-red-800 border-2 border-red-300">Rejected</button>
                    </div>
                    <div id="formulaRequestsList" class="space-y-4">
                        <div class="text-center py-12 text-gray-400">Loading...</div>
                    </div>
                </div>
            `;
            loadFormulaRequests('Pending');
        }

        async function loadFormulaRequests(statusFilter) {
            const el = document.getElementById('formulaRequestsList');
            if (!el) return;
            el.innerHTML = '<div class="text-center py-8 text-gray-400">Loading...</div>';
            try {
                const params = { email: currentUser.email, role: currentUser.role || '' };
                if (statusFilter) params.status = statusFilter;
                const data = await callBackend('get_formula_requests', params).catch(() => ({}));
                const list = data.requests || [];
                if (list.length === 0) {
                    el.innerHTML = '<p class="text-gray-500 text-center py-8">No formula requests.</p>';
                    return;
                }
                el.innerHTML = list.map(r => `
                    <div class="bg-white rounded-xl border border-gray-200 p-5 shadow-sm">
                        <div class="flex justify-between items-start flex-wrap gap-2 mb-3">
                            <span class="font-mono font-bold text-blue-600">${r.id}</span>
                            <span class="px-2 py-1 rounded text-xs font-bold ${r.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : r.status === 'Added' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${r.status}</span>
                        </div>
                        <p class="text-sm text-gray-600"><strong>${(r.requestedByName || '').replace(/</g, '&lt;')}</strong> (${(r.requestedByEmail || '').replace(/</g, '&lt;')})</p>
                        <p class="text-xs text-gray-500 mt-1">Basis: ${(r.formulaBasis || '').replace(/</g, '&lt;')} ‚Ä¢ ${r.createdDate ? new Date(r.createdDate).toLocaleString() : ''}</p>
                        <div class="mt-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-700 whitespace-pre-wrap">${(r.formulaDetails || '').replace(/</g, '&lt;').replace(/\n/g, '<br>')}</div>
                        ${r.status === 'Pending' ? `
                            <div class="mt-4 flex flex-wrap gap-2 items-end">
                                <input type="text" id="formulaResolveNote-${r.id}" placeholder="Optional note" class="flex-1 min-w-[120px] px-3 py-2 border rounded-lg text-sm">
                                <button onclick="resolveFormulaRequest('${r.id}', 'Added')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm hover:bg-green-700">Mark Added</button>
                                <button onclick="resolveFormulaRequest('${r.id}', 'Rejected')" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold text-sm hover:bg-red-700">Reject</button>
                            </div>
                        ` : ''}
                        ${r.resolvedBy ? `<p class="text-xs text-gray-500 mt-2">Resolved by ${(r.resolvedBy || '').replace(/</g, '&lt;')}${r.notes ? ' ‚Äì ' + (r.notes || '').replace(/</g, '&lt;') : ''}</p>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                el.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load.</p>';
            }
        }

        async function resolveFormulaRequest(id, status) {
            const noteEl = document.getElementById('formulaResolveNote-' + id);
            const notes = noteEl ? noteEl.value.trim() : '';
            try {
                const data = await callBackendPost('update_formula_request_status', { id, status, email: currentUser.email, user: currentUser.name, notes }).catch(() => ({}));
                if (data.result === 'success') {
                    showToast('Request ' + status.toLowerCase() + '. Employee will be notified by email.', 'success');
                    loadFormulaRequests('');
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            }
        }

        async function lookupRequestForAdmin() {
            const id = document.getElementById('adminReqLookup').value.trim();
            if (!id) return showToast('Enter Request ID', 'warning');

            showToast('Searching...', 'info');
            try {
                let data = await callBackend('get_request_details', { id: id, user: currentUser ? currentUser.name : '', email: currentUser ? currentUser.email : '' }).catch(() => ({}));
                if (!data || !data.request) { showToast('Lookup failed', 'error'); return; }
                const req = data.request;

                if (req) {
                    document.getElementById('adminOverridePanel').classList.remove('hidden');
                    document.getElementById('adminLookupError').classList.add('hidden');

                    document.getElementById('overrideStatus').value = req.status.toUpperCase();
                    document.getElementById('overrideStage').value = req.currentStage;
                    showToast('Data Loaded!', 'success');
                } else {
                    document.getElementById('adminOverridePanel').classList.add('hidden');
                    document.getElementById('adminLookupError').classList.remove('hidden');
                }
            } catch (err) {
                showToast('Lookup failed', 'error');
            }
        }

        async function saveAdminOverride() {
            const id = document.getElementById('adminReqLookup').value.trim();
            const status = document.getElementById('overrideStatus').value;
            const stage = document.getElementById('overrideStage').value;

            if (!confirm('This will bypass all system validations. Are you sure you want to force this change?')) return;

            showToast('Overriding...', 'info');
            try {
                const overrideParams = { id, status, stage, user: currentUser.name, email: currentUser.email }; if (currentUser.uid) overrideParams.adminUid = currentUser.uid;
                const data = await callBackendPost('admin_override', overrideParams);

                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('‚úÖ System Override Successful!', 'success');
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            }
        }

        async function performAdminAction(type) {
            const id = document.getElementById('adminReqLookup').value.trim();
            if (!confirm('Confirm HIGH PRIVILEGE action: ' + type + '?')) return;

            showToast('Executing Force Action...', 'info');
            try {
                const forceParams = { id, type, user: currentUser.name, email: currentUser.email }; if (currentUser.uid) forceParams.adminUid = currentUser.uid;
                const data = await callBackendPost('admin_force_action', forceParams);

                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('‚úÖ Action Executed!', 'success');
                    lookupRequestForAdmin(); // Refresh panel
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) {
                showToast('Action failed', 'error');
            }
        }

        async function loadPendingApprovals() {
            await new Promise(r => setTimeout(r, 50));
            const listContainer = document.getElementById('approvalsList');
            if (!listContainer) return;

            try {
                const data = await callBackend('get_pending_approvals', { email: currentUser.email });

                if (data.requests && data.requests.length > 0) {
                    listContainer.innerHTML = data.requests.map(req => {
                        const isCorrection = req.status === 'CORRECTION_REQUIRED';
                        const cardClass = isCorrection
                            ? "bg-white rounded-xl shadow-md border-4 border-orange-500 bg-orange-50 p-4 hover:shadow-lg transition-all cursor-pointer group relative overflow-hidden"
                            : "bg-white rounded-xl shadow-sm border-2 border-gray-100 p-4 hover:shadow-md hover:border-blue-400 transition-all cursor-pointer group relative overflow-hidden";

                        return `
                            <div onclick="viewRequestDetails('${req.id}')" class="${cardClass}">
                                ${isCorrection ? `
                                    <div class="absolute top-0 right-0 bg-orange-600 text-white text-[9px] font-black px-4 py-1.5 rounded-bl-xl uppercase tracking-widest shadow-md z-10">
                                        ‚ö†Ô∏è Correction Required
                                    </div>
                                ` : ''}
                                <div class="flex justify-between items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[8px] font-black bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded uppercase">${req.type}</span>
                                            <span class="text-[8px] font-black bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${req.id}</span>
                                        </div>
                                        ${isCorrection ? `<div class="text-[12px] font-black text-orange-600 mb-1 tracking-tighter uppercase italic">üö® Correction Request</div>` : ''}
                                        <h3 class="font-black text-gray-800 truncate text-base group-hover:text-blue-600 transition-colors leading-tight ${isCorrection ? 'text-orange-900 font-black' : ''}">${req.productName}</h3>
                                        <div class="flex flex-col gap-1 mt-1.5">
                                            <p class="text-[9px] text-gray-400 font-black uppercase">Requester: <span class="text-gray-600">${req.requesterName}</span></p>
                                            ${isCorrection && req.remarks ? `
                                                <div class="mt-2 bg-white/50 p-2 rounded-lg border border-orange-200 shadow-inner">
                                                    <p class="text-[10px] text-orange-700 font-bold leading-tight italic">"${req.remarks}"</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end shrink-0">
                                        <p class="text-xl font-black ${isCorrection ? 'text-orange-600' : 'text-gray-800'} leading-none">${req.quantity}</p>
                                        <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest mt-1">${req.unit || 'Units'}</p>
                                        <div class="mt-4 ${isCorrection ? 'text-orange-600 opacity-100' : 'text-blue-500 opacity-0 group-hover:opacity-100'} transition-all font-black text-[9px] uppercase tracking-tighter">Review Change ${isCorrection ? 'Required' : ''} ‚Üí</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listContainer.innerHTML = `
                        <div class="text-center py-20 bg-white rounded-lg shadow border-2 border-dashed">
                            <div class="text-4xl mb-4">‚ú®</div>
                            <p class="text-gray-500 font-medium text-lg">All caught up! No pending approvals.</p>
                        </div>
                    `;
                }
                const contentArea = document.getElementById('contentArea');
                if (contentArea) setCachedView('pending-approvals', contentArea.innerHTML);
                if (typeof fetchTabCounts === 'function') fetchTabCounts();
            } catch (error) {
                console.error(error);
                showToast('Failed to load approvals', 'error');
            }
        }

        async function handleApprovalAction(ev, id, action) {
            if (typeof id === 'undefined') { id = ev; ev = null; action = arguments[2] || arguments[1]; }
            var key = 'approval_' + id + '_' + action;
            if (window._actionKeys && window._actionKeys[key]) return;
            window._actionKeys = window._actionKeys || {};
            window._actionKeys[key] = true;
            if (ev && ev.target) { if (ev.target.disabled) { delete window._actionKeys[key]; return; } ev.target.disabled = true; }
            let reason = '';
            if (action === 'reject' || action === 'hold' || action === 'hold_plan') {
                const actionText = action === 'reject' ? 'REJECT' : (action === 'hold_plan' ? 'HOLD PLAN' : 'HOLD');
                reason = prompt(`Please provide a reason for ${actionText}:`);
                if (!reason || reason.trim() === '') {
                    showToast('Action cancelled - reason required', 'warning');
                    delete (window._actionKeys || {})[key];
                    if (ev && ev.target) ev.target.disabled = false;
                    return;
                }
            }
            const apiAction = action === 'approve' ? 'approve_request' :
                action === 'approve_partial' ? 'approve_partial_request' :
                action === 'hold' ? 'hold_request' :
                action === 'hold_plan' ? 'hold_plan_request' :
                    'reject_request';
            const displayAction = action === 'approve_partial' ? 'Partial issue' : action === 'hold_plan' ? 'Hold plan' : action.charAt(0).toUpperCase() + action.slice(1);
            showToast(`${displayAction}ing...`, 'info');
            try {
                const params = { id, user: currentUser.name, email: currentUser.email };
                if (reason) params.reason = reason;
                const data = await callBackendPost(apiAction, params);
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast(`Request ${displayAction}ed!`, 'success');
                    closeDetails();
                    if (currentUser.role === 'Manager') loadView('pending-approvals', 'Manager');
                    else refreshCurrentView();
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    if (ev && ev.target) ev.target.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                if (ev && ev.target) ev.target.disabled = false;
            } finally {
                delete (window._actionKeys || {})[key];
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        // Auto-refresh logic
        let currentViewId = 'dashboard';

        function startAutoRefresh() {
            // DISABLED: Auto-refresh was interrupting user input
            // User can manually refresh using the refresh button
            console.log('‚ö†Ô∏è Auto-refresh disabled to prevent input interruption');
            return;

            /* DISABLED CODE:
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                const modal = document.getElementById('detailsModal');
                if (modal.style.display !== 'flex') {
                    console.log('üîÑ Auto-refreshing current portal...');
                    initializePortal(currentUser.role);
                }
            }, 300000); // 5 minutes
            */
        }

        async function refreshCurrentView() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            btn.classList.add('opacity-50', 'pointer-events-none');
            icon.classList.add('animate-spin');

            invalidateViewCache(true);
            showToast('Syncing data...', 'info');
            await initializePortal(currentUser.role);

            setTimeout(() => {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                icon.classList.remove('animate-spin');
                showToast('Synchronized', 'success');
            }, 500);
        }

        window.onload = function () {
            loadConfig();

            // Check if already logged in
            const savedUser = localStorage.getItem('miklens_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    currentUser.role = normalizeRole(currentUser.role); // NORMALIZE ON LOAD
                    showApp();
                    startAutoRefresh();
                } catch (e) {
                    localStorage.removeItem('miklens_user');
                }
            }


            // Attach Settings modal event listeners
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsCloseBtn = document.getElementById('settingsCloseBtn');
            const settingsCancelBtn = document.getElementById('settingsCancelBtn');
            const settingsSaveBtn = document.getElementById('settingsSaveBtn');

            if (settingsBtn) {
                settingsBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log('Settings button clicked');
                    openSettings();
                });
            }
            if (settingsCloseBtn) {
                settingsCloseBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    closeSettings();
                });
            }
            if (settingsCancelBtn) {
                settingsCancelBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    closeSettings();
                });
            }
            if (settingsSaveBtn) {
                settingsSaveBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    saveSettingsUrl();
                });
            }
            const btnTestFirebase = document.getElementById('btnTestFirebase');
            if (btnTestFirebase) {
                btnTestFirebase.addEventListener('click', function (e) {
                    e.stopPropagation();
                    testFirebaseConnection();
                });
            }
        };

        // ==========================================
        // OPERATOR - MASTER ARCHIVE (FOLDER VIEW)
        // ==========================================
        async function renderMasterArchive() {
            const container = document.getElementById('contentArea');
            container.innerHTML = `
                <div class="p-6 fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-gray-800 tracking-tighter">Master Archive</h2>
                            <p class="text-gray-500 font-medium italic">Production Data Folders</p>
                        </div>
                    </div>
                    <div id="archiveContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full py-20 text-center"><div class="animate-spin inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>
                    </div>
                </div>
            `;

            try {
                const data = await callBackend('get_all_requests', {});

                if (data.result === 'success' && data.requests) {
                    const grouped = {};
                    data.requests.forEach(req => {
                        const prod = req.productName || 'General / R&D';
                        if (!grouped[prod]) grouped[prod] = [];
                        grouped[prod].push(req);
                    });

                    const arcContainer = document.getElementById('archiveContainer');
                    if (Object.keys(grouped).length === 0) {
                        arcContainer.innerHTML = '<div class="col-span-full py-12 text-center text-gray-400">No records found.</div>';
                        return;
                    }

                    arcContainer.innerHTML = '';
                    Object.keys(grouped).forEach(prodName => {
                        const reqs = grouped[prodName];
                        const folder = document.createElement('div');
                        folder.className = 'bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-xl transition-all cursor-pointer group';
                        folder.onclick = () => showProductFolderDetails(prodName, reqs);
                        folder.innerHTML = `
                            <div class="flex items-start justify-between mb-4">
                                <div class="bg-blue-50 p-3 rounded-2xl group-hover:bg-blue-600 transition-colors">
                                    <svg class="w-6 h-6 text-blue-600 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                                </div>
                                <span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-1 rounded-full uppercase">${reqs.length} Batches</span>
                            </div>
                            <h3 class="text-xl font-black text-gray-800 mb-1 group-hover:text-blue-600 transition-colors truncate">${prodName}</h3>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Active Data Folder</p>
                            
                            <div class="mt-4 space-y-2 border-t border-gray-50 pt-4">
                                ${reqs.slice(0, 3).map(r => `
                                    <div class="flex justify-between items-center text-[10px]">
                                        <span class="text-gray-500 font-medium">REQ #${r.id}</span>
                                        <span class="font-bold text-gray-800">${r.status}</span>
                                    </div>
                                `).join('')}
                                ${reqs.length > 3 ? `<p class="text-[9px] text-center text-blue-500 font-black mt-2">View ${reqs.length - 3} more ‚Üí</p>` : ''}
                            </div>
                        `;
                        arcContainer.appendChild(folder);
                    });
                }
            } catch (err) {
                console.error(err);
                document.getElementById('archiveContainer').innerHTML = '<div class="col-span-full py-12 text-center text-red-400">Error loading data.</div>';
            }
        }

        function showProductFolderDetails(prodName, reqs) {
            const modal = document.getElementById('detailsModal');
            document.getElementById('detailsTitle').textContent = prodName;
            document.getElementById('detailsStatus').textContent = `Stored in Archive`;

            const historyContainer = document.getElementById('detailsHistory');
            historyContainer.innerHTML = `
                <div class="space-y-4">
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Total Batches: ${reqs.length}</p>
                    ${reqs.map(r => `
                        <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100 hover:border-blue-200 transition-all">
                            <div class="flex justify-between mb-2">
                                <p class="text-[10px] font-black text-blue-600 uppercase">BATCH #${r.id}</p>
                                <p class="text-[10px] font-black text-gray-400 uppercase">${new Date(r.timestamp).toLocaleDateString()}</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm font-bold text-gray-800">${r.requesterName}</p>
                                    <p class="text-[10px] text-gray-500 font-medium">${r.quantity} ${r.unit}</p>
                                </div>
                                <span class="text-[9px] font-black bg-blue-100 px-3 py-1 rounded-full text-blue-700 uppercase">${r.status}</span>
                            </div>
                            <button onclick="viewRequestDetails('${r.id}')" class="mt-4 w-full text-[9px] font-black text-blue-600 hover:text-blue-800 uppercase text-center py-2 border-t border-gray-100">Audit details ‚Üí</button>
                        </div>
                    `).join('')}
                </div>
            `;
            modal.style.display = 'flex';
        }

        async function handleAdminAction(id, action) {
            if (!confirm(`Are you sure you want to ${action === 'APPROVED' ? 'Bypass/Approve' : 'Reject'} this request?`)) return;
            showToast('Executive override...', 'info');
            try {
                const data = await callBackend('approve_request', { id: id, decision: action, role: 'OPERATOR', user: currentUser.name });
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('Bypass successful!', 'success');
                    initializePortal(currentUser.role);
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (err) { showToast('Execution failed', 'error'); }
        }
        async function cancelRequest(ev, id) {
            if (typeof id === 'undefined') { id = ev; ev = null; }
            var key = 'cancel_' + id;
            if (window._actionKeys && window._actionKeys[key]) return;
            window._actionKeys = window._actionKeys || {};
            window._actionKeys[key] = true;
            if (ev && ev.target) { if (ev.target.disabled) { delete window._actionKeys[key]; return; } ev.target.disabled = true; }
            if (!confirm('Are you sure you want to cancel this request? This cannot be undone.')) { delete (window._actionKeys || {})[key]; if (ev && ev.target) ev.target.disabled = false; return; }
            const reason = prompt('Reason for cancellation:');
            if (reason === null) { delete (window._actionKeys || {})[key]; if (ev && ev.target) ev.target.disabled = false; return; }
            showToast('Cancelling request...', 'info');
            try {
                const data = await callBackendPost('wip_action_req', { id, wipAction: 'CANCEL', email: currentUser.email, user: currentUser.name, reason });
                if (data.result === 'success') {
                    invalidateViewCache(true);
                    showToast('Request cancelled', 'success');
                    closeDetails();
                    refreshCurrentView();
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                    if (ev && ev.target) ev.target.disabled = false;
                }
            } catch (e) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
                if (ev && ev.target) ev.target.disabled = false;
            } finally {
                delete (window._actionKeys || {})[key];
            }
        }

        async function editResearchItem(id, itemName, currentQty) {
            const newQty = prompt(`Edit quantity for ${itemName}:`, currentQty);
            if (newQty === null || newQty === currentQty) return;

            showToast('Updating quantity...', 'info');
            try {
                const data = await callBackendPost('edit_request_item', { id, itemName, quantity: newQty, email: currentUser.email, user: currentUser.name });
                if (data.result === 'success') {
                    showToast('Quantity updated', 'success');
                    viewRequestDetails(id); // Reload details
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (e) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            }
        }

        async function deleteResearchItem(id, itemName) {
            if (!confirm(`Remove ${itemName} from this request?`)) return;

            showToast('Removing item...', 'info');
            try {
                const data = await callBackendPost('delete_request_item', { id, itemName, email: currentUser.email, user: currentUser.name });
                if (data.result === 'success') {
                    showToast('Item removed', 'success');
                    viewRequestDetails(id); // Reload details
                } else {
                    showToast(userFriendlyError(data.error), 'error');
                }
            } catch (e) {
                showToast(CRITICAL_ACTION_RETRY_MSG, 'warning');
            }
        }
    </script>
</body>

</html>